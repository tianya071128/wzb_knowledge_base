import{d as h,jG as g,r as V,y as F,c as f,a as p,dW as I,w_ as u,wW as C,yI as b,dX as B,Z as T,yH as k,aN as x,cC as _,o as A,b as O,B as w,yJ as R}from"./index-b80d5ef5.js";const j=h({__name:"FileModePdfFile",props:{file:{},active:{type:Boolean},index:{}},emits:["active"],setup(M,{emit:E}){const l=M,D=E,e=g(),o=V();F([()=>e.fileModeCollapse,o],()=>{var a;(a=o.value)==null||a.setFormSpan(e.fileModeCollapse?24:12)});const r=f(()=>{var a;return e.matchField(((a=e.fileMode)==null?void 0:a.fieldId)??"")}),c=f(()=>{var a;return(a=r.value.field.fields)==null?void 0:a.find(t=>t.type===p.fileEnter)}),d=f(()=>{var a,t;return[I.view,I.pureView].includes(e.mode)||!((a=r.value.field.fields)!=null&&a.some(i=>i.type===p.fileEnter&&e.getFieldAuth(i.fieldId,"show")))||(t=r.value.field.fields)!=null&&t.some(i=>i.type===p.fileDesign&&e.getFieldAuth(i.fieldId,"show"))?u.view:u.edit}),v=f({get(){return C({formData:e.packageNormlData({format:!0}),entryId:e.entryId})},set(a){const t=b(a,v.value);e.batchSetFieldVal(B({entryId:e.entryId,rowData:t}))}}),n=`file_${T()}`;return e.addValidate({id:n,validate(){var a;return(a=o.value)==null?void 0:a.validate()},onError(){e.$bus.emit(k,{active:1})}}),e.addGetFormDataAfter({id:n,async callback({data:a}){var i,y;if(d.value===u.view)return;const t=await((y=o.value)==null?void 0:y.save({fileConfig:c.value?{controlId:c.value.fieldId,entityId:e.entryId,versionType:(i=c.value)==null?void 0:i.options.version}:void 0,beforeFileId:l.file.response,cache:!0,hideTip:!0}));a.forEach(m=>{if(m.fieldId===r.value.fieldId){const s=[...m.value??[]];s[l.index]&&(s[l.index]={...s[l.index],...t},m.value=s)}})},onError(){D("active"),e.fileModeCollapse||x.error("云文档文件保存失败, 请检查!")}}),_(()=>{e.removeValidate(n),e.removeGetFormDataAfter(n)}),F([()=>l.active,d],()=>{l.active&&(e.isBusinessInfo=d.value!==u.view)},{immediate:!0}),(a,t)=>(A(),O(R,{ref_key:"pdfFileEntryOrViewRef",ref:o,formData:v.value,"onUpdate:formData":t[0]||(t[0]=i=>v.value=i),displayMode:"1",fileMode:d.value,file:a.file,hideCustomForm:!a.active||!w(e).fileModeTeleportElement,teleport:w(e).fileModeTeleportElement},null,8,["formData","fileMode","file","hideCustomForm","teleport"]))}});export{j as default};
