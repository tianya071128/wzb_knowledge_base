import{j6 as X,aF as z,j7 as re,d as M,v as te,x as K,r as S,j8 as ie,aG as ue,aH as ce,aI as de,aJ as pe,c as E,o as y,f as L,i as x,B as V,C as ne,aK as fe,p as me,j9 as ve,ja as ee,jb as _e,Z as ge,aL as ye,jc as le,_ as D,k as d,t as W,jd as se,y as oe,J as he,e as R,S as G,F as A,g as H,l as N,Q as be,b as O,w as k,gp as Fe,gq as Ie,bt as we,aC as Ce,a2 as Se,aB as Le,aD as xe,h1 as Te,je as ke,ao as $e,m as j,ax as Be,z as U,L as Ee,a1 as Ve,N as Me,O as Oe,eh as De,a9 as Pe,i1 as je,jf as Ae}from"./index-b80d5ef5.js";import{c as He,a as Re,b as Ge,s as Ne}from"./index-8e050109.js";function We(F,u){if(!u)return[];const p=new RegExp(u.map(a=>`${a.name}${a.suffix?a.suffix.replace(/[\\^$.*+?()[\]{}|]/g,"\\$&"):""}`).join("|"),"g"),r=[];let i;for(;(i=p.exec(F))!==null;){const a=u.find(s=>`${s.name}${s.suffix??""}`===(i==null?void 0:i[0]));a&&r.push({start:i.index,end:i.index+a.name.length,matchItem:a})}return r}function Ue(F){const u=new Map,p=new Map;let r=0;const i=F.value.map(a=>{const s=typeof a=="string"?{name:a}:a;if(s.color||(s.color="#c643e0"),!u.has(s.color)){const b=`cm-underline${r++}`;u.set(s.color,b),p.set(s.color,X.mark({class:b}))}return s});return[z.baseTheme([...u.entries()].reduce((a,s)=>({...a,[`.${s[1]}`]:{color:s[0]}}),{})),re.define({create(){return X.none},update(a,s){a=a.update({filter(){return!1}});const b=s.newDoc.toString(),g=We(b,i);return a=a.update({add:g.map(h=>p.get(h.matchItem.color??"").range(h.start,h.end))}),a},provide:a=>z.decorations.from(a)})]}const ze=M({__name:"CodeWrapper",props:{modelValue:{},fnList:{},group:{},preview:{type:Boolean}},emits:["update:modelValue"],setup(F,{expose:u,emit:p}){const r=F,i=p,a=function(o){var c;const l=o.matchBefore(/\w*/);return!l||l.from==l.to&&!o.explicit?null:{from:l.from,options:((c=r.fnList)==null?void 0:c.map(v=>Ne(`${v.name}(#{1})`,{label:v.name,detail:v.label})))??[]}},s=te(r,"modelValue",i),b=K(),g=S(),h=S(),m=async o=>{var e;const{domId:l,contentId:_,groupItem:c}=o,v=await ye({contentId:_,dataSystem:b,groupItem:c});if(v){const n=(e=g.value)==null?void 0:e.querySelector(`#${l}`);if(n){n.classList.add(v.isError?"field-widget-remove":"field-widget");let t=c.hideTitleBeInput||v.isError?"":await le(c,{dataSystem:b});t=t?`${t}.`:"",n.innerText=t+v.label}}},f=[{format:o=>{const{contentId:l,groupItem:_}=ee(o,r.group),c=`field-${ge()}`;return _?(m({text:o,domId:c,groupItem:_,contentId:l}),{dom:`<span id="${c}"></span>`}):""},regexp:ve(),validate(o){const{groupItem:l}=ee(o,r.group);if(!l)return!1}}],w=[z.lineWrapping,ie(_e,{fallback:!0}),ue(),He(),ce(),de.of([...Re,...pe]),Ge({override:[a],closeOnBlur:!1,tooltipClass(){return"az-code-tooltip"},icons:!1}),Ue(E(()=>(r.fnList??[]).map(o=>({name:o.name,suffix:"("}))))];return u({addFn(o){var l;(l=h.value)==null||l.insert(`${o}()`,_=>_-1)},addField(o){var l;(l=h.value)==null||l.insert(`$${o}$`)},cursorPosition:E(()=>{var o;return(o=h.value)==null?void 0:o.cursorPosition})}),(o,l)=>(y(),L("div",{class:me(["formula-code",{"is-preview":o.preview}]),ref_key:"CodeWrapperRef",ref:g},[x(V(fe),{modelValue:V(s),"onUpdate:modelValue":l[0]||(l[0]=_=>ne(s)?s.value=_:null),ref_key:"CodeEditorRef",ref:h,style:{width:"100%",height:"100%"},widgetOptions:f,customBasicSetup:w,preview:o.preview},null,8,["modelValue","preview"])],2))}});const Ke=D(ze,[["__scopeId","data-v-3f39575f"]]),qe=M({__name:"FnItem",props:{data:{},search:{}},setup(F){const u=F,p=E(()=>{var i;if(!u.search)return u.data.name;const r=u.search.toLocaleUpperCase();return(i=u.data.name)==null?void 0:i.split(r).join(`<span class="prominent">${r}</span>`)});return(r,i)=>(y(),L("div",{class:"fn-item"},[d("span",{class:"fn-name",innerHTML:p.value},null,8,["innerHTML"]),d("span",{class:"fn-label"},W(r.data.label),1)]))}});const ae=D(qe,[["__scopeId","data-v-c04d5427"]]),Je=M({__name:"FnCardPane",props:{mode:{},scenes:{}},emits:["hoverFnChange","select"],setup(F,{emit:u}){var m;const p=F,r=u,i=E(()=>se(p.mode,p.scenes)),a=S((m=i.value[0])==null?void 0:m.label),s=S();oe(s,()=>{r("hoverFnChange",s.value)},{immediate:!0});const b=I=>{r("select",I)},g=S(""),h=E(()=>g.value.trim()?i.value.reduce((I,f)=>[...I,...f.list.filter(w=>w.name.toLocaleLowerCase().includes(g.value.trim().toLocaleLowerCase()))],[]):null);return(I,f)=>{var _;const w=be,o=Fe,l=Ie;return y(),L("div",{class:"formula-fn"},[x(w,{modelValue:g.value,"onUpdate:modelValue":f[0]||(f[0]=c=>g.value=c),class:"formula-search",placeholder:"搜索函数","prefix-icon":V(he),clearable:""},null,8,["modelValue","prefix-icon"]),d("div",{class:"fn-container"},[R(d("ul",{class:"fn-search-list"},[(y(!0),L(A,null,H(h.value,c=>(y(),L("li",{key:c.name,onClick:v=>b(c),onMouseenter:v=>s.value=c},[x(ae,{data:c,search:g.value.trim()},null,8,["data","search"])],40,["onClick","onMouseenter"]))),128)),(_=h.value)!=null&&_.length?N("",!0):(y(),L("li",{key:0,class:"fn-search-empty"}," 没有对应的函数 "))],512),[[G,h.value]]),R(d("div",null,[(y(!0),L(A,null,H(i.value,(c,v)=>(y(),O(l,{key:v,class:"fn-collapse",modelValue:a.value,"onUpdate:modelValue":f[1]||(f[1]=e=>a.value=e)},{default:k(()=>[x(o,{name:c.label},{title:k(()=>[d("span",{class:"fn-category-label"},W(c.label),1)]),default:k(()=>[d("ul",null,[(y(!0),L(A,null,H(c.list,e=>(y(),L("li",{key:e.name,onClick:n=>b(e),onMouseenter:n=>s.value=e},[x(ae,{data:e,search:g.value.trim()},null,8,["data","search"])],40,["onClick","onMouseenter"]))),128))])]),_:2},1032,["name"])]),_:2},1032,["modelValue"]))),128))],512),[[G,!h.value]])])])}}});const Qe=D(Je,[["__scopeId","data-v-57b3281c"]]),Ye=M({__name:"FnFieldPane",props:{mode:{},filter:{type:Function},isSubform:{type:Boolean},group:{}},emits:["select"],setup(F,{emit:u}){const p=F,r=u,i=S(p.group[0]),a=K(),s=async()=>await Promise.all(p.group.map(async I=>{const f=I.id;return{label:await le(I,{dataSystem:a}),value:f}})),b=m=>{i.value=p.group.find(I=>I.id===m)},g=m=>(Te(p.filter)&&(m=p.filter(m)),ke(m,{isSubform:p.isSubform})),h=(m,I)=>{var l;let f="";const w=(l=i.value)==null?void 0:l.id;w&&(f=w+"."),f+=m.fieldId;const o=[];r("select",f+`${o.length?"&&"+o.join(";"):""}`)};return(m,I)=>{var w,o,l,_,c,v,e;const f=$e;return y(),L("div",{class:"field-pane"},[m.group.length>1?(y(),L("div",{key:0,class:"formula-entry"},[x(we,{"model-value":(w=i.value)==null?void 0:w.id,"onUpdate:modelValue":b,load:s},{default:k(({options:n})=>[(y(!0),L(A,null,H(n,t=>(y(),O(f,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["model-value"])])):N("",!0),i.value?(y(),O(xe,{key:1,class:"az-flex-height",onClickField:h,entryId:(l=(o=i.value)==null?void 0:o.fieldOptions)==null?void 0:l.entryId,fields:(c=(_=i.value)==null?void 0:_.fieldOptions)==null?void 0:c.fields,aggregateId:(e=(v=i.value)==null?void 0:v.fieldOptions)==null?void 0:e.aggregateId,filter:g,"is-select":!1},{append:k(({field:n})=>[d("span",{class:"formula-field-type",style:Se(V(Le)(n))},W(V(Ce)(n)),5)]),_:1},8,["entryId","fields","aggregateId"])):N("",!0)])}}});const Ze=D(Ye,[["__scopeId","data-v-2a287eb3"]]),Xe=M({__name:"FnTip",props:{data:{}},setup(F){return(u,p)=>{var r,i,a,s;return y(),L("div",{class:"fn-tip"},[R(d("ul",{class:"fn-tip-empty"},[d("li",null,"从左侧面板选择字段和函数，或输入函数"),d("li",null,[j(" 函数编辑举例： "),d("span",{class:"prominent"},"ADD"),j(" (1, "),d("span",{class:"field-tip"},"基本工资"),j(" , "),d("span",{class:"field-tip"},"绩效工资"),j(" ) ")])],512),[[G,!u.data]]),R(d("ul",{class:"fn-tip-data"},[d("li",{class:"fn-tip-name prominent"},W((r=u.data)==null?void 0:r.name),1),d("li",{innerHTML:(i=u.data)==null?void 0:i.role,class:"mb-5"},null,8,["innerHTML"]),d("li",{innerHTML:(a=u.data)==null?void 0:a.usage,"data-title":"用法："},null,8,["innerHTML"]),d("li",{innerHTML:(s=u.data)==null?void 0:s.example,"data-title":"示例："},null,8,["innerHTML"])],512),[[G,u.data]])])}}});const ea=D(Xe,[["__scopeId","data-v-6227a501"]]),la=M({__name:"Formula",props:{modelValue:{},mode:{default:Be.client},filter:{},isSubform:{type:Boolean,default:!0},group:{},scenes:{}},emits:["update:modelValue"],setup(F,{expose:u,emit:p}){const r=F,a=te(r,"modelValue",p),s=K(),b=S();oe(()=>r.group,(e,n)=>{var t;Pe(e,n)||(t=b.value)==null||t.reload()});const g=S([]),h=async()=>{var n;const e=await Promise.all(((n=r.group)==null?void 0:n.map(async t=>{var P;const T=((P=t.fieldOptions)==null?void 0:P.sourceId)??"";if(t.sourceTransformEntry&&T){const B=await s.getSoureceData(T);return(B==null?void 0:B.forms.map(C=>{var $;return{id:C.entryId,hideTitleBeInput:t.hideTitleBeInput,title:C.name,fieldOptions:{fields:C.fields,isSubformId:($=t.fieldOptions)==null?void 0:$.isSubformId}}}))??[]}return t.fieldByAppOptions?(await s.getForm(t.fieldByAppOptions.appId)).filter(C=>C.type===Ve.form).sort(C=>{var $;return C.id===(($=t.fieldByAppOptions)==null?void 0:$.currentEntryId)?-1:1}).map(C=>{var q,J,Q,Y,Z;const $=(J=(q=t.fieldByAppOptions)==null?void 0:q.fieldMap)==null?void 0:J[C.id];return{id:C.id,hideTitleBeInput:((Q=t.fieldByAppOptions)==null?void 0:Q.currentEntryId)===C.id,title:((Y=t.fieldByAppOptions)==null?void 0:Y.currentEntryId)===C.id?"当前表单":C.name,fieldOptions:{fields:$,entryId:$?void 0:C.id,isSubformId:(Z=t.fieldOptions)==null?void 0:Z.isSubformId}}}):t}))??[]);g.value=e.flat()},m=S(),I=e=>{v.value=void 0,m.value=e},f=S(),w=e=>{var n;(n=f.value)==null||n.addFn(e.name)},o=e=>{var n;(n=f.value)==null||n.addField(e)},l=S("");U(async()=>{l.value=await je(a.value??"",{dataSystem:s,group:g.value,mode:r.mode})??""});const _=S(new Set),c=E(()=>{const e=new Set;return se(r.mode,r.scenes).reduce((n,t)=>[...n,...t.list],[]).filter(n=>e.has(n.name)?!1:(e.add(n.name),!0))});U(()=>{_.value.clear();try{Ae.parseScript(a.value??"",{loc:!0,range:!0},e=>{if(e.type==="CallExpression"&&e.callee.type==="Identifier"){const n=e.callee.name;let t;(t=c.value.find(T=>T.name===n))&&e.range&&_.value.add({fnItem:t,range:e.range})}})}catch{}});const v=S();return U(()=>{var n,t;const e=(n=f.value)==null?void 0:n.cursorPosition;e&&(m.value=void 0,v.value=(t=[..._.value].find(T=>T.range[0]<=e&&T.range[1]>=e))==null?void 0:t.fnItem)}),u({validate(){if(l.value)return Promise.reject(l.value)},resetFntip(){m.value=void 0,v.value=void 0}}),(e,n)=>{const t=Me,T=Oe,P=De;return y(),O(Ee,{load:h,class:"formula-container",ref_key:"loadingDataRef",ref:b},{default:k(()=>[x(T,{class:"formula-tabs",type:"border-card",tabPosition:"left"},{default:k(()=>[x(t,{label:"函数"},{default:k(()=>[x(Qe,{class:"formula-pane",mode:e.mode,scenes:e.scenes,onHoverFnChange:I,onSelect:w},null,8,["mode","scenes"])]),_:1}),x(t,{label:"字段"},{default:k(()=>[x(Ze,{class:"formula-pane",mode:e.mode,filter:e.filter,isSubform:e.isSubform,group:g.value,onSelect:o},null,8,["mode","filter","isSubform","group"])]),_:1})]),_:1}),d("div",{class:"formula-right"},[d("div",{class:"formula-code"},[x(Ke,{modelValue:V(a),"onUpdate:modelValue":n[0]||(n[0]=B=>ne(a)?a.value=B:null),group:g.value,fnList:c.value,ref_key:"CodeWrapperRef",ref:f},null,8,["modelValue","group","fnList"])]),l.value?(y(),O(P,{key:0,title:l.value,type:"error",closable:!1},null,8,["title"])):N("",!0),d("div",{class:"formula-tip"},[x(ea,{data:m.value??v.value},null,8,["data"])])])]),_:1},512)}}});export{la as _,Ue as h};
