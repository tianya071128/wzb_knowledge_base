import{r as i,y as k,m7 as P,d as R,v as T,c as b,dW as N,d8 as L,o as g,b as B,w as I,i as D,L as M,f as z,F as J,k as V,B as h,ib as U,l as C,p as W,m as w,C as q,bv as O,m8 as j,m9 as G,ma as H,mb as K,aN as E,aa as Q,m4 as S,mc as X,U as Y,_ as Z}from"./index-b80d5ef5.js";const ee=v=>{let f=[];return function(u){f=u.map(t=>{let e={};return t.cols.forEach(n=>{e[`${t.entryId}-${n.fieldId}`]=n.value,n.childs&&(e[`${t.entryId}-${n.fieldId}`]=n.childs.map(c=>{const y={};return c.map(m=>{y[`${n.fieldId}-${m.fieldId}`]=m.value}),y}))}),e={...t,...e},e})}(v),f};function le(v){const f=i(10),a=i(1),u=i(0),t=i([]),e=i(),n=i(!1),c=async(y=!0)=>{y&&(a.value=1),n.value=!0;try{if(v.entryId){const m=await P({entryId:v.entryId,current:a.value,limit:f.value});u.value=+m.total,t.value=m.records,e.value=ee(t.value)}else u.value=0,t.value=[],e.value=[]}finally{n.value=!1}};return k([f],()=>{c()}),k([a],()=>{c(!1)}),{getData:c,limit:f,current:a,total:u,tableData:t,formartTableData:e,loading:n}}const ae=R({__name:"EditDraft",props:{modelValue:{type:Boolean},entryId:{},draftId:{},formData:{},btnPosition:{default:"center"}},emits:["update:modelValue","refresh"],setup(v,{emit:f}){const a=v,u=f,t=T(a,"modelValue",u),e=i(),n=b(()=>{var l;return((l=e.value)==null?void 0:l.appId)??""}),c=i(),y=async()=>{e.value=await j(a.entryId)};k(()=>[a.draftId,a.entryId],()=>{var l;(l=c.value)==null||l.reload()});const m=b(()=>{var d,s;const l={mode:N.enter,useDefault:!0,formData:a.formData,appId:n.value,entryId:a.entryId??""};return(d=e.value)!=null&&d.formAuth?{...l,fieldAuth:{auth:((s=e.value)==null?void 0:s.formAuth)??{},authDefault:{readable:!1,writeable:!1},isRequire:!0}}:{...l}}),r=i(null);b(()=>L.value.userInfo.orgInfoList??[]);const _=i(),x=async()=>{var l,d,s;r.value=1;try{await((l=_.value)==null?void 0:l.validate());const o=await((d=_.value)==null?void 0:d.getFormDataPromise());if(!Array.isArray(o)||!o.length)return;const p=await G({appId:n.value,entryId:a.entryId,formData:o,dataId:""});await H({appId:n.value,entryId:a.entryId,formId:((s=e.value)==null?void 0:s.id)??"",creatorDept:p==null?void 0:p.creatorDept,flowId:p==null?void 0:p.flowId,save:K(o,a.entryId??"")}),t.value=!1,F(),E.success("提交成功！"),u("refresh")}finally{r.value=null}},$=()=>{Q.confirm("您确定要删除该条数据吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}).then(async()=>{r.value=3;try{await F(),E.success("删除成功")}finally{r.value=null}})},F=async()=>{await S(a.draftId),t.value=!1,u("refresh")},A=async()=>{var l,d;r.value=2;try{const s=await((l=_.value)==null?void 0:l.getFormDataPromise());s&&(s.forEach(o=>{o.type==="subform"&&(o.value=null)}),await X({id:a.draftId,entryId:a.entryId,formId:((d=e.value)==null?void 0:d.id)??"",cols:s}),t.value=!1,u("refresh"),E.success("保存成功！"))}finally{r.value=null}};return(l,d)=>{const s=Y;return g(),B(O,{modelValue:h(t),"onUpdate:modelValue":d[0]||(d[0]=o=>q(t)?t.value=o:null),title:"编辑草稿箱",size:"85%",direction:"btt",class:"edi_draft"},{default:I(()=>[D(M,{class:"form_enter",ref_key:"loadingDataRef",ref:c,load:y},{default:I(()=>{var o;return[(o=e.value)!=null&&o.formJson.fields.length?(g(),z(J,{key:0},[V("div",{class:"form_entry-form"},[e.value&&h(t)?(g(),B(h(U),{key:0,"form-designer":e.value.formJson,options:m.value,ref_key:"formRenderRef",ref:_},null,8,["form-designer","options"])):C("",!0)]),V("div",{class:W(["form_entry-btns",[l.btnPosition&&`btn-position-${l.btnPosition}`]])},[D(s,{onClick:x,type:"primary",loading:r.value===1,disabled:!!(r.value&&r.value!==1)},{default:I(()=>[w(" 提交 ")]),_:1},8,["loading","disabled"]),D(s,{onClick:A,loading:r.value===2,disabled:!!(r.value&&r.value!==2)},{default:I(()=>[w(" 暂存 ")]),_:1},8,["loading","disabled"]),D(s,{onClick:$,type:"danger",loading:r.value===3,disabled:!!(r.value&&r.value!==3)},{default:I(()=>[w(" 删除 ")]),_:1},8,["loading","disabled"])],2)],64)):C("",!0)]}),_:1},512)]),_:1},8,["modelValue"])}}});const re=Z(ae,[["__scopeId","data-v-09e1ed6b"]]);export{re as E,ee as d,le as u};
