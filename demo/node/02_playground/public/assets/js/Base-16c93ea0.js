import{es as W,V as Z,Z as G,bK as J,ia as N,nv as k,nw as O,ha as L,h9 as R,nx as j,a as c,ny as C,nz as P,nA as A,g2 as Y,b_ as Q,cA as X,cC as ee,Y as b,a8 as ie,nB as le,hc as de,d8 as se,nC as te,h5 as re,kv as z,y as S,z as H,nD as fe,gY as ne,jG as ae,x as ce,r as E,c as w,dW as T,dS as oe,fx as ue,d$ as me,en as he,n as pe,a9 as K,aT as Fe,nE as V,d as ye,o as M,b as $,w as Ie,B as x,ib as Be,L as ge,_ as ve}from"./index-b80d5ef5.js";import{_ as be}from"./Base.vue_vue_type_script_setup_true_lang-832ddae3.js";function q(t,d=[]){const l=W(d).map(s=>s.fieldId),i=Z(t)?t.type:t;let e;for(;l.includes(e="_"+i.replace(/-/g,"_")+"_"+G()););return e}function n(t,d){const l=b(t);return typeof d=="boolean"&&(d={rewrite:d}),(!l.fieldId||d!=null&&d.rewrite)&&(l.fieldId=q(t,[...(d==null?void 0:d.fields)??[],...(d==null?void 0:d.recycleBinFields)??[]])),d!=null&&d.parentField&&(d==null?void 0:d.parentField.type)===c.uploadFile&&[c.fileEdit,c.fileDesign,c.fileEnter,c.fileView].includes(l.type)&&"fileSource"in l.options&&(l.options.fileSource=d.parentField.fieldId),l}function xe(t){const d=J({id:`form_${G()}`,appId:t.appId,entryId:t.entryId,sourceId:t.sourceId??"",trigger:1,form:{formConfig:N(),fields:[]},selectedField:null,selectedFieldId:null,hoverFieldId:null,hoverFieldIds:[],initField(l){const i=n(l,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)});return i.__init__=!0,i.type==="grid"?i.fields=[n(k,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)}),n(k,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)})]:i.type==="tabs"?i.fields=[{...n(O,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)})},{...n(O,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)})}]:i.type==="table"?i.fields=[{...n(L,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)}),fields:[n(R,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)}),n(R,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)})]},{...n(L,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)}),fields:[n(R,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)}),n(R,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)})]}]:i.type==="subform"?i.fields=[{...n(j,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)})},{...n(j,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)})}]:i.type===c.steps?(i.fields=[{...n(C,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)})},{...n(C,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)})},{...n(C,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)})}],i.fields.forEach((e,s)=>{e.options.label=`步骤${P.cn.encodeS(s+1)}`})):i.type===c.stepsTwo&&(i.fields=[{...n(A,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)})},{...n(A,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)})},{...n(A,{fields:this.form.fields,recycleBinFields:this.recycleBin.fields.map(e=>e.field)})}],i.fields.forEach((e,s)=>{e.options.label=`步骤${P.cn.encodeS(s+1)}`})),i},setSelectedField(l){if(!l){this.clearSelectedField();return}this.selectedFieldId=l.fieldId,this.selectedField=l},clearSelectedField(){this.selectedFieldId=null,this.selectedField=null},deleteField(l){const i=this.matchField(l.fieldId);if(i===null)return;const{fieldIndex:e,parentField:s,parentFields:r}=i;r.splice(e,1),setTimeout(()=>{if(this.matchField(this.selectedFieldId))return;const a=r[e]||r[e-1];s===null?this.setSelectedField(a):this.setSelectedField(a||s)},0)},matchField(l){return Y(l,this.form.fields)},checkSonField(l){var i,e;return l?((e=(i=this.matchField(l))==null?void 0:i.parentField)==null?void 0:e.type)===c.subform:!1},copyField(l){const i=this.matchField(l.fieldId),e=this;if(i===null)return;const s=new Map,{parentFields:r,fieldIndex:a}=i,u=n(l,{rewrite:!0,fields:e.form.fields,recycleBinFields:this.recycleBin.fields.map(g=>g.field)});s.set(u.type,(s.get(u.type)??0)+1),function g(F){if("fields"in F&&Array.isArray(F.fields)){const y=[];for(const m of F.fields){const _=Q(m.type,"max")??1/0;if((s.get(m.type)??0)+e.getFieldTypeNum(m.type)>=_)continue;const f=n(m,{rewrite:!0,fields:e.form.fields,recycleBinFields:e.recycleBin.fields.map(o=>o.field),parentField:F});y.push(f),g(f)}F.fields=y}}(u),r.splice(a+1,0,u),this.setSelectedField(u)},handleHover(l,i){var e;if(i==="enter")this.hoverFieldId=l,this.hoverFieldIds.push(this.hoverFieldId);else{const s=this.hoverFieldIds.indexOf(l);s>-1&&this.hoverFieldIds.splice(s,1),this.hoverFieldId=((e=this.hoverFieldIds)==null?void 0:e[this.hoverFieldIds.length-1])??null}},clear(){this.form.fields=[],this.setSelectedField()},$bus:X(),$on(l,i){this.$bus.on(l,i),ee(()=>{this.$bus.off(l,i)})},fields:new Map,totalFields:[],getFieldsByFieldId(l){const{fieldId:i,excludeCrrentField:e}=l??{};if(!i)return b(this.form.fields);const s=this.matchField(i);if(!s)return b(this.form.fields);const r=s.parentField;return ie(b(l!=null&&l.isSystemField?this.totalFields:this.form.fields),{excludeFilter(a){return e&&a.fieldId===i?!0:a.type===c.subform&&(r==null?void 0:r.fieldId)===a.fieldId?(a.fields.forEach(u=>{u.options.label=`${a.options.label}.${u.options.label}`}),!0):!1}})},getFieldTypeNum(l){return[...this.fields.values()].filter(i=>i.type===l).length},getFormFieldSpan(){return this.form.formConfig.fieldSpan??24},setAllFieldSpan(l){const i=[...this.form.fields];let e=i.shift();for(;e;)le.includes(e.type)||(e.options.span=l),!de.includes(e.type)&&"fields"in e&&i.push(...e.fields),e=i.shift()},recycleBin:{fields:[]},addRecycleBinField(l){var e,s;if(!l)return;const i=b(l.field);"fields"in i&&(i.fields=[]),this.recycleBin.fields.push({fieldId:i.fieldId,parentId:(e=l.parentField)==null?void 0:e.fieldId,parentType:(s=l.parentField)==null?void 0:s.type,deleteMember:se.value.userInfo.userId??"",deleteTime:Date.now(),type:i.type,field:i,children:[]}),this.recycleBin.fields,this.recycleBin.fields.length>100&&this.recycleBin.fields.splice(0,this.recycleBin.fields.length-100)},getFormulaGroup(l){return[{id:"",fieldByAppOptions:{appId:this.appId,currentEntryId:this.entryId,fieldMap:{[this.entryId]:this.getFieldsByFieldId({excludeCrrentField:!0,fieldId:l})}}}]},scrollToField(l){const i=this.matchField(l);i&&(this.$bus.emit(te,{fields:i.matched,fieldId:l,fieldIds:i.matched.map(e=>e.fieldId)}),this.setSelectedField(i.field))},getFieldShowMode(l){var e;const i=this.matchField(l);return((e=i==null?void 0:i.parentField)==null?void 0:e.type)===c.subform&&(i==null?void 0:i.parentField.options.mode)!==re.card?z.narrow:z.convention},fillFieldIdMap:new Map});return S(()=>t,()=>{var l;d.appId=t.appId,d.entryId=t.entryId,d.sourceId=t.sourceId??"",t.formDesigner&&(d.recycleBin=t.formDesigner.recycleBin??{fields:[]},d.form=b(t.formDesigner),d.selectedFieldId&&d.setSelectedField((l=d.matchField(d.selectedFieldId))==null?void 0:l.field))},{immediate:!0}),H(()=>{d.fields=new Map(W(d.form.fields).map(l=>[l.fieldId,l])),d.totalFields=[...d.form.fields,...t.formDesigner.systemFields??[]]}),H(()=>{const l=new Map;function i(e,s){const r=l.get(e)??[];r.push(s),l.set(e,r)}d.fields.forEach(e=>{const s=e.fieldId;if(e.type===c.linkData){for(const r of e.options.fillFields)if(i(r.fieldId,s),Array.isArray(r.child))for(const a of r.child)i(a.fieldId,s)}if(e.type===c.plugin){for(const r of e.options.returnParams)if(i(r.fieldId,s),Array.isArray(r.child))for(const a of r.child)i(a.fieldId,s)}}),d.fillFieldIdMap=l}),S(()=>fe(d.form.fields),(l,i)=>{((i==null?void 0:i.filter(s=>!l.some(r=>r.field.fieldId===s.field.fieldId)&&![c.tableRow,c.tableCell,c.table].includes(s.field.type)))??[]).reverse().forEach(s=>d.addRecycleBinField(s))}),d}function _e(t,d){const l=ne(),i=ae(),e=ce(),s=E(),r=w(()=>{var f;return q(c.subform,((f=s.value)==null?void 0:f.fields)??[])}),a=w(()=>{var o;return{appId:t.isRender?i.appId:l.appId,entryId:((o=s.value)==null?void 0:o.entryId)??"",mode:(i==null?void 0:i.mode)??T.edit,formData:(i==null?void 0:i.mode)===T.pureView||(i==null?void 0:i.mode)===T.view?{[r.value]:v(t.modelValue)}:void 0}}),u=w(()=>{var h;const f=((h=s.value)==null?void 0:h.fields)??[],o={...t.field,type:c.subform,fieldId:r.value,options:{...t.field.options,required:!1,showLabel:!1,show:!0,tip:""},fields:t.field.options.sonFields.map(I=>{const D=Y(oe(I.fieldId).fieldId,f);if(!D)return null;const p=b(D.field);return p.options.label=I.alias??p.options.label,p.options.show=!0,p.options.edit=!0,p.options.alwaysHide=void 0,p.options.subformWidth=I.width?`${I.width}px`:p.options.subformWidth,p}).filter(I=>!!I)};return{formConfig:{...N()},fields:[o]}}),g=async()=>{if(!t.field.options.sourceId)return;const f=await e.getSoureceData(t.field.options.sourceId);s.value=f==null?void 0:f.forms[0]},F=E();S(()=>t.field.options.sourceId,()=>{var f;return(f=F.value)==null?void 0:f.reload()});const y=E(),m=w(()=>{var f;return(f=y.value)==null?void 0:f.render}),_=w(()=>{var f,o,B;return(((B=(o=(f=y.value)==null?void 0:f.getFormData())==null?void 0:o[0])==null?void 0:B.childs)??[]).map(h=>{var p;const I=(p=h[0])==null?void 0:p.id,D=h.map(U=>ue(U,["id"]));return I&&D.push({fieldId:me,type:he.id.type,value:I}),D})}),v=f=>pe(f).map(o=>o.reduce((B,h)=>({[h.fieldId]:h.value,...B}),{}));if(S([()=>t.modelValue,m],()=>{m.value&&!K(v(t.modelValue),v(_.value))&&m.value.setFieldVal(r.value,v(t.modelValue))},{immediate:!0}),S(_,()=>{Fe(()=>{m.value&&!K(v(t.modelValue),v(_.value))&&d("update:modelValue",_.value)})}),t.isRender){const f=w(()=>!!i.getFieldAuth(t.field.fieldId,"edit"));S([f,y],()=>{var o,B,h;y.value&&((o=m.value)==null||o.setFieldAuth(r.value,"edit",V.external,f.value),(B=m.value)==null||B.setFieldAuth(r.value,"addRecord",V.external,f.value),(h=m.value)==null||h.setFieldAuth(r.value,"deleteRecord",V.external,f.value))},{immediate:!0})}return{formRenderRef:y,handleLoad:g,formDesigner:u,renderOptions:a,loadingDataRef:F}}const we=ye({__name:"Base",props:{modelValue:{},field:{},isRender:{type:Boolean}},emits:["update:modelValue"],setup(t,{expose:d,emit:l}){const i=t,e=l,{formRenderRef:s,handleLoad:r,formDesigner:a,renderOptions:u,loadingDataRef:g}=_e(i,e);return d({formRenderRef:s}),(F,y)=>(M(),$(ge,{load:x(r),ref_key:"loadingDataRef",ref:g},{default:Ie(()=>[F.isRender?(M(),$(x(Be),{key:0,class:"link_subform-base","form-designer":x(a),ref_key:"formRenderRef",ref:s,options:x(u)},null,8,["form-designer","options"])):(M(),$(be,{key:1,data:[],field:x(a).fields[0]},null,8,["field"]))]),_:1},8,["load"]))}});const Re=ve(we,[["__scopeId","data-v-64f28479"]]);export{Re as B,xe as a,n as c};
