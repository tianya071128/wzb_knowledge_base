import{d as E,v as j,r as m,c as S,dW as H,o as p,b as D,w as g,B as i,ib as K,l as $,C as B,bv as X,ii as oe,x as ue,dS as de,d$ as ie,dX as pe,e1 as G,en as ce,eo as fe,a as me,uV as ye,uW as he,k as ve,i as f,f as R,F as C,g as Q,N as Y,O as Z,p7 as M,p as A,t as P,m as _e,ew as Ie,ex as De,_ as be,bi as ee,bs as z,uX as ae,as as te,p9 as ge,uY as Ve,uZ as ke,p5 as we,fo as xe,aN as q,e9 as Se,L as Te}from"./index-b80d5ef5.js";import{s as Re,g as $e,a as Ee,b as Fe,m as Ne,c as ze,e as Ae,f as Pe}from"./dataShare-2d7ae3f7.js";import{k as Be}from"./keyBy-8fcfdd74.js";import{D as Ce,O as Me,a as Le}from"./usePublicRelease-2335b254.js";import{F as Ue}from"./FormShare-9773b44c.js";import{u as Oe}from"./useExtractQuery-f96f705c.js";import"./_createAggregator-d66ed64c.js";const le=E({__name:"FormDetailDrawer",props:{modelValue:{type:Boolean},row:{}},emits:["update:modelValue"],setup(V,{emit:h}){const o=V,u=j(o,"modelValue",h),r=m(),t=m(),l=async()=>{var e;t.value=await Re(o.row.id,o.row.sign),r.value=await oe((e=t.value)==null?void 0:e.entryId)},d=S(()=>{var n,c,I;const e=Be((n=t.value)==null?void 0:n.formFields,"fieldId");return{appId:((c=t.value)==null?void 0:c.appId)??"",entryId:((I=t.value)==null?void 0:I.entryId)??"",fieldAuth:{auth:e,authDefault:{readable:!1}},mode:H.pureView}});return(e,s)=>(p(),D(X,{modelValue:i(u),"onUpdate:modelValue":s[0]||(s[0]=n=>B(u)?u.value=n:null),title:e.row.shareData,"show-load":l,direction:"btt",size:"90%"},{default:g(()=>{var n,c;return[(n=i(r))!=null&&n.formJson&&i(t)?(p(),D(i(K),{key:0,"form-designer":(c=i(r))==null?void 0:c.formJson,ref:"formRenderRef",options:i(d)},null,8,["form-designer","options"])):$("",!0)]}),_:1},8,["modelValue","title"]))}}),se=E({__name:"DataDetailDrawer",props:{modelValue:{type:Boolean},row:{},shareId:{}},emits:["update:modelValue"],setup(V,{emit:h}){const o=V,u=j(o,"modelValue",h),r=S(()=>JSON.parse(o.row.shareJson)),t=ue(),l=m(null),d=m(),e=m(),s=S(()=>{var y;return((y=r.value)==null?void 0:y.dataIds)??[]}),n=async()=>{var y,v,F;l.value=await t.getSoureceData(r.value.sourceId),d.value=await $e({daSourceSelect:{joins:((v=(y=l.value)==null?void 0:y.result)==null?void 0:v.showJson)??[],tableNames:((F=l.value)==null?void 0:F.entryIds.map(T=>T.entryId))??[]},query:s.value??[],viewId:r.value.viewId??"",shareId:o.shareId}),e.value=await Ee({entryId:r.value.entryId,shareId:o.shareId,viewId:r.value.viewId})},c=S(()=>{var T;const y=((T=l.value)==null?void 0:T.forms)??[],v=new Set;return y.map(a=>{var L,U,O,W;const x={fieldAuth:{auth:{},authDefault:{readable:!0,writeable:!1,download:!0},needValFields:[]},mode:H.view,formData:{},downloadFile:!0,appId:(a==null?void 0:a.appId)??"",entryId:a.entryId};for(const _ of((L=e.value)==null?void 0:L.columnAuth)??[])_.entryId===a.entryId&&(U=x.fieldAuth)!=null&&U.auth&&(x.fieldAuth.auth[de(_.fieldId).fieldId]={readable:_.readable??!0,writeable:!1,download:_.download??!0});return a.fields.every(_=>{var k,w;return _.fieldId===ie||((w=(k=x.fieldAuth)==null?void 0:k.auth[_.fieldId])==null?void 0:w.readable)===!1})&&v.add(a.entryId),(O=d.value)!=null&&O[a.entryId]&&(x.formData=pe({entryId:a.entryId,rowData:(W=d.value)==null?void 0:W[a.entryId]})),{entryId:a.entryId,dataId:G({fieldId:a.entryId+"-"+ce.id.name,rowData:d.value??{},entryId:a.entryId}),formId:(a==null?void 0:a.formId)??"",formName:(a==null?void 0:a.name)??"",formDesigner:a==null?void 0:a.formDesigner,options:x,systemFields:(a==null?void 0:a.fields.filter(_=>{var k,w,J;return _.source===fe.system&&_.type!==me.linkData&&((J=(w=(k=e.value)==null?void 0:k.columnAuth)==null?void 0:w.find(ne=>ne.fieldId===`${a.entryId}${ye}${_.fieldId}`))==null?void 0:J.readable)!==!1}).map(_=>{var k,w;return{field:_,value:((w=(k=d.value)==null?void 0:k[a.entryId])==null?void 0:w[`${a.entryId}${he}${_.fieldId}`])??null}}))??[]}}).filter(a=>!v.delete(a.entryId))}),I=m(0),N=S(()=>{var y;return(y=c.value)==null?void 0:y[I.value]});return(y,v)=>{const F=Y,T=Z;return p(),D(X,{modelValue:i(u),"onUpdate:modelValue":v[1]||(v[1]=a=>B(u)?u.value=a:null),"destroy-on-close":"",title:"详情",size:"90%","append-to-body":"",direction:"btt",showLoad:n,class:"table-details",ref:"AzDrawerRef"},{header:g(()=>[ve("div",{class:"az_flex"},[f(T,{modelValue:i(I),"onUpdate:modelValue":v[0]||(v[0]=a=>B(I)?I.value=a:null),class:"az_tabs-custom table-tabs",style:{flex:"1"}},{default:g(()=>[(p(!0),R(C,null,Q(i(c),(a,x)=>(p(),D(F,{key:a.entryId,label:a.formName,name:x},null,8,["label","name"]))),128))]),_:1},8,["modelValue"])])]),default:g(()=>{var a;return[(a=i(N))!=null&&a.formDesigner?(p(),D(i(K),{key:0,class:"form-body","form-designer":i(N).formDesigner,options:i(N).options},null,8,["form-designer","options"])):$("",!0)]}),_:1},8,["modelValue"])}}});const We=E({__name:"ParseShareData",props:{row:{},clickAble:{type:Boolean}},emits:["view"],setup(V,{emit:h}){const o=V,b=h,u=S(()=>o.row?JSON.parse(o.row.shareData):null),r=S(()=>o.row.shareType==M.data),t=()=>{b("view")};return(l,d)=>{var e;return i(r)?(p(),R(C,{key:0},[l.row.formDataTitle?(p(),R("div",{key:0,class:A({"primary-text":!!l.clickAble}),onClick:t},P(l.row.formDataTitle),3)):(p(!0),R(C,{key:1},Q((e=i(u))==null?void 0:e.fields,s=>{var n;return p(),R("span",{key:s.fieldId,class:A(["field_wrapper",{"primary-text":!!l.clickAble}]),onClick:t},[_e(P((n=s==null?void 0:s.options)==null?void 0:n.label)+"： ",1),f(De,{emptyText:"-",mode:i(Ie).list,content:i(G)({entryId:s.entryId,fieldId:s.fieldId,rowData:i(u).formData}),field:s,bubble:""},null,8,["mode","content","field"])],2)}),128))],64)):(p(),R("span",{key:1,class:A({"primary-text":!!l.clickAble}),onClick:t},P(l.row.shareData),3))}}});const re=be(We,[["__scopeId","data-v-f94624d3"]]),Je=E({__name:"ShareWithMe",setup(V,{expose:h}){const o=m(),b={query:{list:[{type:"input",label:"分享表单/数据",prop:"shareData"},{type:"timerange",label:"分享时间",prop:["startTime","endTime"]}]},request:{api:Fe},table:{tableCols:[{prop:"shareData",label:"分享表单/数据",minWidth:"100",showOverflowTooltip:!0,slots:{default({row:l}){return f(re,{row:l},null)}}},{prop:"shareType",label:"分享类型",slots:{default({row:l}){return f("span",null,[z(l.shareType+"",ae)])}}},{prop:"shareUserName",label:"分享人"},{prop:"shareTime",label:"分享时间"},{fixed:"right",width:100,label:"操作",slots:{default({row:l}){return f(te,{list:[{id:"view",text:"查看",type:"primary",onClick:()=>{l.shareType==M.data?(r.value=l,t.value=!0):(r.value=l,u.value=!0)}}]},null)}}}]}},u=m(!1),r=m(),t=m(!1);return h({openDataDetail:l=>{r.value=l,t.value=!0}}),(l,d)=>{const e=ee("az-page");return p(),D(e,{ref_key:"azPageRef",ref:o,config:b,maxHeight:"var(--az-layout-main-height) - 32px"},{operation:g(()=>[r.value?(p(),D(le,{key:0,modelValue:u.value,"onUpdate:modelValue":d[0]||(d[0]=s=>u.value=s),row:r.value},null,8,["modelValue","row"])):$("",!0),r.value?(p(),D(se,{key:1,modelValue:t.value,"onUpdate:modelValue":d[1]||(d[1]=s=>t.value=s),row:r.value,shareId:r.value.shareId??r.value.id},null,8,["modelValue","row","shareId"])):$("",!0)]),_:1},512)}}}),qe=E({__name:"MyShare",setup(V){const h=m(),o=m(),b={query:{list:[{type:"input",label:"分享表单/数据",prop:"shareData"},{type:"timerange",label:"分享时间",prop:["startTime","endTime"]}]},request:{api:Ne},table:{tableCols:[{prop:"shareData",label:"分享表单/数据",minWidth:"100",showOverflowTooltip:!0,slots:{default({row:e}){return f(re,{row:e,onView:()=>{e.shareType==M.data?(t.value=e,l.value=!0):(t.value=e,r.value=!0)},clickAble:!0},null)}}},{prop:"shareType",label:"分享类型",slots:{default({row:e}){return f("span",null,[z(e.shareType+"",ae)])}}},{prop:"shareRange",label:"分享范围",slots:{default({row:e}){return f("span",null,[z(e.shareRange+"",ge)])}}},{prop:"effectiveTime",label:"有效期",slots:{default({row:e}){return f("span",null,[(()=>{switch(e==null?void 0:e.expiraDateSelect){case Le:return"永久有效";case Me:return"一次性链接";case Ce:return`${e==null?void 0:e.expiraStartDate}-${e==null?void 0:e.expiraEndDate}`;default:return e!=null&&e.expiraEndDate?`至${e==null?void 0:e.expiraEndDate}`:"-"}})()])}}},{prop:"createTime",label:"分享时间"},{prop:"status",label:"状态",slots:{default({row:e}){return f("span",null,[z(e.status+"",Ve)])}}},{fixed:"right",width:230,label:"操作",slots:{default({row:e}){const s={id:"copyLink",text:"复制链接",type:"primary",onClick:()=>{const y=()=>{let v=`#/sharePage?shareId=${e==null?void 0:e.id}&sign=${e==null?void 0:e.sign}`;return v=Se.join(location.host,location.pathname,v),`${location.protocol}//${v}`};xe(`名称：${e.shareData}
链接地址：${y()}`)}},n={id:"delete",text:"删除",type:"danger",popconfirmProps:{title:"删除后，数据不可恢复，且有效的链接不可再访问，确定要删除？",confirm:async()=>{await ze(e.id),q.success("删除成功"),u()}}},c={id:"endShare",text:"结束分享",type:"danger",popconfirmProps:{title:"结束分享后，该链接不可再访问，确定要结束？",confirm:async()=>{await Ae(e.id),q.success("已结束分享"),u()}}},I={id:"view",text:"查看",type:"primary",onClick:()=>{var y;t.value=e,(y=o.value)==null||y.open(d())}};return f(te,{list:(()=>e.status==ke.yes?e.shareRange==we.designee?[I,n]:[s,c,n]:[n])(),num:3},null)}}}]}};function u(){var e;(e=h.value)==null||e.refresh()}const r=m(!1),t=m(),l=m(!1),d=()=>{var s,n,c,I;return{isSendMsg:((s=t.value)==null?void 0:s.isSendMsg)+"",shareRange:((n=t.value)==null?void 0:n.shareRange)+"",shareType:((c=t.value)==null?void 0:c.shareType)+"",shareStaff:(I=t.value)==null?void 0:I.shareStaff,shareData:""}};return(e,s)=>{const n=ee("az-page");return p(),D(n,{ref_key:"azPageRef",ref:h,config:b,maxHeight:"var(--az-layout-main-height) - 32px"},{operation:g(()=>[t.value?(p(),D(le,{key:0,modelValue:r.value,"onUpdate:modelValue":s[0]||(s[0]=c=>r.value=c),row:t.value},null,8,["modelValue","row"])):$("",!0),t.value?(p(),D(se,{key:1,modelValue:l.value,"onUpdate:modelValue":s[1]||(s[1]=c=>l.value=c),row:t.value,shareId:t.value.id},null,8,["modelValue","row","shareId"])):$("",!0),f(Ue,{readonly:"",ref_key:"formShareRef",ref:o},null,512)]),_:1},512)}}}),Ze=E({__name:"routePage",setup(V){const h=m("1"),o=Oe("id"),b=m(),u=async()=>{if(o.value){h.value="1";const r=await Pe(o.value);setTimeout(()=>{var t;(t=b.value)==null||t.openDataDetail(r)})}};return(r,t)=>{const l=Y,d=Z;return p(),D(Te,{class:"layout_box",load:u},{default:g(()=>[f(d,{modelValue:h.value,"onUpdate:modelValue":t[0]||(t[0]=e=>h.value=e)},{default:g(()=>[f(l,{label:"分享给我",name:"1"},{default:g(()=>[f(Je,{ref_key:"shareWithMeRef",ref:b},null,512)]),_:1}),f(l,{label:"我分享的",name:"2"},{default:g(()=>[f(qe)]),_:1})]),_:1},8,["modelValue"])]),_:1})}}});export{Ze as default};
