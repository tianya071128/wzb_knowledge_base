import{d as E,wU as y,r as m,c as I,wO as g,bx as N,cC as x,y as D,o as b,b as k,w as L,k as R,L as V,wN as A,a$ as W,yK as B,d8 as h,yL as O,yM as P,yN as U,yO as j,wV as M,aN as S,yP as z,_ as $,jG as G,dW as T,a as C,wT as w,Z as H,yH as J}from"./index-b80d5ef5.js";const K=E({__name:"WordFile",props:{file:{},fileMode:{default:y.read}},setup(F,{expose:_}){const d=F,p=m(),l=I(()=>g(d.file.type??"")),f=m(""),u=m(""),n=m(),s=m(!1),c=async()=>{s.value=!1;const e=await A({fileName:d.file.name,fileSource:"5",fileFormat:l.value,fileUrl:d.file.url});if(f.value=e.fileId,!f.value)return Promise.reject({msg:"数据异常!",loadState:W.fail});const i=await B({openMode:d.fileMode,userId:h.value.userInfo.userId??"",userName:h.value.userInfo.nickname,fileType:l.value,fileId:e.fileId});u.value=i.url},a=e=>{var i;e.source===((i=n.value)==null?void 0:i.contentWindow)&&JSON.parse(e.data).type===O.onDocumentStateChange&&(s.value=!0)};N(()=>{window.addEventListener("message",a)}),x(()=>{window.removeEventListener("message",a)});const t=async e=>{var r;let i=(r=e==null?void 0:e.fileConfig)==null?void 0:r.versionType;return i===M.movement&&(i=await z()),i},o=async e=>{if(e!=null&&e.isCheckChange&&!s.value)return;if(d.fileMode===y.read)return Promise.reject("查看模式无需保存");const i=await t(e),r=await P({fileId:f.value});if(r.url){const v={name:r.fileName,url:r.url,size:+r.fileSize,response:r.id+"",type:U(r.fileType)};return e!=null&&e.fileConfig&&e.beforeFileId&&(await j({entityId:e==null?void 0:e.fileConfig.entityId,controlId:e==null?void 0:e.fileConfig.controlId,fileId:v.response,filePath:v.url,fileType:g(v.type).toUpperCase(),historyFlag:i===M.auto?"0":"1",fileSize:v.size+"",fileName:v.name,beforeFileId:e.beforeFileId}),e.hideTip||S.success("保存历史版本成功")),v}else return Promise.reject("保存接口返回数据异常")};return D([()=>d.file.response,()=>d.fileMode],()=>{var e;s.value=!1,(e=p.value)==null||e.reload()}),_({async validate(){},save:o}),(e,i)=>(b(),k(V,{class:"word_file",ref_key:"loadingDataRef",ref:p,load:c},{default:L(()=>[R("iframe",{ref_key:"iframeRef",ref:n,src:u.value,frameborder:"0",height:"100%",name:"fileIframe",allowfullscreen:"",allow:"camera *;autoplay *;microphone *",width:"100%"},null,8,["src"])]),_:1},512))}});const Z=$(K,[["__scopeId","data-v-281fdf2c"]]),Q=E({__name:"FileModeWordFile",props:{file:{},active:{type:Boolean},index:{}},emits:["active"],setup(F,{emit:_}){const d=F,p=_,l=G(),f=m(),u=I(()=>{var a;return l.matchField(((a=l.fileMode)==null?void 0:a.fieldId)??"")}),n=I(()=>{var t,o;if([T.view,T.pureView].includes(l.mode))return null;let a=(t=u.value.field.fields)==null?void 0:t.find(e=>e.type===C.fileEdit&&e.options.mode===w.edit&&l.getFieldAuth(e.fieldId,"show"));return a||(a=(o=u.value.field.fields)==null?void 0:o.find(e=>e.type===C.fileEdit&&e.options.mode===w.editAndTrace&&l.getFieldAuth(e.fieldId,"show")),a)?a:null}),s=I(()=>{var a,t;return((a=n.value)==null?void 0:a.options.mode)===w.edit?y.edit:((t=n.value)==null?void 0:t.options.mode)===w.editAndTrace?y.editAndTrace:y.read}),c=`file_${H()}`;return l.addValidate({id:c,validate(){var a;return(a=f.value)==null?void 0:a.validate()},onError(){l.$bus.emit(J,{active:1})}}),l.addGetFormDataAfter({id:c,async callback({data:a}){var o,e;if(s.value===y.read)return;const t=await((e=f.value)==null?void 0:e.save({fileConfig:n.value?{controlId:n.value.fieldId,entityId:l.entryId,versionType:(o=n.value)==null?void 0:o.options.version}:void 0,beforeFileId:d.file.response,hideTip:!0,isCheckChange:!0}));t&&a.forEach(i=>{if(i.fieldId===u.value.fieldId){const r=[...i.value??[]];r[d.index]&&(r[d.index]={...r[d.index],...t},i.value=r)}})},onError(){p("active"),l.fileModeCollapse||S.error("云文档文件保存失败, 请检查!")}}),x(()=>{l.removeValidate(c),l.removeGetFormDataAfter(c)}),(a,t)=>(b(),k(Z,{ref_key:"wordFileRef",ref:f,file:a.file,fileMode:s.value},null,8,["file","fileMode"]))}});export{Q as default};
