import{d as T,v as ne,r as f,o as m,b as y,w as o,i as t,f as F,F as J,g as Q,m as L,l as D,bu as ve,B as s,C as z,bv as be,bw as ye,ac as ge,ao as Ie,ap as we,U as B,bm as he,_ as P,c as R,bx as Ce,k as g,t as $,bi as oe,L as ke,by as re,bn as Se,h as ee,j as ae,bz as j,bA as De,bB as Te,bC as Ve,bD as xe,b4 as K,bE as W,av as Y,bF as Le,aN as N,a4 as Ee,bG as ue,y as ce,bH as ie,I as M,a5 as Oe,bh as Fe,N as Re,O as $e}from"./index-b80d5ef5.js";import{D as h,F as X}from"./flowEnum-7431041b.js";import{g as te,c as Be,l as Pe,f as ze,a as Me,b as Ue,d as G,e as qe,h as Ae,i as Ne,j as je,k as He,u as Ge}from"./dataFactory-e27a5721.js";import{u as Z}from"./useExtractQuery-f96f705c.js";const Je=T({__name:"updateRuleSetting",props:{visible:{type:Boolean}},emits:["update:visible","success"],setup(n,{emit:c}){const a=n,r=c,e=ne(a,"visible",r),u=f(),l=f({...{updateStartTime:"",updateEndTime:"",updateCycle:1}}),d={updateStartTime:[{required:!0,message:"请选择数据源类型",trigger:"change"}]},w=[{label:"每小时更新一次",value:1},{label:"每天更新一次",value:2},{label:"每周更新一次",value:3},{label:"每月更新一次",value:4},{label:"每季度更新一次",value:5},{label:"每年更新一次",value:6},{label:"自定义",value:7}],C=async()=>{},k=async()=>{var v;await((v=u.value)==null?void 0:v.validate())&&r("success")};return(V,v)=>{const E=ye,i=ge,p=Ie,I=we,S=B,x=he;return m(),y(be,{modelValue:s(e),"onUpdate:modelValue":v[4]||(v[4]=b=>z(e)?e.value=b:null),title:"数据更新规则","show-load":C},{default:o(()=>[t(x,{"label-suffix":":","label-width":"120px",rules:d,model:l.value,class:"updata-rule-form",ref_key:"formRef",ref:u},{default:o(()=>[t(i,{label:"更新开始时间",prop:"updateStartTime"},{default:o(()=>[t(E,{modelValue:l.value.updateStartTime,"onUpdate:modelValue":v[0]||(v[0]=b=>l.value.updateStartTime=b),type:"datetime",placeholder:"选择日期"},null,8,["modelValue"])]),_:1}),t(i,{label:"更新结束时间",prop:"updateEndTime"},{default:o(()=>[t(E,{modelValue:l.value.updateEndTime,"onUpdate:modelValue":v[1]||(v[1]=b=>l.value.updateEndTime=b),type:"datetime",placeholder:"选择日期"},null,8,["modelValue"])]),_:1}),t(i,{label:"更新周期",prop:"updateCycle"},{default:o(()=>[t(I,{modelValue:l.value.updateCycle,"onUpdate:modelValue":v[2]||(v[2]=b=>l.value.updateCycle=b),placeholder:"请选择",filterable:"",clearable:""},{default:o(()=>[(m(),F(J,null,Q(w,({label:b,value:O})=>t(p,{label:b,value:O,key:O},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),l.value.updateCycle===7?(m(),y(i,{key:0},{default:o(()=>[t(S,{type:"primary",text:""},{default:o(()=>[L("设置周期")]),_:1})]),_:1})):D("",!0)]),_:1},8,["model"]),t(ve,{editMode:!0,onClose:v[3]||(v[3]=b=>e.value=!1),"on-submit":k})]),_:1},8,["modelValue"])}}});const Qe=P(Je,[["__scopeId","data-v-ad060a20"]]);var de=(n=>(n.add="add",n.edit="edit",n))(de||{}),U=(n=>(n[n.deactivated=1]="deactivated",n[n.enable=0]="enable",n))(U||{});const Ke=()=>{const n=[{label:"已发布",value:U.enable+""},{label:"未发布",value:U.deactivated+""}],c=f(),a=f(),r=f(),e=f(!1),u=f(h.flow),_=f(!1),l=Z("appId"),d=f(""),w=f(!1),C=f(de.add),k=()=>{var i,p;(i=a.value)==null||i.refresh(),(p=r.value)==null||p.refresh()},V=R(()=>({query:{list:[{type:"input",label:"名称",prop:"name"},{type:"select",label:"发布状态",prop:"status",options:n,extraOptions:[{label:"全部",value:""}],isAll:!0},{type:"select",label:"运行状态",prop:"status",options:n,extraOptions:[{label:"全部",value:""}],isAll:!0}]},id:"lowCode_factory_now",request:{api:te,extraParams:{type:h.flow,appId:l.value}},table:{tableCols:[]},operation:{fullEl:c}})),v=i=>{d.value=i.id,w.value=!0},E=R(()=>({query:{list:[{type:"input",label:"名称",prop:"name"},{type:"select",label:"状态",prop:"status",options:n,extraOptions:[{label:"全部",value:""}],isAll:!0}]},id:"lowcode_factory_batch",request:{api:te,extraParams:{type:h.batch,appId:l.value}},table:{tableCols:[]},operation:{fullEl:c}}));return{appId:l,activeTab:u,flowConfig:V,batchConfig:E,DataDealMode:h,pendingRef:c,azPageRef:a,azPageRefFlow:r,dialogType:C,updateRuleVisible:_,dataConnectionVisible:e,isViewLog:w,itemId:d,handleViewLog:v,refreshTable:k}},We=Ke,Xe=T({__name:"Statistics",props:{appId:{}},setup(n,{expose:c}){const a=n,r=f(0),e=f(0),u=f(0),_=async()=>{if(a.appId){const l=await Be(a.appId);r.value=l.running??0,e.value=l.success??0,u.value=l.defeated??0}};return Ce(()=>{_()}),c({refresh:async()=>{await _()}}),(l,d)=>(m(),F("div",{class:"statistics-wrapper"},[g("span",null,"当前任务运行数："+$(r.value),1),g("span",null,"当前任务停止运行数："+$(e.value),1),g("span",null,"今日异常任务数："+$(u.value),1)]))}});const le=P(Xe,[["__scopeId","data-v-5295236b"]]),Ye=T({__name:"ViewLog",props:{visible:{type:Boolean},dataId:{},active:{}},emits:["update:visible"],setup(n,{emit:c}){const a=n,e=ne(a,"visible",c),u=f(),_=[{label:"手动更新",value:"0"},{label:"定时更新",value:"1"}],l=[{label:"成功",value:0,type:"success"},{label:"运行中",value:2,type:"warning"},{label:"失败",value:1,type:"danger"}],d=i=>{var p;return(p=_.find(I=>I.value===i.toString()))==null?void 0:p.label},w=R(()=>{const i={tableCols:[{prop:"startTime",label:"开始时间",showOverflowTooltip:!0},{prop:"endTime",label:"结束时间",showOverflowTooltip:!0},{prop:"updateDuration",label:"更新时长",slots:{default({row:I}){return t("span",null,[I.updateDuration,L("s")])}}},{prop:"updateType",label:"更新方式",slots:{default({row:I}){return t("span",null,[d(I.updateType)])}}},{prop:"operateUser",label:"操作人",showOverflowTooltip:!0},{prop:"result",label:"结果",slots:{default({row:I}){const S=l.find(x=>x.value.toString()===I.result.toString());return t(re,{type:S==null?void 0:S.type},{default:()=>[S==null?void 0:S.label]})}}},{prop:"result",label:"失败原因",slots:{default({row:I}){return I.result===1?t(B,{onclick:()=>V(I),type:"primary",plain:!0,size:"small"},{default:()=>[L("查看原因")]}):t("span",null,null)}}}]},p={list:[{type:"timerange",label:"开始时间",prop:["startTime","endTime"]},{type:"select",label:"更新方式",prop:"updateType",isAll:!0,options:_},{type:"select",label:"结果",prop:"result",isAll:!0,options:l}]};return a.active===h.batch?{query:{list:[p.list[0],p.list[2]]},id:"lowcode_flow_log",request:{api:Pe,extraParams:{dataStreamId:a.dataId}},table:i,operation:{fullEl:u}}:{query:p,id:"lowcode_flow_log",request:{api:ze,extraParams:{dataStreamId:a.dataId}},table:i,operation:{fullEl:u}}}),C=f(!1),k=f(""),V=i=>{k.value=i.instanceId,C.value=!0},v=f(),E=async()=>{if(a.active===h.batch){const i=await Me({instanceId:k.value});v.value=i}else{const i=await Ue({instanceId:k.value});v.value=i}};return(i,p)=>{const I=oe("az-page"),S=Se;return m(),y(S,{modelValue:s(e),"onUpdate:modelValue":p[1]||(p[1]=x=>z(e)?e.value=x:null),title:"查看日志",width:"1200"},{default:o(()=>[t(I,{ref_key:"azPageRef",ref:u,config:s(w)},null,8,["config"]),t(S,{modelValue:C.value,"onUpdate:modelValue":p[0]||(p[0]=x=>C.value=x),width:"800",title:"查看原因","append-to-body":""},{default:o(()=>[t(ke,{load:E},{default:o(()=>[g("div",{innerHTML:v.value},null,8,["innerHTML"])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])}}}),q=n=>n===U.deactivated,A=n=>n===U.enable,Ze=T({__name:"DataCard",props:{cardItem:{}},setup(n){const c=n,a=R(()=>c.cardItem),r={[G.form]:"formCircleFill",[G.dataModeling]:"dataModelCircleFill",[G.dataConnection]:"mysql"},e=R(()=>a.value.outputCellsInfo?r[a.value.outputCellsInfo.dataSources]:""),u=R(()=>{var d;return(d=a.value.inputCellsList)!=null&&d.length?r[a.value.inputCellsList[0].dataSources]:""}),_=R(()=>{var d;return(d=a.value.inputCellsList)!=null&&d.length?a.value.inputCellsList[0].cellsName:"输入表"}),l=R(()=>a.value.outputCellsInfo?a.value.outputCellsInfo.cellsName:"输出表");return(d,w)=>{const C=re,k=De,V=Te,v=Ve;return m(),y(v,{class:"card-cell"},{footer:o(()=>[g("footer",{class:"card-footer"},[ee(d.$slots,"footerBar",{},void 0,!0)])]),default:o(()=>[g("header",{class:"card-header"},[g("div",{class:"card-header-left"},[g("div",{class:"title"},[t(ae,{class:"w100",style:{padding:"2px 0"},content:s(a).name},null,8,["content"])]),g("div",{class:"status"},[s(A)(s(a).status)?(m(),y(C,{key:0,type:"success"},{default:o(()=>[L(" 已发布 ")]),_:1})):D("",!0),s(q)(s(a).status)?(m(),y(C,{key:1,type:"info"},{default:o(()=>[L(" 待发布 ")]),_:1})):D("",!0)])]),g("div",null,[ee(d.$slots,"headBar",{},void 0,!0)])]),g("section",{class:"description"},[t(ae,{class:"w100",content:s(a).description||"暂无描述"},null,8,["content"])]),t(V,{justify:"center",align:"middle"},{default:o(()=>[t(k,{span:11},{default:o(()=>[g("div",{class:"data-table"},[t(j,{"icon-class":s(u)},null,8,["icon-class"]),g("div",{class:"mt-5"},$(s(_)),1)])]),_:1}),t(k,{span:2},{default:o(()=>[t(j,{"icon-class":"rightArrow",class:"fs-20 rightArrow"})]),_:1}),t(k,{span:11},{default:o(()=>[g("div",{class:"data-table"},[t(j,{"icon-class":s(e)},null,8,["icon-class"]),g("div",{class:"mt-5"},$(s(l)),1)])]),_:1})]),_:1})]),_:3})}}});const pe=P(Ze,[["__scopeId","data-v-772a0850"]]),me=T({__name:"DataEdit",props:{mode:{},cardItem:{}},setup(n){const c=n,a=Z("appId"),r=()=>{c.mode===h.batch?K(W,{replace:!0,query:{dataDealMode:h.batch,flowMode:X.designer,appId:a.value,dataStreamId:c.cardItem.id}}):K(W,{replace:!0,query:{dataDealMode:h.flow,flowMode:X.designer,appId:a.value,dataStreamId:c.cardItem.id}})};return(e,u)=>{const _=Y;return m(),y(_,{title:"编辑",icon:s(xe),onClick:r,underline:!1,class:"mr-10 fs-16"},null,8,["icon"])}}}),fe=T({__name:"DataCopy",props:{cardItem:{}},emits:["refresh"],setup(n,{emit:c}){const a=n,r=c,e=f(!1),u=async()=>{e.value=!0;try{await qe({dataStreamId:a.cardItem.id}),N.success("复制成功"),r("refresh")}finally{e.value=!1}};return(_,l)=>{const d=B;return m(),y(d,{loading:e.value,title:"复制",underline:!1,link:"",icon:s(Le),class:"mr-10 fs-16",onClick:u},null,8,["loading","icon"])}}}),_e=T({__name:"DataDelete",props:{cardItem:{}},emits:["refresh"],setup(n,{emit:c}){const a=n,r=c,e=async()=>{await Ae(a.cardItem.id),N.success("删除成功"),r("refresh")};return(u,_)=>{const l=Y;return m(),y(ue,{title:"确定要删除该数据吗?",confirm:e},{reference:o(()=>[t(l,{title:"删除",underline:!1,icon:s(Ee),class:"fs-16"},null,8,["icon"])]),_:1})}}}),ea=T({__name:"DataOffline",props:{cardItem:{}},emits:["refresh"],setup(n,{emit:c}){const a=n,r=c,e=async()=>{await Ne(a.cardItem.id),N.success("下线成功"),r("refresh")};return(u,_)=>{const l=Y;return s(A)(u.cardItem.status)?(m(),y(ue,{key:0,title:"确定要下线吗?",confirm:e},{reference:o(()=>[t(l,{title:"下线",underline:!1,class:"mr-10"},{icon:o(()=>[t(j,{"icon-class":"offLine",class:"offline fs-20 el-icon"})]),_:1})]),_:1})):D("",!0)}}}),aa=T({__name:"BatchDataCard",props:{cardItem:{}},emits:["onOpenLog"],setup(n,{emit:c}){const a=n,r=c,e=f(a.cardItem);ce(()=>a.cardItem,()=>{e.value=ie(a.cardItem)});const u=f(!1),_=async()=>{try{u.value=!0;const l=await je({dataStreamId:e.value.id});e.value=l,N.success("更新数据成功!")}finally{u.value=!1}};return(l,d)=>{const w=B;return m(),y(pe,{cardItem:e.value},{headBar:o(()=>[g("div",null,[s(q)(l.cardItem.status)?(m(),y(me,{key:0,"card-item":e.value,mode:s(h).batch},null,8,["card-item","mode"])):D("",!0),t(fe,M(l.$attrs,{"card-item":e.value}),null,16,["card-item"]),s(q)(l.cardItem.status)?(m(),y(_e,M({key:1},l.$attrs,{"card-item":e.value}),null,16,["card-item"])):D("",!0),t(ea,M(l.$attrs,{"card-item":e.value}),null,16,["card-item"])])]),footerBar:o(()=>[g("section",null,[s(A)(e.value.status)?(m(),F("span",{key:0}," 上次运行时间："+$(e.value.lastOperationTime||"-"),1)):D("",!0)]),s(A)(e.value.status)?(m(),y(w,{key:0,onClick:_,type:"success",class:"ml-10",loading:u.value,text:""},{default:o(()=>[L(" 更新数据 ")]),_:1},8,["loading"])):D("",!0),t(w,{onClick:d[0]||(d[0]=C=>r("onOpenLog")),type:"success",text:"",style:{margin:"0"}},{default:o(()=>[L(" 查看日志 ")]),_:1})]),_:1},8,["cardItem"])}}});const ta=P(aa,[["__scopeId","data-v-e013f087"]]),se=T({__name:"CreateDataFlow",props:{mode:{}},setup(n){const c=n,a=f(!1),r=Z("appId"),e=async()=>{const _=await He({name:"未命名数据流",type:c.mode,status:1,description:"",appId:r.value});K(W,{replace:!0,query:{dataDealMode:c.mode,flowMode:X.designer,appId:r.value,dataStreamId:_.id}})},u=async()=>{try{a.value=!0,await e()}finally{a.value=!1}};return(_,l)=>{const d=B;return m(),y(d,{type:"primary",icon:s(Oe),loading:a.value,onClick:u},{default:o(()=>[L(" 新增数据流 ")]),_:1},8,["icon","loading"])}}}),la=T({__name:"FlowDataCard",props:{cardItem:{}},emits:["onOpenLog"],setup(n,{emit:c}){const a=n,r=c,e=f(a.cardItem);ce(()=>a.cardItem,()=>{e.value=ie(a.cardItem)});const u=f(!1),_=async()=>{try{u.value=!0;const l=await Ge({id:e.value.id,releaseStatus:e.value.releaseStatus===1?0:1});e.value.releaseStatus=l.releaseStatus,e.value.status=l.status,N.success("更新数据成功!")}finally{u.value=!1}};return(l,d)=>{const w=B;return m(),y(pe,{cardItem:e.value},{headBar:o(()=>[g("div",null,[s(q)(e.value.releaseStatus)?(m(),y(me,{key:0,"card-item":e.value,mode:s(h).flow},null,8,["card-item","mode"])):D("",!0),t(fe,M(l.$attrs,{"card-item":e.value}),null,16,["card-item"]),s(q)(e.value.releaseStatus)?(m(),y(_e,M({key:1},l.$attrs,{"card-item":e.value}),null,16,["card-item"])):D("",!0)])]),footerBar:o(()=>[g("section",null," "),s(A)(e.value.status)?(m(),y(Fe,{key:0,"model-value":e.value.releaseStatus,updateFetch:_,isNew:"",activeText:"运行",inactiveText:"停止",activeValue:0,inactiveValue:1},null,8,["model-value"])):D("",!0),t(w,{onClick:d[0]||(d[0]=C=>r("onOpenLog")),type:"success",text:"",style:{margin:"0"}},{default:o(()=>[L(" 查看日志 ")]),_:1})]),_:1},8,["cardItem"])}}});const sa=P(la,[["__scopeId","data-v-0510b59b"]]),na=T({__name:"routePage",setup(n){const{azPageRef:c,azPageRefFlow:a,activeTab:r,flowConfig:e,updateRuleVisible:u,batchConfig:_,appId:l,handleViewLog:d,isViewLog:w,itemId:C}=We(),k=f(),V=f(),v=()=>{var i,p;(i=c.value)==null||i.refresh(),(p=V.value)==null||p.refresh()},E=()=>{var i,p;(i=a.value)==null||i.refresh(),(p=k.value)==null||p.refresh()};return(i,p)=>{const I=oe("az-page"),S=Re,x=$e;return m(),F("div",{class:"digital-factory"},[g("div",{class:"layout_box",ref:"pendingRef"},[t(x,{modelValue:s(r),"onUpdate:modelValue":p[0]||(p[0]=b=>z(r)?r.value=b:null)},{default:o(()=>[t(S,{label:"实时处理数据",name:s(h).flow},{default:o(()=>[t(le,{ref_key:"flowStatisticsRef",ref:k,"app-id":s(l)},null,8,["app-id"]),t(I,{ref_key:"azPageRefFlow",ref:a,config:s(e)},{operation:o(()=>[t(se,{mode:s(h).flow},null,8,["mode"])]),table:o(({tableData:b})=>[b.length?(m(),F("div",{key:0,class:"az-grid"},[(m(!0),F(J,null,Q(b,(O,H)=>(m(),y(sa,{key:H,"card-item":O,onOnOpenLog:()=>s(d)(O),onRefresh:E},null,8,["card-item","onOnOpenLog"]))),128))])):D("",!0)]),_:1},8,["config"])]),_:1},8,["name"]),t(S,{label:"定时处理数据",name:s(h).batch},{default:o(()=>[t(le,{ref_key:"batchStatisticsRef",ref:V,"app-id":s(l)},null,8,["app-id"]),t(I,{ref_key:"azPageRef",ref:c,config:s(_)},{operation:o(()=>[t(se,{mode:s(h).batch},null,8,["mode"])]),table:o(({tableData:b})=>[b.length?(m(),F("div",{key:0,class:"az-grid"},[(m(!0),F(J,null,Q(b,(O,H)=>(m(),y(ta,{key:H,"card-item":O,onOnOpenLog:()=>s(d)(O),onRefresh:v},null,8,["card-item","onOnOpenLog"]))),128))])):D("",!0)]),_:1},8,["config"])]),_:1},8,["name"])]),_:1},8,["modelValue"])],512),t(Qe,{visible:s(u),"onUpdate:visible":p[1]||(p[1]=b=>z(u)?u.value=b:null)},null,8,["visible"]),t(Ye,{active:s(r),visible:s(w),"onUpdate:visible":p[2]||(p[2]=b=>z(w)?w.value=b:null),dataId:s(C)},null,8,["active","visible","dataId"])])}}});const ia=P(na,[["__scopeId","data-v-8d9ac20f"]]);export{ia as default};
