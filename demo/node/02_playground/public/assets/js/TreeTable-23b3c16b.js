import{x as T,r as g,c as I,es as C,a as S,AE as h,AF as E,AG as R,b_ as x,o0 as A,e1 as w,d as L,AH as P,oy as q,z as B,o as M,b as j,B as l,C as H,qD as D,b1 as N}from"./index-b80d5ef5.js";import{e as O}from"./utils-052731c0.js";import"./formDesigner-462b10d7.js";function z(t){const _=T(),v=g([]),d=I(()=>{const e=C(v.value).find(a=>a.type===S.parent);return e&&(e.fieldId=h(e,e.fieldId),e.options.linkFieldId=h(e,e.options.linkFieldId),e.options.showFieldId=h(e,e.options.showFieldId),e.options.showOtherFieldIds=(e.options.showOtherFieldIds??[]).map(a=>h(e,a))),e}),s=I(()=>({current:1,limit:1e4,daSourceId:t.value.sourceId,viewId:t.value.viewId,select:t.value.select??{columns:[],joins:[],conditions:[]}})),m=I(()=>t.value.mode==="list"?E:R),i=I(()=>{var e,a;return{id:((e=d.value)==null?void 0:e.options.linkFieldId)??"",label:((a=d.value)==null?void 0:a.options.showFieldId)??""}}),f=x(S.parent,"getFormat");function b(e){var a,u;return e.__leaf__=!1,e.__label__=w({rowData:e,fieldId:i.value.label}),e.__value__=w({rowData:e,fieldId:i.value.id}),e.__childrenId__=w({rowData:e,fieldId:((a=d.value)==null?void 0:a.options.linkFieldId)??""}),e.__parentId__=f,d.value&&f&&(e.__parentId__=f(w({rowData:e,fieldId:((u=d.value)==null?void 0:u.fieldId)??""}),d.value,{dataSystem:_})),e}const r=g(!1),c=g([]),F=A(async()=>{try{let a=(await m.value(s.value)).records??[];a=a.filter(o=>(b(o),o.__value__));const u=[];a.forEach(o=>{o.__leaf__=!0;const k=o.__parentId__;if(!k)u.push(o);else{const p=a.find(y=>y.__childrenId__===k);p?(p.__children__=p.__children__||[],p.__leaf__=!1,p.__children__.push(o)):u.push(o)}}),c.value=u}finally{r.value=!1}},300);async function n(){t.value.sourceId||(c.value=[]);const e=await _.getSoureceData(t.value.sourceId);v.value=(e==null?void 0:e.fields)??[],O({sourceId:t.value.sourceId,dataSystem:_})||(c.value=[]),!t.value.disableRequest&&(r.value=!0,F())}return{getData:n,tableData:c,loading:r}}const J=L({__name:"TreeTable",emits:["row-click"],setup(t,{emit:_}){const v=_,d=I(()=>{const n=s.getSearchParams();return{sourceId:s.sourceId,disableRequest:s.disabledLoad||s.disabledLoadPlus,mode:"list",select:n.select,viewId:n.viewId}}),{render:s,listFields:m,selectItems:i,tableMode:f}=P(),{getData:b,tableData:r,loading:c}=z(d);b(),s.on(q,()=>{b()});const F=n=>{v("row-click",n)};return B(()=>{s.tableData=r.value}),(n,e)=>(M(),j(N,{selected:l(i),"onUpdate:selected":e[0]||(e[0]=a=>H(i)?i.value=a:null),isClick:"",multiple:"",tableMode:l(f),data:l(r),hidePagination:"",isTreeExpandColumn:"",loading:l(c),fields:l(s).fields,showFields:l(m),isSelect:l(s).view.basis.settings.some(a=>a===l(D).check),stripe:l(s).view.basis.settings.some(a=>a===l(D).discoloration),isNumber:l(s).view.basis.settings.some(a=>a===l(D).number),onRowClick:F},null,8,["selected","tableMode","data","loading","fields","showFields","isSelect","stripe","isNumber"]))}});export{J as default};
