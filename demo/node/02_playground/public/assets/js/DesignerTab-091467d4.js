import{d as q,v as J,qP as N,r as P,Y as $,o as _,f as T,i as a,B as l,w as n,k as re,m as R,F as B,H as O,C as A,b as x,gh as j,l as H,T as ue,aT as K,E as Q,ab as Y,ac as M,bm as pe,U as W,c as G,y as de,Q as Z,R as se,a5 as ie,g as z,a4 as me,K as X,Z as fe,av as ce,dC as ge,ao as ee,ap as le,dD as _e,hu as ve,_ as ae,cG as w,cF as L,qO as ye,a9 as be,aa as Ve,dy as Ie,fV as ke,qQ as he,t as Ce,L as xe,zg as Pe,zh as Ue,aN as Fe}from"./index-b80d5ef5.js";import{B as Oe}from"./ButtonState-cb54910b.js";import{P as Ee}from"./PluginSelect-032e797b.js";import{_ as Te}from"./ParamsSetWrapper.vue_vue_type_script_setup_true_lang-c3f6631f.js";import{a as Se}from"./index-c26b8edc.js";import{b as Be}from"./SelectEntryAndOther-76a65b2d.js";import{S as Re}from"./SelectFieldByMultEntry-84abd0c3.js";import"./ParamsSet.vue_vue_type_script_setup_true_lang-37c252c5.js";import"./AzInputNumber-d6212644.js";import"./el-input-number-c15b1cc7.js";const $e=q({__name:"BeforeAction",props:{modelValue:{}},emits:["update:modelValue"],setup(g,{emit:I}){const e=J(g,"modelValue",I),s={type:N.plugin},o=P($(s)),p=P(!1),h=()=>{p.value=!0,o.value=$(e.value??s),e.value&&K(()=>{var b;(b=f.value)==null||b.validate()})},f=P(),E={pluginId:[{required:!0,message:"请选择插件",trigger:"change"}]},S=async()=>{var b;await((b=f.value)==null?void 0:b.validate()),e.value=$(o.value),p.value=!1};return(b,r)=>{const i=Q,t=Y,u=M,v=pe,y=W;return _(),T("div",{style:{width:"250px"}},[a(Oe,{text:"设置动作",isSet:!!l(e),onClick:h,clear:"",onClear:r[0]||(r[0]=c=>e.value=void 0)},null,8,["isSet"]),a(ue,{modelValue:l(p),"onUpdate:modelValue":r[6]||(r[6]=c=>A(p)?p.value=c:null),"append-to-body":"",title:"设置动作","destroy-on-close":""},{footer:n(()=>[re("span",{class:"dialog-footer"},[a(y,{onClick:r[5]||(r[5]=c=>p.value=!1)},{default:n(()=>[R("取消")]),_:1}),a(y,{type:"primary",onClick:S},{default:n(()=>[R("确定")]),_:1})])]),default:n(()=>[a(v,{ref_key:"ruleFormRef",ref:f,model:l(o),"label-suffix":"：",rules:E,"label-width":"100px"},{default:n(()=>[a(u,{label:"动作类型"},{default:n(()=>[a(t,{modelValue:l(o).type,"onUpdate:modelValue":r[1]||(r[1]=c=>l(o).type=c)},{default:n(()=>[a(i,{label:l(N).plugin},{default:n(()=>[R("调用插件")]),_:1},8,["label"])]),_:1},8,["modelValue"])]),_:1}),l(o).type===l(N).plugin?(_(),T(B,{key:0},[a(O,{label:"选择插件",prop:"pluginId"},{default:n(()=>[a(Ee,{style:{width:"60%"},modelValue:l(o),"onUpdate:modelValue":r[2]||(r[2]=c=>A(o)?o.value=c:null),onChange:r[3]||(r[3]=c=>l(o).params=void 0)},null,8,["modelValue"])]),_:1}),l(o).pluginId?(_(),x(O,{label:"请求参数",prop:"params",key:l(o).pluginId},{default:n(()=>[a(Te,{style:{width:"60%"},modelValue:l(o).params,"onUpdate:modelValue":r[4]||(r[4]=c=>l(o).params=c),pluginId:l(o).pluginId,group:[l(j)()]},null,8,["modelValue","pluginId","group"])]),_:1})):H("",!0)],64)):H("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}});var C=(g=>(g.field="0",g.linkField="1",g.form="2",g.array="3",g.object="4",g.other="5",g))(C||{});function Ae(g=[]){const I=new Map;return function k(U,e="",s=[]){U.forEach((o,p)=>{var f;const h=`${e?e+".":""}${p}`;I.set(o.paramId,{param:o,index:p,parentList:U,propPrefix:h,matched:[...s,o],parent:s[s.length-1]}),(f=o.child)!=null&&f.length&&k(o.child,`${h}.child`,[...s,o])})}(g??[]),I}const we=[{label:"表单",value:C.form},{label:"表单控件",value:C.linkField},{label:"数组",value:C.array},{label:"对象",value:C.object},{label:"其他",value:C.other}],Le=q({__name:"SetParamValue",props:{modelValue:{},paramInfo:{},appId:{}},emits:["update:modelValue"],setup(g,{emit:I}){const k=g,e=J(k,"modelValue",I),s=G(()=>k.paramInfo.param);return de([()=>s.value.type,()=>{var o;return(o=k.paramInfo.parent)==null?void 0:o.value}],()=>{e.value=void 0}),(o,p)=>{const h=Z;return s.value.type===l(C).linkField?(_(),x(Re,{key:0,modelValue:l(e),"onUpdate:modelValue":p[0]||(p[0]=f=>A(e)?e.value=f:null),entryInfo:{appId:o.appId},checkStrictly:"",isSelectSubform:"",prop:{fieldId:"fieldId",subformId:"subformId",fieldType:"fieldType",entryId:"entryId"}},null,8,["modelValue","entryInfo"])):s.value.type===l(C).form?(_(),x(Be,{key:1,modelValue:l(e),"onUpdate:modelValue":p[1]||(p[1]=f=>A(e)?e.value=f:null),appId:o.appId},null,8,["modelValue","appId"])):(_(),x(h,{key:2,modelValue:l(e),"onUpdate:modelValue":p[2]||(p[2]=f=>A(e)?e.value=f:null),placeholder:"请输入"},null,8,["modelValue"]))}}}),qe=q({__name:"ParamsConfig",props:{modelValue:{},appId:{}},emits:["update:modelValue"],setup(g,{expose:I,emit:k}){const s=se(g,"modelValue",k),o=P(),p=G(()=>Ae(s.value)),h=t=>{const u=[...(t?t.child:s.value)??[]];u.push({paramId:fe([...p.value.keys()]),type:t?C.linkField:C.other}),t?t.child=u:s.value=u},f=(t,u)=>{const v=p.value.get(t.paramId);if(v)return`${v.propPrefix}.${u}`},E=t=>[{required:!0,message:"请输入参数标识",trigger:"change"},{pattern:ve,message:"由字母和数字组成, 以字母开头",trigger:"change"},{validator(v,y,c){if([...p.value.values()].filter(d=>d.param.paramId!==t.paramId).some(d=>d.param.key===y))return c(new Error("参数标识重复"));c()},trigger:"change"}],S=t=>{[...p.value.values()].filter(u=>u.param.key&&u.param.paramId!==t.paramId).map(u=>f(u.param,"key")??"").forEach(u=>{var v,y;(y=(v=o.value)==null?void 0:v.ruleFormRef)==null||y.validateField(u)})},b=t=>{t.value&&(t.value=void 0,t.child=void 0)},r=t=>we,i=t=>{const u=p.value.get(t.paramId);u&&u.parentList.splice(u.index,1)};return I({validate(){var t,u;return(u=(t=o.value)==null?void 0:t.ruleFormRef)==null?void 0:u.validate()}}),(t,u)=>{const v=ce,y=Z,c=M,F=ge,d=ee,D=le,te=W,oe=_e;return _(),x(X,{model:l(s),ref_key:"AzFormRef",ref:o,"label-width":"90px"},{default:n(()=>[a(O,{"hide-label":""},{default:n(()=>[a(v,{underline:!1,icon:l(ie),type:"primary",onClick:u[0]||(u[0]=m=>h())},{default:n(()=>[R(" 添加参数 ")]),_:1},8,["icon"]),a(oe,{class:"params_table",data:l(s)??[],border:"",style:{width:"100%"},stripe:"","row-key":"paramId","default-expand-all":"","tree-props":{children:"child"}},{default:n(()=>[a(F,{prop:"key",label:"参数标识",width:"200"},{default:n(({row:m})=>[a(c,{prop:f(m,"key"),rules:E(m)},{default:n(()=>[a(y,{modelValue:m.key,"onUpdate:modelValue":V=>m.key=V,placeholder:"参数标识",onInput:()=>S(m)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1032,["prop","rules"])]),_:1}),a(F,{prop:"type",label:"类型",width:"150"},{default:n(({row:m})=>[a(c,{prop:f(m,"type"),rules:[{required:!0,message:"请选择参数类型",trigger:"change"}]},{default:n(()=>[a(D,{modelValue:m.type,"onUpdate:modelValue":V=>m.type=V,placeholder:"参数类型",onChange:()=>b(m)},{default:n(()=>[(_(!0),T(B,null,z(r(m),(V,ne)=>(_(),x(d,{key:ne,label:V.label,value:V.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop"])]),_:1}),a(F,{prop:"name",label:"参数值",width:"200"},{default:n(({row:m})=>[a(O,{hideLabel:"",prop:f(m,"value"),rules:[{required:!0,message:"参数值必填项",trigger:"change"}]},{default:n(()=>[a(Le,{modelValue:m.value,"onUpdate:modelValue":V=>m.value=V,"param-info":p.value.get(m.paramId),appId:t.appId},null,8,["modelValue","onUpdate:modelValue","param-info","appId"])]),_:2},1032,["prop"])]),_:1}),a(F,{prop:"name",label:"说明",width:"200"},{default:n(({row:m})=>[a(y,{modelValue:m.explanation,"onUpdate:modelValue":V=>m.explanation=V,placeholder:"参数说明，选填"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),a(F,{fixed:"right",label:"操作"},{default:n(({row:m})=>[a(te,{link:"",type:"danger",onClick:V=>i(m),icon:l(me)},null,8,["onClick","icon"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1},8,["model"])}}});const De=ae(qe,[["__scopeId","data-v-55e3b433"]]),Ne=q({__name:"DesignerTab",props:{appId:{},entryId:{},teleportTo:{}},setup(g,{expose:I}){const k=g,U=P(),e=P({pageOpenWay:w.embed,type:L.out}),s=P(),o=async()=>{const r=await Pe(k.entryId);e.value={...r},e.value.type==L.out&&e.value.pageOpenWay==null&&(e.value.pageOpenWay=w.embed),s.value=$(e.value),e.value.type===L.out&&e.value.externalPageUrl&&K(()=>{S()})},p=G(()=>{var i,t;const r=[j({isClient:!0})];return r.push({id:ye,title:"前置动作参数",pluginOptions:{pluginId:(i=e.value.openPreAction)==null?void 0:i.pluginId,pluginIdByPrefix:!0},hidden:!((t=e.value.openPreAction)!=null&&t.pluginId)}),r}),h={externalPageUrl:[{required:!0,message:"请输入",trigger:"change"}],pageOpenWay:[{required:!0,message:"请选择",trigger:"change"}]},f=P(),E=P(!1),S=async()=>{var r,i,t;return Promise.all([(i=(r=f.value)==null?void 0:r.ruleFormRef)==null?void 0:i.validate(),(t=U.value)==null?void 0:t.validate()])},b=async()=>{E.value=!0;try{await S(),await Ue(e.value),Fe.success("保存成功"),s.value=$(e.value)}finally{E.value=!1}};return I({async beforeLeave(){if(!(!s.value||be(JSON.parse(JSON.stringify(s.value)),JSON.parse(JSON.stringify(e.value)))))return new Promise((r,i)=>{Ve.confirm("您修改了页面设计但没有保存，是否需要保存页面设计并继续？","页面设计有修改，是否保存?",{confirmButtonText:"保存并继续",cancelButtonText:"不保存",type:"warning",distinguishCancelAndClose:!0,closeOnClickModal:!1,closeOnHashChange:!1,beforeClose(t,u,v){t==="confirm"?(u.confirmButtonLoading=!0,b().then(()=>{v(),r()}).finally(()=>{u.confirmButtonLoading=!1})):t==="cancel"?(v(),r()):t==="close"&&(v(),i())}})})}}),(r,i)=>{const t=W,u=Q,v=Y,y=ee,c=le,F=M;return _(),x(xe,{load:o,class:"desiger-tab"},{default:n(()=>[(_(),x(Ie,{to:r.teleportTo},[a(t,{type:"primary",onClick:b,loading:l(E)},{default:n(()=>[R(" 保存 ")]),_:1},8,["loading"])],8,["to"])),a(X,{labelBold:"","label-suffix":"：","label-width":"150px",class:"desiger-tab-form",model:l(e),rules:h,ref_key:"azFormRef",ref:f},{default:n(()=>[l(e).type!==l(L).in?(_(),T(B,{key:0},[a(O,{label:"页面打开前动作"},{default:n(()=>[a($e,{modelValue:l(e).openPreAction,"onUpdate:modelValue":i[0]||(i[0]=d=>l(e).openPreAction=d)},null,8,["modelValue"])]),_:1}),a(O,{label:"外部页面链接地址",class:"desiger-inputare",prop:"externalPageUrl"},{default:n(()=>[a(ke,{modelValue:l(e).externalPageUrl,"onUpdate:modelValue":i[1]||(i[1]=d=>l(e).externalPageUrl=d),group:l(p),minHeight:"64px"},null,8,["modelValue","group"])]),_:1}),a(O,{label:"页面打开方式",prop:"pageOpenWay"},{default:n(()=>[a(v,{modelValue:l(e).pageOpenWay,"onUpdate:modelValue":i[2]||(i[2]=d=>l(e).pageOpenWay=d),class:"ml-4"},{default:n(()=>[(_(!0),T(B,null,z(l(he).filter(d=>[l(w).embed,l(w).blank].includes(d.value)),d=>(_(),x(u,{key:d.value,label:d.value},{default:n(()=>[R(Ce(d.label),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])]),_:1})],64)):(_(),T(B,{key:1},[a(O,{label:"页面访问路径",prop:"internalPageId"},{default:n(()=>[a(c,{modelValue:l(e).internalPageId,"onUpdate:modelValue":i[3]||(i[3]=d=>l(e).internalPageId=d),placeholder:"请选择"},{default:n(()=>[(_(!0),T(B,null,z(l(Se)(),(d,D)=>(_(),x(y,{key:D,label:d.label,value:d.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(F,{label:"参数"},{default:n(()=>[a(De,{modelValue:l(e).internalPageParam,"onUpdate:modelValue":i[4]||(i[4]=d=>l(e).internalPageParam=d),ref_key:"paramsConfigRef",ref:U,"app-id":r.appId},null,8,["modelValue","app-id"])]),_:1})],64))]),_:1},8,["model"])]),_:1})}}});const Ze=ae(Ne,[["__scopeId","data-v-d5158f7d"]]);export{Ze as default};
