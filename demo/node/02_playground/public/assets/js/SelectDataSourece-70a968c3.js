import{d as R,gG as o,c as b,n as P,r as V,V as W,lC as X,y as Y,o as s,b as m,w as i,i as f,f as v,F,g as A,k as _,p as x,t as $,l as I,B,lD as z,L as O,J as Z,gF as ee,D as ae,P as te,c3 as le,N as se,O as ne,Q as re,_ as ue}from"./index-b80d5ef5.js";const oe=R({__name:"SelectDataSourece",props:{modelValue:{},aggregationId:{},appId:{},currentEntryId:{},hideCurrentEntry:{type:Boolean},isTree:{type:Boolean},isSystem:{type:Boolean,default:!1},isFlowForm:{type:Boolean,default:!1},isAggregate:{type:Boolean,default:!1},tabs:{},multiple:{type:Boolean}},emits:["update:modelValue","update:aggregationId","change"],setup(U,{expose:j,emit:G}){const C=new Map([[o.currentApp,{label:"表单",type:o.currentApp}],[o.otherApp,{label:"数据集",type:o.otherApp}],[o.system,{label:"系统数据",type:o.system}],[o.processForm,{label:"流程表单",type:o.processForm}]]),t=U,y=G,c=b({get(){return P(t.modelValue)},set(e){y("update:modelValue",t.multiple?[...e]:e[0]??"")}}),k=V("0"),S=V(""),p=V([]),w=b(()=>t.tabs?t.tabs.map(e=>{let a;return W(e)?a=e:a=C.get(e),a}):[...C.values()].filter(e=>!(e.type===o.system&&!t.isSystem||e.type===o.processForm&&!t.isFlowForm))),J=async()=>{p.value=await Promise.all(w.value.map(e=>ee({appId:t.appId,type:e.type})))},D=b(()=>{const e=S.value.trim();return p.value.map((a,n)=>a.filter(l=>n===0&&t.hideCurrentEntry&&l.entryIds.length===1&&l.entryIds[0].entryId===t.currentEntryId||t.isTree&&!(l.entryIds.length===1&&l.entryIds[0].isTreeForm===X.yes)?!1:!e||l.name.includes(e)))}),M=e=>{if(!t.multiple&&e.id===c.value[0])return;const a=new Set(t.multiple?c.value:[]);if(a.has(e.id)?a.delete(e.id):a.add(e.id),c.value=[...a],t.multiple){const n=p.value.flat();y("change",[...a],[...a].map(l=>n.find(u=>u.id===l)),{aggregationId:[...d.value],aggregationIdItem:d.value.map(l=>E.value.find(u=>u.id===l))})}else d.value=[],y("change",e.id,e,{aggregationId:""})},L=()=>{if(c.value.length){if(!p.value.length)return;for(let e=0;e<p.value.length;e++)p.value[e].some(n=>n.id===c.value[0])&&(k.value=`${e}`)}else d.value.length&&(k.value="aggregate")};Y([p],()=>{L()}),j({locationSource:L});const d=b({get(){return P(t.aggregationId)},set(e){y("update:aggregationId",t.multiple?[...e]:e[0]??"")}}),E=V([]),N=b(()=>{const e=S.value.trim();return E.value.filter(a=>!e||a.name.includes(a.name))}),Q=async()=>{E.value=(await ae({appId:t.appId,name:"",current:1,limit:1e3})).records},q=e=>{if(!t.multiple&&e.id===d.value[0])return;const a=new Set(t.multiple?d.value:[]);if(a.has(e.id)?a.delete(e.id):a.add(e.id),d.value=[...a],t.multiple){const n=p.value.flat();y("change",[...c.value],[...c.value].map(l=>n.find(u=>u.id===l)),{aggregationId:[...a],aggregationIdItem:[...a].map(l=>E.value.find(u=>u.id===l))})}else y("change","",void 0,{aggregationId:e.id,aggregationIdItem:e})};return(e,a)=>{const n=te,l=le,u=se,H=ne,K=re;return s(),m(O,{load:J,class:"select_sourece"},{default:i(()=>[f(H,{modelValue:k.value,"onUpdate:modelValue":a[0]||(a[0]=r=>k.value=r),type:"border-card"},{default:i(()=>[(s(!0),v(F,null,A(w.value,(r,h)=>(s(),m(u,{key:h,label:r.label,name:`${h}`},{default:i(()=>{var T;return[_("div",{class:"sourece-content"},[_("ul",null,[(s(!0),v(F,null,A(D.value[h],g=>(s(),v("li",{key:g.id,class:x({"is-active":c.value.includes(g.id)}),onClick:ce=>M(g)},[_("span",{class:"sourece-name az-ellipsis",title:g.name},[_("span",null,$(g.name),1),t.currentEntryId&&g.entryIds.length===1&&g.entryIds[0].entryId===t.currentEntryId?(s(),v("span",{key:0,class:"sourece-current-entry"}," (当前表单) ")):I("",!0)],8,["title"]),c.value.includes(g.id)?(s(),m(n,{key:0},{default:i(()=>[f(B(z))]),_:1})):I("",!0)],10,["onClick"]))),128))]),(T=D.value[h])!=null&&T.length?I("",!0):(s(),m(l,{key:0,description:"无数据"}))])]}),_:2},1032,["label","name"]))),128)),e.isAggregate?(s(),m(u,{key:"aggregate",lazy:"",label:"聚合表",name:"aggregate"},{default:i(()=>[f(O,{load:Q,class:"sourece-content"},{default:i(()=>[_("ul",null,[(s(!0),v(F,null,A(N.value,r=>(s(),v("li",{key:r.id,class:x({"is-active":d.value.includes(r.id)}),onClick:h=>q(r)},[_("span",{class:"sourece-name"},$(r.name),1),d.value.includes(r.id)?(s(),m(n,{key:0},{default:i(()=>[f(B(z))]),_:1})):I("",!0)],10,["onClick"]))),128))]),N.value.length?I("",!0):(s(),m(l,{key:0,description:"无数据"}))]),_:1})]),_:1})):I("",!0)]),_:1},8,["modelValue"]),f(K,{modelValue:S.value,"onUpdate:modelValue":a[1]||(a[1]=r=>S.value=r),class:"select_sourece-search",placeholder:"搜索",clearable:""},{prefix:i(()=>[f(n,{class:"el-input__icon"},{default:i(()=>[f(B(Z))]),_:1})]),_:1},8,["modelValue"])]),_:1})}}});const ie=ue(oe,[["__scopeId","data-v-6ee1a5b8"]]);export{ie as S};
