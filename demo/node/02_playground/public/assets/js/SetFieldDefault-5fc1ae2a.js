import{d as Q,mv as X,R as Z,c as m,eR as v,mw as ae,g2 as H,a as O,Y as w,mx as de,my as ee,ax as ue,mz as se,a6 as ie,mA as re,o as F,f as M,b as T,w as y,i as h,F as z,g as Y,B as p,l as I,a3 as oe,H as P,m as ne,cj as fe,mj as pe,I as ce,bt as me,h as J,ap as ye,ac as Fe,aU as he,q as ve,ao as ge,_ as le,x as Te,er as Ie,r as U,y as be,L as De,dA as Se,a4 as Ve,lA as x,mB as _e,h1 as Ee,mC as ke,dC as Ce,av as Le,dD as Be,bm as qe,a9 as Me}from"./index-b80d5ef5.js";import{_ as Pe}from"./ButtonSelectField.vue_vue_type_script_setup_true_lang-aae15f71.js";import{m as $e}from"./fieldDefaultComponent-58752d9c.js";import{F as Ae}from"./FormulaWrapper-92a83208.js";const Re=Q({__name:"SetFieldDefaultItem",props:{modelValue:{},prop:{},field:{},sourceId:{},customTypeList:{default:()=>X()},externalTypeList:{},formulaProp:{},parentFieldDefault:{},required:{type:Boolean},isParse:{type:Boolean,default:!0},totalFields:{},isMainToSon:{type:Boolean,default:!1},customRightFields:{},isMultiple:{type:Boolean},isEscape:{type:Boolean},customGroup:{}},emits:["update:modelValue"],setup(K,{emit:j}){const a=K,u=Z(a,"modelValue",j),C=()=>{u.value.child&&u.value.child.forEach(e=>{e.currentFieldId="",e.currentFieldType=void 0})},g=m(()=>a.field&&$e(a.field.type)),b=m(()=>!a.isMultiple&&!!(a.parentFieldDefault&&(a.parentFieldDefault.defaultType===v.currentField&&!a.parentFieldDefault.currentFieldId||a.parentFieldDefault.defaultType===v.params&&!a.parentFieldDefault.paramKey))),L=m(()=>{var n,l,t,r;if(b.value)return[];if(a.customRightFields)return a.customRightFields({fields:a.totalFields??[],fieldInfo:{fieldType:(n=a.field)==null?void 0:n.type},parent:a.parentFieldDefault});const e=(l=a.parentFieldDefault)==null?void 0:l.currentFieldId;let s=a.totalFields??[];if(e)if(a.isMainToSon)s=ae({fields:a.totalFields??[],subformFieldId:e});else{const f=(t=H(e,a.totalFields??[]))==null?void 0:t.field;(f==null?void 0:f.type)===O.subform&&(s=f.fields.map(c=>{const d=w(c);return d.options.label=`${f.options.label}.${d.options.label}`,d}))}return de(s,(r=a.field)==null?void 0:r.type)}),D=m(()=>{var e;return ee({list:a.customTypeList,field:a.field,isClient:((e=a.formulaProp)==null?void 0:e.mode)!==ue.server})}),V=m(()=>D.value.find(e=>e.value===u.value.defaultType)),$=m(()=>{var s;const e=(s=a.parentFieldDefault)!=null&&s.defaultType?D.value.find(n=>{var l;return n.value===((l=a.parentFieldDefault)==null?void 0:l.defaultType)}):void 0;return e!=null&&e.childFollow?D.value.filter(n=>{var l;return(l=e==null?void 0:e.childFollow)==null?void 0:l.includes(n.value)}):D.value}),A=e=>{var s;e&&(delete e.customDefault,delete e.paramKey,delete e.isMainField,delete e.currentSubformFieldId,delete e.escape,((s=D.value.find(n=>n.value===v.currentField))==null?void 0:s.disabled)!==!0&&(delete e.currentFieldId,delete e.currentFieldType),e.child&&(e.child.forEach(n=>{n.defaultType!==e.defaultType&&(n.defaultType=e.defaultType,A(n))}),C()))},R=m(()=>{var e;return!(!se(a.field)||a.isMultiple&&((e=a.field)==null?void 0:e.type)===O.subform||a.parentFieldDefault&&a.parentFieldDefault.defaultType&&[v.custom,v.function,v.empty].includes(a.parentFieldDefault.defaultType))}),G=m(()=>{var e;return b.value===!0||((e=V.value)==null?void 0:e.disabled)}),B=m({get(){return u.value.customDefault},set(e){if(a.isParse)u.value.customDefault=e;else{if(typeof e=="string")try{e=JSON.parse(e)}catch{}u.value.customDefault=e}}}),_=m(()=>a.customTypeList.find(e=>e.value===v.params)),W=m(()=>{var n,l,t,r;let e=((n=_.value)==null?void 0:n.paramOptions)??[];if(a.parentFieldDefault&&(e=((l=e.find(f=>{var c;return f.value===((c=a.parentFieldDefault)==null?void 0:c.paramKey)}))==null?void 0:l.children)??[]),((t=a.field)==null?void 0:t.type)===O.subform)return e.filter(f=>Array.isArray(f.children));const s=ie((r=a.field)==null?void 0:r.type);return e.filter(f=>!f.fieldType||!s?!0:s.includes(f.fieldType))}),E=m({get(){return{currentFieldId:u.value.currentFieldId,currentFieldType:u.value.currentFieldType}},set(e){var n;delete u.value.escape,u.value.currentFieldId=e==null?void 0:e.currentFieldId,u.value.currentFieldType=e==null?void 0:e.currentFieldType;const s=(n=H((e==null?void 0:e.currentFieldId)??"",a.totalFields??[]))==null?void 0:n.parentField;(s==null?void 0:s.type)===O.subform?(u.value.currentSubformFieldId=s.fieldId,u.value.isMainField=!1):u.value.isMainField=!0}}),q=m(()=>a.isEscape&&u.value.currentFieldType&&u.value.fieldType!==u.value.currentFieldType&&re.includes(u.value.currentFieldType)),N=m({get(){return u.value.escape===1},set(e){u.value.escape=e?1:0}});return(e,s)=>{var c;const n=ge,l=ye,t=Fe,r=he,f=ve;return R.value?(F(),M("div",{key:0,class:"field_default"},[D.value.length>1?(F(),T(t,{key:0,required:"",prop:`${e.prop}.defaultType`,"show-message":!1,"label-width":"0",class:"default-form-item"},{default:y(()=>[h(l,{modelValue:p(u).defaultType,"onUpdate:modelValue":s[0]||(s[0]=d=>p(u).defaultType=d),placeholder:"请选择类型",onChange:s[1]||(s[1]=d=>A(p(u)))},{default:y(()=>[(F(!0),M(z,null,Y($.value,(d,i)=>(F(),T(n,{key:i,label:d.label,value:d.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["prop"])):I("",!0),p(u).defaultType===p(v).currentField?(F(),M(z,{key:1},[h(P,{required:e.required,prop:`${e.prop}.currentFieldId`,"show-message":!1,"hide-label":"",class:"default-form-item default-custom"},{default:y(()=>{var d;return[h(oe,{class:"w100",modelValue:E.value,"onUpdate:modelValue":s[2]||(s[2]=i=>E.value=i),fields:L.value,sourceId:e.sourceId,disabled:G.value,placeholder:b.value===!0?"请先选择子表单填入控件":(d=V.value)==null?void 0:d.placeholder,prop:{fieldId:"currentFieldId",fieldType:"currentFieldType"},"is-select-subform":"",onChange:C,clearable:!e.required},null,8,["modelValue","fields","sourceId","disabled","placeholder","clearable"])]}),_:1},8,["required","prop"]),q.value?(F(),T(f,{key:0,style:{"margin-left":"5px"},modelValue:N.value,"onUpdate:modelValue":s[3]||(s[3]=d=>N.value=d)},{default:y(()=>[h(r,{class:"box-item",effect:"dark",content:"将id值转义为可读文本",placement:"top-start"},{default:y(()=>[ne(" 转义 ")]),_:1})]),_:1},8,["modelValue"])):I("",!0)],64)):I("",!0),p(u).defaultType===p(v).custom?(F(),T(P,{key:2,required:e.required,prop:`${e.prop}.customDefault`,"show-message":!1,"hide-label":"",class:"default-form-item default-custom"},{default:y(()=>[(F(),T(fe(g.value),{modelValue:B.value,"onUpdate:modelValue":s[4]||(s[4]=d=>B.value=d),field:e.field,mode:p(pe).customBtn,group:e.customGroup},null,8,["modelValue","field","mode","group"]))]),_:1},8,["required","prop"])):I("",!0),p(u).defaultType===p(v).function?(F(),T(P,{key:3,required:e.required,prop:`${e.prop}.customDefault`,"show-message":!1,"hide-label":"",class:"default-form-item default-custom"},{default:y(()=>[h(Ae,ce({modelValue:p(u).customDefault,"onUpdate:modelValue":s[5]||(s[5]=d=>p(u).customDefault=d)},e.formulaProp),null,16,["modelValue"])]),_:1},8,["required","prop"])):I("",!0),p(u).defaultType===p(v).params?(F(),T(P,{key:4,required:e.required,prop:`${e.prop}.paramKey`,"show-message":!1,"hide-label":"",class:"default-form-item default-custom"},{default:y(()=>{var d,i,S;return[h(me,{modelValue:p(u).paramKey,"onUpdate:modelValue":s[6]||(s[6]=k=>p(u).paramKey=k),isCheckRemove:"",disabled:b.value===!0||((d=V.value)==null?void 0:d.disabled),removeText:((i=_.value)==null?void 0:i.removeText)??"参数不可选择/已被删除",placeholder:b.value===!0?"请先选择子表单填充":((S=_.value)==null?void 0:S.placeholder)??"请选择"},{default:y(()=>[(F(!0),M(z,null,Y(W.value,(k,te)=>(F(),T(n,{key:te,label:k.label,value:k.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled","removeText","placeholder"])]}),_:1},8,["required","prop"])):I("",!0),(c=e.externalTypeList)!=null&&c.some(d=>d.value===p(u).defaultType)?J(e.$slots,"external-type-set",{key:5,data:p(u),onUpdateData:d=>u.value=p(w)(d)},void 0,!0):I("",!0)])):I("",!0)}}});const Ne=le(Re,[["__scopeId","data-v-e58c0948"]]),Oe=Q({__name:"SetFieldDefault",props:{modelValue:{},leftEntryId:{},leftFields:{},leftSourceId:{},rightEntryId:{},rightSourceId:{},rightFields:{},rightAggregateId:{},isSubform:{type:Boolean,default:!1},filter:{},leftFieldColumnName:{default:"字段名称"},rightFieldColumnName:{default:"设置为"},customTypeList:{},externalTypeList:{},formulaProp:{},btnText:{default:"选择控件"},selectFieldLabel:{},maxHeight:{default:"50vh"},required:{type:Boolean,default:!0},isAdd:{type:Boolean,default:!0},isDelete:{type:Boolean,default:!0},isParse:{type:Boolean,default:!0},isMainToSon:{type:Boolean,default:!1},customRightFields:{},isMultiple:{type:Boolean},leftFieldColumnWidth:{default:"180px"},isEscape:{type:Boolean,default:!1},customGroup:{}},emits:["update:modelValue"],setup(K,{expose:j,emit:a}){const o=K,C=Z(o,"modelValue",a),g=m({get(){return C.value??[]},set(l){C.value=l}}),b=m(()=>[...(o.customTypeList??X({isFunction:!!o.formulaProp})).map(t=>o.selectFieldLabel&&t.value===v.currentField?{...t,label:o.selectFieldLabel}:t),...o.externalTypeList??[]]),L=Te(),{getFieldInfo:D}=Ie(L),V=U([]),$=U([]),A=async()=>{const[l,t]=await Promise.all([x({dataSystem:L,entryId:o.leftEntryId,fields:o.leftFields,sourceId:o.leftSourceId}),x({dataSystem:L,entryId:o.rightEntryId,fields:o.rightFields,sourceId:o.rightSourceId,aggregateId:o.rightAggregateId})]);V.value=l,$.value=t},R=U();be([()=>o.leftEntryId,()=>o.leftSourceId,()=>o.leftFields,()=>o.rightEntryId,()=>o.rightSourceId,()=>o.rightFields],(l,t)=>{var r;Me(l,t)||(r=R.value)==null||r.reload()});const G=l=>{let t=_e(l,{isSubform:o.isSubform});return Ee(o.filter)&&(t=o.filter(t)),t};function B(l){return l.map(t=>{var f,c,d;const r={...t};return r.defaultType==null&&(r.defaultType=((d=(c=ee({list:b.value,field:(f=D(t.fieldId,{entryId:o.leftEntryId,fields:o.leftFields}))==null?void 0:f.field}))==null?void 0:c[0])==null?void 0:d.value)??v.custom),r.child&&(r.child=B(r.child)),r})}const _=m({get(){return g.value},set(l){g.value=B(l)}}),W=l=>{var t;return(t=H(l,V.value))==null?void 0:t.field},E=l=>{const t=[];try{(function r(f,c){f.forEach((d,i)=>{if(d.fieldId===l)throw t.push(...c,i),"退出循环";Array.isArray(d.child)&&r(d.child,[...c,i])})})(g.value,[])}catch{}return t},q=l=>{const t=E(l);return t.length>1?`${t[0]}.child.${t[1]}`:t.join(".")},N=l=>{const t=q(l.fieldId);t&&ke(g.value,t,l)},e=l=>{const t=E(l);if(t.length>1)return g.value[t[0]]},s=l=>{var f,c,d,i,S;const t=E(l),r=w(g.value);t.length===1?r.splice(t[0],1):t.length===2&&((c=(f=r[t[0]])==null?void 0:f.child)==null||c.splice(t[1],1),Array.isArray((d=r[t[0]])==null?void 0:d.child)&&!((S=(i=r[t[0]])==null?void 0:i.child)!=null&&S.length)&&r.splice(t[0],1)),g.value=r},n=U();return j({validate(){var l;return(l=n.value)==null?void 0:l.validate()}}),(l,t)=>{const r=Ce,f=Le,c=Be,d=qe;return F(),M("div",{class:"set-field-default"},[h(d,{model:g.value,ref_key:"ruleFormRef",ref:n},{default:y(()=>[l.isAdd?(F(),T(Pe,{key:0,modelValue:_.value,"onUpdate:modelValue":t[0]||(t[0]=i=>_.value=i),placeholder:l.btnText,"entry-id":l.leftEntryId,fields:l.leftFields,sourceId:l.leftSourceId,disabled:!l.leftEntryId&&!l.leftFields&&!l.leftSourceId,filter:G,prop:{fieldId:"fieldId",fieldType:"fieldType",subformId:"subformId",child:"child"},style:{"max-width":"300px"},class:"mb-10",isSelectSubform:"",multiple:""},null,8,["modelValue","placeholder","entry-id","fields","sourceId","disabled"])):I("",!0),h(De,{class:"form_enter",ref_key:"loadingDataRef",ref:R,load:A},{default:y(()=>[h(c,{data:g.value,border:"",style:{width:"100%"},stripe:"","row-key":"fieldId","default-expand-all":"","max-height":l.maxHeight??void 0,"tree-props":{children:"child"}},{default:y(()=>[J(l.$slots,"prep-column",{},void 0,!0),h(r,{prop:"fieldName",label:l.leftFieldColumnName,width:l.leftFieldColumnWidth,"class-name":"current-field"},{default:y(({row:i})=>[h(P,{style:{display:"inline-flex"},required:"",prop:`${q(i==null?void 0:i.fieldId)}.fieldId`,"show-message":!1,"hide-label":""},{default:y(()=>[h(Se,{fieldId:i.fieldId,fields:V.value,isThrow:""},null,8,["fieldId","fields"])]),_:2},1032,["prop"])]),_:1},8,["label","width"]),h(r,{label:l.rightFieldColumnName,"min-width":"200"},{default:y(({row:i})=>[h(Ne,{isEscape:l.isEscape,required:l.required,"model-value":i,"onUpdate:modelValue":N,prop:q(i==null?void 0:i.fieldId),field:W(i==null?void 0:i.fieldId),sourceId:l.rightSourceId,totalFields:$.value,formulaProp:l.formulaProp,customTypeList:b.value,isParse:l.isParse,isMainToSon:l.isMainToSon,customRightFields:l.customRightFields,isMultiple:l.isMultiple,parentFieldDefault:e(i==null?void 0:i.fieldId),externalTypeList:l.externalTypeList,customGroup:l.customGroup},{"external-type-set":y(({data:S,onUpdateData:k})=>[J(l.$slots,"external-type-set",{data:S,onUpdateData:k},void 0,!0)]),_:2},1032,["isEscape","required","model-value","prop","field","sourceId","totalFields","formulaProp","customTypeList","isParse","isMainToSon","customRightFields","isMultiple","parentFieldDefault","externalTypeList","customGroup"])]),_:3},8,["label"]),l.isDelete?(F(),T(r,{key:0,width:"50"},{default:y(({row:i})=>[h(f,{underline:!1,icon:p(Ve),type:"danger",onClick:S=>s(i==null?void 0:i.fieldId)},null,8,["icon","onClick"])]),_:1})):I("",!0)]),_:3},8,["data","max-height"])]),_:3},512)]),_:3},8,["model"])])}}});const We=le(Oe,[["__scopeId","data-v-e00894df"]]);export{We as S,Ne as a};
