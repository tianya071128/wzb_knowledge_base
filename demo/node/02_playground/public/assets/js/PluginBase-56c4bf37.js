import{jG as fe,r as y,c as S,h_ as I,hY as f,o0 as pe,o1 as G,o2 as ye,hZ as v,a as se,gS as W,y as he,z as ve,aT as re,a9 as me,b_ as ge,d as _e,o as C,f as J,B as s,b as ee,w as F,m as le,t as ae,ad as be,k as M,i as ne,J as Te,p as Se,bc as Ce,F as oe,g as de,I as Fe,U as ke,av as Pe,P as Be,ap as Ne,ao as De,_ as Ee}from"./index-b80d5ef5.js";import{u as Ve}from"./useFieldMaxWidth-d82f063e.js";function Ae(a){const m="searchId",u=fe(),p=y(""),k=y(!1),A=y(!1),h=y({}),w=(e,l)=>{var i;return((i=ge(l.type,"getFormat"))==null?void 0:i(e,l))??e??null},x=(e,l)=>{var c,d;const i=(c=u.matchField(l.value))==null?void 0:c.field;if(l.fillType!==I.field||!i)return e;let n=e;return l.paramType===v.arrayObject?n=n==null?void 0:n.map((o,D)=>(l.child??[]).reduce((t,E)=>({...t,[E.paramName]:L(E,D)}),{})):l.paramType===v.annex?n=(d=w(n,i))==null?void 0:d[0]:l.paramType===v.personnel||l.paramType===v.dept||l.paramType===v.job?n=w(n,i):l.paramType===v.array&&(n=W(n).filter(o=>o!=null).reduce((o,D)=>[...new Set([...o,...W(w(D,i))])],[])),Array.isArray(n)&&n.length===0&&(n=""),n=n??"",typeof n!="string"?JSON.stringify(n):n},L=(e,l)=>{let i;return e.fillType===I.custom?i=e.value:e.fillType===I.search?i=p.value:i=x(u.getFieldVal(e.value,l??a.index),e),i??""},P=S(()=>{if(!a.isRender)return{};const e={};for(const l of a.field.options.requestParmas??[])e[l.paramName]=L(l);return e}),g=S(()=>{const e=new Set;for(const l of a.field.options.requestParmas??[]){const i=P.value[l.paramName];l.requiredFlag&&(i==null||i==="")&&e.add(l.fillType===I.search?m:l.value),Array.isArray(l.child)&&l.child.length&&i&&JSON.parse(i).forEach(n=>{for(const c of l.child??[]){const d=n[c.paramName];c.requiredFlag&&(d==null||d==="")&&e.add(c.fillType===I.search?m:c.value)}})}return e}),H=S(()=>a.isRender?!![...g.value].filter(e=>!(a.field.options.displayType===f.searchDrop&&e===m)).length:!0),U=pe(async()=>{try{const e=await ye({callApplicationId:u.appId,entryId:u.entryId,data:P.value,apiId:a.field.options.pluginId,tenantApiId:a.field.options.tenantApiId});h.value=e,a.field.options.displayType===f.btn&&B(e)}catch{h.value={},k.value=!0}finally{A.value=!1}},a.field.options.displayType===f.searchDrop&&a.field.options.searchWay===G.realtime?300:0),_=async()=>{h.value={},!(!a.isRender||g.value.size)&&(k.value=!1,A.value=!0,U())},B=e=>{var l,i,n,c;for(const d of a.field.options.returnParams??[]){let o=e[d.paramName]??null,D=d.fieldId;const t=u.matchField(d.fieldId);if(d.paramType===v.array&&((l=t==null?void 0:t.parentField)==null?void 0:l.type)===se.subform){const E=t==null?void 0:t.parentField.field;o=W(o),D=t==null?void 0:t.parentField.fieldId,o=o.map((Q,X)=>E.fields.reduce((q,V)=>({...q,[V.fieldId]:(d.fieldId===V.fieldId?Q:u.getFieldVal(V.fieldId,X))??null}),{}))}else if(d.paramType===v.arrayObject&&(t==null?void 0:t.field.type)===se.subform){const E=t==null?void 0:t.field;o=W(o),o=o.map(Q=>E.fields.reduce((X,q)=>{var ie,te;const V=(te=(ie=d.child)==null?void 0:ie.find(ce=>ce.fieldId===q.fieldId))==null?void 0:te.paramName,ue=V?Q[V]:null;return{...X,[q.fieldId]:ue}},{}))}u.setFieldVal(D,o,a.index!=null&&((i=t==null?void 0:t.parentField)==null?void 0:i.fieldId)===((c=(n=u.matchField(a.field.fieldId))==null?void 0:n.parentField)==null?void 0:c.fieldId)?a.index:void 0)}},N=y(!1),r=y(!1),b=y(!1),K=S(()=>W(h.value[a.field.options.optionsKey])),O=S(()=>a.field.options.displayType===f.searchDrop&&a.field.options.searchWay===G.btn),z=S(()=>a.field.options.displayType!==f.searchDrop?!1:p.value.length<(a.field.options.minNum??0)||g.value.size?!0:b.value?!!(O.value&&!r.value):!a.field.options.preload),Y=e=>{N.value=e,e||(b.value=!1)},Z=e=>{r.value=!1,b.value=!0,re(()=>{p.value=e.trim(),N.value&&a.field.options.searchWay===G.realtime&&p.value.length>=(a.field.options.minNum??0)&&_()})},T=S(()=>!!(g.value.size||p.value.length<(a.field.options.minNum??0))),$=e=>{const l=K.value.find(i=>i[a.field.options.optionsLabelKey]===e);l&&B(l)},j=()=>{T.value||(r.value=!0,b.value=!0,re(()=>{_()}))},R=y(!0);return he(P,(e,l)=>{me(e,l)||(R.value=!0)}),ve(()=>{a.field.options.displayType===f.drop&&N.value&&R.value&&(_(),R.value=!1),a.field.options.displayType===f.searchDrop&&N.value&&!b.value&&!z.value&&R.value&&(_(),R.value=!1)}),{searchId:m,unpreparedIds:g,disabled:H,render:u,searchStr:p,params:P,loading:A,pluginCall:_,fill:B,callResult:h,options:K,btnSearchDisabled:T,btnSearchSignal:r,handleVisibleChange:Y,handleFilter:Z,hidePopper:z,handleSelected:$,isSearchDropAndBtnSearch:O,error:k,isRunCall:b,handleBtnSearch:j}}const we=_e({__name:"PluginBase",props:{field:{},isRender:{type:Boolean},index:{}},setup(a){const m=a,{maxWidthStyle:u}=Ve(m.field),{disabled:p,loading:k,error:A,pluginCall:h,options:w,btnSearchDisabled:x,handleVisibleChange:L,handleFilter:P,hidePopper:g,handleSelected:H,isSearchDropAndBtnSearch:U,handleBtnSearch:_}=Ae(m),B=y(),N=()=>{var r;x.value||((r=B.value)==null||r.focus(),_())};return(r,b)=>{const K=ke,O=De,z=Pe,Y=Be,Z=Ne;return C(),J("div",{class:"plugin_base"},[r.field.options.displayType===s(f).btn?(C(),ee(K,{key:0,onClick:s(h),loading:s(k),disabled:s(p),type:"primary"},{default:F(()=>[le(ae(r.field.options.btnName),1)]),_:1},8,["onClick","loading","disabled"])):(C(),ee(Z,Fe({key:1},r.$attrs,{class:["w100",{plugin_select:r.field.options.displayType===s(f).searchDrop&&r.field.options.searchWay===s(G).btn}],ref_key:"pluginSelectRef",ref:B,style:s(u),placeholder:r.field.options.placeholder,disabled:s(p),onVisibleChange:s(L),loading:s(k),filterable:r.field.options.displayType===s(f).searchDrop,"filter-method":s(P),"popper-class":s(g)?"select-dropdown-hide plugin_select_popper":"plugin_select_popper",onChange:s(H),clearable:""}),be({default:F(()=>[(C(!0),J(oe,null,de(s(w),(T,$)=>(C(),ee(O,{key:$,label:T[r.field.options.optionsLabelKey],value:T[r.field.options.optionsLabelKey]},{default:F(()=>[M("div",null,[M("div",null,ae(T[r.field.options.optionsLabelKey]),1),(C(!0),J(oe,null,de(r.field.options.optionsOtherLabelKey,j=>(C(),J("div",{key:j,class:"plugin_select-tip"},ae(T[j]),1))),128))])]),_:2},1032,["label","value"]))),128))]),_:2},[s(A)?{name:"empty",fn:F(()=>[M("div",{class:"plugin-call-fail"},[le(" 调用失败， "),ne(z,{type:"danger",underline:!1,onClick:s(h)},{default:F(()=>[le(" 点击重新调用 ")]),_:1},8,["onClick"])])]),key:"0"}:void 0,s(U)?{name:"prefix",fn:F(()=>[M("div",{class:Se(["select_prepend",{"is-disabled":s(x)}]),onClick:Ce(N,["stop"])},[ne(Y,null,{default:F(()=>[ne(s(Te))]),_:1})],10,["onClick"])]),key:"1"}:void 0]),1040,["class","style","placeholder","disabled","onVisibleChange","loading","filterable","filter-method","popper-class","onChange"]))])}}});const We=Ee(we,[["__scopeId","data-v-7629fc5d"]]);export{We as P};
