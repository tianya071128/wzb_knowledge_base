import{Z as Ie,d as we,gK as Le,er as Be,c as h,R as qe,d_ as ae,y as Ke,aT as D,iM as De,gM as $,r as Me,o as s,f as F,i as u,w as p,F as E,g as w,B as c,m as M,a5 as P,l as V,Y as te,U as Pe,bm as Re,k as je,b,H as A,n as R,a3 as re,bt as ze,e0 as ne,cj as He,aq as We,a4 as Ye,dS as Ze,gS as j,iN as Ge,h1 as se,b_ as de,a8 as Je,a as Qe,ao as Xe,ac as xe,ap as el,P as ll,av as ol,_ as al}from"./index-b80d5ef5.js";import{b as ie,c as tl,S as m}from"./SelectEntryAndOther-76a65b2d.js";import{m as rl}from"./Base.vue_vue_type_script_setup_true_lang-03820366.js";function nl(){const U=new WeakMap;return O=>{if(U.get(O))return U.get(O);const a=Ie();return U.set(O,a),a}}const sl=we({__name:"FieldCondition",props:{condition:{},appId:{},fields:{},sourceId:{},conditionForm:{},onlyControlField:{type:Boolean},compareForm:{},compareFields:{},conditionPlaceholder:{default:"选择控件"},isConditionSubField:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},isDataType:{type:Boolean,default:!1},mode:{default:Le.condition},controlTypeFieldName:{},customControlOptions:{default:()=>[]},operateFilter:{},conditionSources:{}},emits:["update:condition"],setup(U,{expose:z,emit:O}){var x;const a=U,ue=O,{getFieldInfo:ce}=Be(),L=h(()=>Array.isArray(a.conditionForm)),B=h(()=>Array.isArray(a.conditionSources)),H=h(()=>Array.isArray(a.compareForm)),W=h(()=>a.compareForm||a.compareFields),Y=h(()=>!a.onlyControlField),Z=["cn","leftFieldSource","leftTableName","dataType","leftSubTableName","leftFieldType","leftFieldName","type","controlType","rightTableName","rightFieldType","rightFieldName","value"],v=(e,l,o)=>{const n=Z.findIndex(C=>C===l),i=Z.slice(0,n+1),T={...q.value};for(const[C,S]of Object.entries(e)){const _=C;i.includes(_)&&_ in e?o[_]=S:o[_]=T[_]}},f=qe(a,"condition",ue),G=nl(),q=h(()=>{const e={cn:ae.and};return!Array.isArray(a.conditionForm)&&a.conditionForm&&(e.leftTableName=a.conditionForm),!Array.isArray(a.conditionSources)&&a.conditionSources&&(e.leftTableName=a.conditionSources.id,e.leftFieldSource=a.conditionSources.type),e});Ke(f,()=>{f.value||I()}),(x=a.condition)!=null&&x.length||D(()=>{I()});const I=()=>{var e;Array.isArray(f.value)||(f.value=[]),(e=f.value)==null||e.push({cn:ae.or,conditionSets:[te(q.value)]})},pe=e=>{var l,o,n;(n=(o=(l=f.value)==null?void 0:l[e])==null?void 0:o.conditionSets)==null||n.push(te(q.value))},fe=(e,l)=>{var o,n,i,T,C,S;(i=(n=(o=f.value)==null?void 0:o[l])==null?void 0:n.conditionSets)==null||i.splice(e,1),((S=(C=(T=f.value)==null?void 0:T[l])==null?void 0:C.conditionSets)==null?void 0:S.length)===0&&f.value.splice(l,1)},ye=(e,l)=>{v(e[l],"leftTableName",e[l])},me=e=>e.leftTableName?{type:e.leftFieldSource??m.entry,id:e.leftTableName}:void 0,ge=async(e,l,o)=>{await D(),v({...l[o],leftTableName:e.id,leftFieldSource:e.type},"leftTableName",l[o])},Fe=e=>({fieldId:e.leftFieldName,fieldType:e.leftFieldType,entryId:e.leftFieldSource===m.aggregation?void 0:e.leftTableName,aggregateId:e.leftFieldSource===m.aggregation?e.leftTableName:void 0}),Te=async(e,l,o)=>{await D();const n={...l[o],leftFieldName:e==null?void 0:e.fieldId,leftFieldType:e==null?void 0:e.fieldType,dataType:e==null?void 0:e.dataType,leftSubTableName:e.leftSubTableName?Ze(e.leftSubTableName).fieldId:void 0};(e.entryId||e.aggregateId)&&(n.leftTableName=e.entryId||e.aggregateId),v(n,"leftFieldName",l[o])},he=h(()=>{const e={fieldId:"fieldId",fieldType:"fieldType",entryId:"entryId",aggregateId:"aggregateId",subformId:"leftSubTableName"};return a.isDataType&&(e.dataType="dataType"),e}),J=(e,l)=>{let o={id:"",type:m.entry};return B.value?o={id:e.leftTableName??"",type:e.leftFieldSource===m.aggregation?m.aggregation:m.entry}:L.value?o={id:e.leftTableName??"",type:m.entry}:!H.value&&!B.value&&(j(a.conditionForm).length?o.id=R(a.conditionForm)[0]:j(a.conditionSources).length&&(o=R(a.conditionSources)[0])),o.id&&(o==null?void 0:o.type)===l?o.id:void 0},N=e=>e.leftFieldName?ce(e.leftFieldName,{entryId:e.leftFieldSource===m.aggregation?void 0:e.leftTableName,aggregateId:e.leftFieldSource===m.aggregation?e.leftTableName:void 0,fields:a.fields}):null,be=e=>{const l=N(e);let o=Ge(a.mode,l);return se(a.operateFilter)&&(o=a.operateFilter(o,l??void 0)),o},Ce=(e,l)=>{v(e[l],"type",e[l])},k=h(()=>[...De,...a.customControlOptions??[]].map(e=>({...e,label:e.value===$.field&&a.controlTypeFieldName?a.controlTypeFieldName:e.label})).filter(e=>!(e.value===$.custom&&!Y.value||e.value===$.field&&!W.value))),Q=h(()=>k.value.length>1),Se=(e,l)=>{v(e[l],"controlType",e[l])},ve=e=>{var n;const l=N(e);if(!l||!e.type)return k.value;const o=(n=de(l.field.type,"controlValutType"))==null?void 0:n[e.type];return Array.isArray(o)?k.value.filter(i=>o.includes(i.value)):k.value},Ne=(e,l)=>l.filter(o=>o.id!==e.leftTableName),_e=(e,l)=>{v(e[l],"rightTableName",e[l])},Ve=e=>W.value?Y.value?e.controlType===$.field:!0:!1,ke=(e,l)=>{const o=N(e);let n;if(o){const i=de(o.field.type,"compareFieldType");se(i)?n=i(e.type):n=i??null}return Je(l,{blockFilter(i){return i.type===Qe.subform},excludeFilter(i,T){return!n&&!(T!=null&&T.isCondition)||!!(n&&!n.includes(i.type))}})},$e=h(()=>{const e={fieldId:"rightFieldName",fieldType:"rightFieldType",entryId:"rightTableName"};return a.isDataType&&(e.dataType="dataType"),e}),Ee=e=>L.value?e.rightTableName:j(a.compareForm)[0],Ue=async(e,l,o)=>{v(e,"rightFieldName",l[o])},Oe=e=>!e.type||!N(e)?!1:k.value.length===1&&k.value[0].value===$.custom?!0:e.controlType===$.custom,Ae=e=>{const l=N(e);return(l==null?void 0:l.field.type)&&rl(l==null?void 0:l.field.type)},X=Me();return z({validate(){var e;return(e=X.value)==null?void 0:e.validate()}}),(e,l)=>{var ee;const o=Xe,n=xe,i=el,T=ll,C=ol,S=Pe,_=Re;return s(),F("div",{class:"field_condition"},[u(_,{ref_key:"ruleFormRef",ref:X,model:c(f),disabled:e.disabled,"show-message":!1},{default:p(()=>[(s(!0),F(E,null,w(c(f),(y,g)=>{var le,oe;return s(),F(E,{key:c(G)(y)},[je("div",{class:"condition-wrapper"},[(s(!0),F(E,null,w(y.conditionSets,(t,d)=>(s(),F("div",{class:"condition-and",key:c(G)(t)},[L.value?(s(),b(A,{key:0,class:"condition-field",hideLabel:"",prop:`${g}.conditionSets.${d}.leftTableName`,required:""},{default:p(()=>[u(ie,{modelValue:t.leftTableName,"onUpdate:modelValue":r=>t.leftTableName=r,appId:e.appId,entryList:Array.isArray(a.conditionForm)?a.conditionForm:void 0,onChange:r=>ye(y.conditionSets,d),placeholder:"选择条件表单"},null,8,["modelValue","onUpdate:modelValue","appId","entryList","onChange"])]),_:2},1032,["prop"])):V("",!0),B.value?(s(),b(A,{key:1,class:"condition-field",hideLabel:"",prop:`${g}.conditionSets.${d}.leftTableName`,required:""},{default:p(()=>[u(tl,{modelValue:me(y.conditionSets[d]),"onUpdate:modelValue":r=>ge(r,y.conditionSets,d),sources:c(R)(e.conditionSources),placeholder:"选择条件表单"},null,8,["modelValue","onUpdate:modelValue","sources"])]),_:2},1032,["prop"])):V("",!0),u(A,{class:"condition-field",hideLabel:"",prop:`${g}.conditionSets.${d}.leftFieldName`,required:""},{default:p(()=>[u(re,{modelValue:Fe(y.conditionSets[d]),"onUpdate:modelValue":r=>Te(r,y.conditionSets,d),prop:he.value,placeholder:e.conditionPlaceholder,"entry-id":J(t,c(m).entry),aggregateId:J(t,c(m).aggregation),sourceId:e.sourceId,fields:e.fields,"is-separate":!!e.sourceId,"is-condition":"",isConditionSubField:e.isConditionSubField},null,8,["modelValue","onUpdate:modelValue","prop","placeholder","entry-id","aggregateId","sourceId","fields","is-separate","isConditionSubField"])]),_:2},1032,["prop"]),u(n,{class:"condition-operate",prop:`${g}.conditionSets.${d}.type`,required:""},{default:p(()=>[u(ze,{modelValue:t.type,"onUpdate:modelValue":r=>t.type=r,placeholder:"判断符",onChange:r=>Ce(y.conditionSets,d)},{default:p(()=>[(s(!0),F(E,null,w(be(t),(r,K)=>(s(),b(o,{key:K,label:r.label,value:r.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop"]),!t.type||![c(ne).empty,c(ne).noEmpty].includes(t.type)?(s(),F(E,{key:2},[Q.value?(s(),b(n,{key:0,class:"condition-field",prop:`${g}.conditionSets.${d}.controlType`,required:""},{default:p(()=>[u(i,{modelValue:t.controlType,"onUpdate:modelValue":r=>t.controlType=r,placeholder:"选择比较类型",class:"w100",onChange:r=>Se(y.conditionSets,d)},{default:p(()=>[(s(!0),F(E,null,w(ve(t),(r,K)=>(s(),b(o,{key:K,label:r.label,value:r.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop"])):V("",!0),H.value?(s(),b(A,{class:"condition-field",hideLabel:"",prop:`${g}.conditionSets.${d}.rightTableName`,key:"rightTableName",required:""},{default:p(()=>[u(ie,{modelValue:t.rightTableName,"onUpdate:modelValue":r=>t.rightTableName=r,entryList:Array.isArray(a.compareForm)?a.compareForm:void 0,filter:r=>Ne(t,r),onChange:r=>_e(y.conditionSets,d),placeholder:"选择比较表单"},null,8,["modelValue","onUpdate:modelValue","entryList","filter","onChange"])]),_:2},1032,["prop"])):V("",!0),Ve(t)?(s(),b(A,{class:"condition-compare",hideLabel:"",prop:`${g}.conditionSets.${d}.rightFieldName`,key:"rightFieldName",required:""},{default:p(()=>[u(re,{class:"w100",modelValue:y.conditionSets[d],"onUpdate:modelValue":r=>Ue(r,y.conditionSets,d),prop:$e.value,placeholder:"选择比较控件","entry-id":Ee(t),fields:e.compareFields,filter:r=>ke(t,r)},null,8,["modelValue","onUpdate:modelValue","prop","entry-id","fields","filter"])]),_:2},1032,["prop"])):Oe(t)?(s(),b(He(Ae(t)),{operate:t.type,"model-value":t.value,"onUpdate:modelValue":r=>t.value=r,prop:`${g}.conditionSets.${d}.value`,fieldInfo:N(t),class:"condition-compare",key:`${t.type}.value`,mode:e.mode},null,8,["operate","model-value","onUpdate:modelValue","prop","fieldInfo","mode"])):e.customControlOptions.some(r=>r.value===t.controlType)?(s(),F("div",{key:4,class:"condition-compare"})):(s(),b(We,{key:5,readonly:"",class:"condition-compare",placeholder:Q.value&&!t.controlType?"请先选择比较类型":t.type?t.leftFieldName&&!N(t)?"控件被删除":"请输入":"请先选择判断符"},null,8,["placeholder"]))],64)):V("",!0),u(C,{class:"condition-delete",disabled:e.disabled,type:"danger",onClick:r=>fe(d,g),underline:!1},{default:p(()=>[u(T,{title:"删除"},{default:p(()=>[u(c(Ye))]),_:1})]),_:2},1032,["disabled","onClick"])]))),128)),u(S,{icon:c(P),onClick:t=>pe(g)},{default:p(()=>[M("且条件")]),_:2},1032,["icon","onClick"])]),(le=c(f))!=null&&le.length&&g!==((oe=c(f))==null?void 0:oe.length)-1?(s(),F("div",{key:0,class:"condition-or"}," 或 ")):V("",!0)],64)}),128))]),_:1},8,["model","disabled"]),(ee=c(f))!=null&&ee.length?V("",!0):(s(),F("div",{key:0,class:"condition-wrapper"},[u(S,{icon:c(P),onClick:I},{default:p(()=>[M("且条件")]),_:1},8,["icon"])])),u(S,{icon:c(P),class:"mt-15",onClick:I},{default:p(()=>[M("或条件")]),_:1},8,["icon"])])}}});const cl=al(sl,[["__scopeId","data-v-e29c0f01"]]);export{cl as F,nl as u};
