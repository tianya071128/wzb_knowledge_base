import{d as q,v as H,c as V,jM as g,r as c,Y as T,y as Q,gS as L,z as j,a9 as W,o as y,b as C,w as n,k as K,i as l,m as z,L as X,bt as Z,B as S,z8 as O,f as $,F as ee,g as ae,H as x,l as U,C as oe,z9 as te,aa as le,za as ne,aN as M,Q as se,ac as re,ao as ue,bm as ie,U as P,bn as de,aY as pe,aV as ce,bi as me,bs as fe,gF as ve,gG as ge,zb as _e,_ as ye}from"./index-b80d5ef5.js";import{_ as he}from"./SelectCascaderEntry.vue_vue_type_script_setup_true_lang-673c5dca.js";import{C as be}from"./ConditionWrapper-43da1676.js";import{F as Ie}from"./FieldConditionView-ad1b057c.js";import{_ as we}from"./TableOperation.vue_vue_type_script_setup_true_lang-4afbb2cb.js";import"./AzCascader.vue_vue_type_style_index_0_lang-adc6a4ab.js";import"./FieldCondition-1c72aa9d.js";import"./SelectEntryAndOther-76a65b2d.js";import"./Base.vue_vue_type_script_setup_true_lang-03820366.js";import"./useFieldMaxWidth-d82f063e.js";import"./AddressBase.vue_vue_type_script_setup_true_lang-d809ffc6.js";import"./AzDatePicker.vue_vue_type_style_index_0_lang-c5632a92.js";import"./index-318b68f4.js";import"./AzInputNumber-d6212644.js";import"./el-input-number-c15b1cc7.js";import"./AzTimePicker.vue_vue_type_style_index_0_lang-3726374e.js";import"./useMultipleVal-904406c1.js";import"./CascaderBase.vue_vue_type_style_index_0_lang-83862970.js";import"./el-dropdown-item-455a6589.js";import"./CardShowFieldItem-fd24f218.js";import"./ButtonState-cb54910b.js";const Se=q({__name:"AddAndEditSourece",props:{modelValue:{type:Boolean},appId:{},soureceId:{}},emits:["update:modelValue","submit"],setup(A,{emit:k}){const i=A,m=k,u=H(i,"modelValue",m),h=V(()=>i.soureceId?"编辑数据集":"新增数据集"),b={appId:"",source:g.form,name:"",entryIds:[],showJson:[]},e=c(T(b)),J=c(),D=async()=>{if(i.soureceId){const o=await te(i.soureceId);e.value=o;try{e.value.showJson=JSON.parse(e.value.showJson)}finally{e.value.showJson||(e.value.showJson=T(b.showJson))}e.value.entryIds=e.value.entryIds.map(a=>typeof a=="string"?{appId:i.appId,entryId:a,type:0}:{...a})}else e.value=T(b)};Q(u,async()=>{var o;u.value&&((o=J.value)==null||o.reload())},{immediate:!0});const d=V(()=>e.value.entryIds.map(o=>o.entryId)),E={name:[{required:!0,message:"请输入数据集名称",trigger:"blur"}],source:[{required:!0,message:"请选择数据集类型",trigger:"change"}],entryIds:[{required:!0,message:"请选择关联表单",trigger:"change"},{validator:(o,a,s)=>{var r;e.value.source===g.linkForm&&e.value.entryIds.length<2?s(new Error("多表单类型时，至少需要选择两个表单！")):(s(),e.value.showJson.length>0&&((r=v.value)==null||r.validateField("showJson")))},trigger:"change"}],showJson:[{required:!0,message:"请设置关联条件",trigger:"change"},{validator:(o,a,s)=>{const r=new Set(d.value);for(const N of e.value.showJson)for(const _ of N.joinSets)_.leftTableName&&r.delete(_.leftTableName),_.rightTableName&&r.delete(_.rightTableName);r.size?s(new Error("关联条件中必须包含所有的关联表单！")):s()},trigger:"change"}]},I=V({get(){return e.value.source===g.form?e.value.entryIds[0]:e.value.entryIds},set(o){e.value.entryIds=L(o).filter(a=>a.entryId)}});j(()=>{e.value.source===g.form&&(e.value.entryIds=L(e.value.entryIds[0]))});const f=V({get(){const o=[];for(const a of e.value.showJson)o.push({cn:a.cn,conditionSets:a.joinSets});return o},set(o){const a=[];for(const s of o)a.push({cn:s.cn,joinSets:s.conditionSets});e.value.showJson=a}});j(()=>{const o=[];for(const a of e.value.showJson){const s={cn:a.cn,joinSets:a.joinSets.filter(r=>d.value.includes(r.leftTableName??"")&&d.value.includes(r.rightTableName??""))};s.joinSets.length&&o.push(s)}W(o,e.value.showJson)||(e.value.showJson=o)});const t=c(!1),v=c(),F=async()=>{var o;await((o=v.value)==null?void 0:o.validate()),i.soureceId&&await le.confirm("若数据集已被使用，需谨慎修改，以防数据引用出现错误。若未被使用，可忽略此提示。","提示",{confirmButtonText:"知道了",cancelButtonText:"取消",type:"info"}),t.value=!0;try{await ne({...e.value,showJson:JSON.stringify(e.value.showJson),appId:i.appId}),m("submit"),u.value=!1,M.success(`${h.value}成功`)}finally{t.value=!1}};return(o,a)=>{const s=se,r=re,N=ue,_=ie,B=P,G=de;return y(),C(G,{modelValue:S(u),"onUpdate:modelValue":a[5]||(a[5]=w=>oe(u)?u.value=w:null),title:h.value,width:"600","close-on-click-modal":!1,"append-to-body":""},{footer:n(()=>[K("span",{class:"dialog-footer"},[l(B,{onClick:a[4]||(a[4]=w=>u.value=!1)},{default:n(()=>[z("取消")]),_:1}),l(B,{type:"primary",onClick:F,loading:t.value},{default:n(()=>[z(" 确定 ")]),_:1},8,["loading"])])]),default:n(()=>[l(X,{load:D,ref_key:"LoadingDataRef",ref:J},{default:n(()=>[l(_,{model:e.value,rules:E,"label-width":"100px","label-position":"left",ref_key:"ruleFormRef",ref:v},{default:n(()=>{var w;return[l(r,{label:"数据集名称",prop:"name"},{default:n(()=>[l(s,{modelValue:e.value.name,"onUpdate:modelValue":a[0]||(a[0]=p=>e.value.name=p),placeholder:"请输入数据集名称"},null,8,["modelValue"])]),_:1}),l(r,{label:"数据集类型",prop:"source"},{default:n(()=>[l(Z,{modelValue:e.value.source,"onUpdate:modelValue":a[1]||(a[1]=p=>e.value.source=p),placeholder:"请选择",class:"w100",load:S(O)},{default:n(({options:p})=>[(y(!0),$(ee,null,ae(p,(R,Y)=>(y(),C(N,{key:Y,label:R.label,value:R.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","load"])]),_:1}),l(x,{label:"关联表单",tip:"可选的范围为普通表单/流程表单/引入表单",prop:"entryIds"},{default:n(()=>[l(he,{modelValue:I.value,"onUpdate:modelValue":a[2]||(a[2]=p=>I.value=p),"app-id":o.appId,"is-type":"",class:"w100",hideCurrentAppId:e.value.source===S(g).form,multiple:e.value.source===S(g).linkForm,clearable:""},null,8,["modelValue","app-id","hideCurrentAppId","multiple"])]),_:1}),e.value.source===S(g).linkForm&&d.value.length>=2?(y(),C(x,{key:0,label:"关联条件",prop:"showJson"},{default:n(()=>[l(be,{condition:f.value,"onUpdate:condition":a[3]||(a[3]=p=>f.value=p),"condition-form":d.value,"compare-form":d.value,"app-id":o.appId,"btn-disabled":d.value.length<2,"only-control-field":""},null,8,["condition","condition-form","compare-form","app-id","btn-disabled"])]),_:1})):U("",!0),(w=f.value)!=null&&w.length?(y(),C(x,{key:1,label:""},{default:n(()=>[l(Ie,{class:"w100",condition:f.value,"app-id":o.appId,isConditionForm:""},null,8,["condition","app-id"])]),_:1})):U("",!0)]}),_:1},8,["model"])]),_:1},512)]),_:1},8,["modelValue","title"])}}}),Ve=q({__name:"SetDataSourece",setup(A){pe();const k=ce(),i=V(()=>k.query.appId??""),m=c(!1),u=c(null),h=c(),b=async()=>await ve({appId:i.value,type:ge.otherApp}),e=t=>[{type:"primary",text:"编辑",onClick:()=>D(t)},{type:"danger",text:"删除",popconfirmProps:{title:"您确定要删除该数据集吗?",confirm:()=>d(t)}}],J=()=>{u.value=null,m.value=!0},D=t=>{u.value=t.id,m.value=!0},d=async t=>{await _e(t.id),M.success("删除成功"),f()},E={request:{api:b},table:{tableCols:[{prop:"name",label:"名称",showOverflowTooltip:!0},{prop:"source",label:"数据集来源",showOverflowTooltip:!0,slots:{default({row:t}){return l("span",null,[fe(t.source,O)])}}},{fixed:"right",width:200,label:"操作",slots:{default({row:t}){return l(we,{num:3,rowId:t.id,list:e(t)},null)}}}]},operation:{fullEl:h},pagination:{hidePagination:!0}},I=c(),f=()=>{var t;(t=I.value)==null||t.refresh()};return(t,v)=>{const F=P,o=me("az-page");return y(),$("div",{class:"layout_box",ref_key:"pendingRef",ref:h},[l(o,{ref_key:"azPageRef",ref:I,config:E},{operation:n(()=>[l(F,{type:"primary",onClick:J},{default:n(()=>[z(" 添加数据集 ")]),_:1})]),_:1},512),l(Se,{modelValue:m.value,"onUpdate:modelValue":v[0]||(v[0]=a=>m.value=a),"app-id":i.value,"sourece-id":u.value,onSubmit:f},null,8,["modelValue","app-id","sourece-id"])],512)}}});const Ge=ye(Ve,[["__scopeId","data-v-efeeec6d"]]);export{Ge as default};
