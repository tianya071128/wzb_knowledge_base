import{bd as pe,aN as q,d8 as me,b5 as X,d as ge,v as G,c as h,n as I,x as fe,r as _,y as ye,a$ as N,iI as ve,o as s,f as u,k as x,i as r,w as n,F as S,g as L,B as g,jM as $,b as T,j,t as A,l as O,m as w,L as _e,e as ke,S as Ie,p as Se,a2 as be,I as he,fx as we,Y as H,aT as Ce,a9 as K,av as De,ac as Ee,bm as Ve,ba as $e,U as Te,Q as je,bn as Ae,p1 as Be,_ as Fe}from"./index-b80d5ef5.js";import{S as Pe}from"./SelectDataSourece-70a968c3.js";function U(i,o){var t,d;const c=(d=(t=me.value).matchLogoPath)==null?void 0:d.call(t,i);if(typeof c=="string"){const f=Object.entries((o==null?void 0:o.query)??{}).map(p=>`${p[0]}=${p[1]}`).join("&");return`${location.origin}${location.pathname}#${c}${f?"?"+f:""}`}}function Ne(i){const{appId:o,entryId:c,target:t}=i;if(t==="_blank"){const d=U(pe,{query:{appId:o,entryId:c,manager:i.manager}});d?window.open(d,"_blank"):q.error("跳转路径异常, 请检查")}}function xe(i){const{appId:o,target:c}=i;if(c==="_blank"){const t=U(X,{query:{appId:o,app_setting_menu:"data_list"}});t?window.open(t,"_blank"):q.error("跳转路径异常, 请检查")}}function Le(i){const{appId:o,target:c}=i;if(c==="_blank"){const t=U(X,{query:{appId:o,app_setting_menu:"aggregation_table"}});t?window.open(t,"_blank"):q.error("跳转路径异常, 请检查")}}const Oe=ge({inheritAttrs:!1,__name:"DataSoureceWrapper",props:{modelValue:{},aggregationId:{},appId:{},isTree:{type:Boolean},customSubmit:{},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},currentEntryId:{}},emits:["update:modelValue","update:aggregationId","change"],setup(i,{expose:o,emit:c}){const t=i,d=c,f=G(t,"modelValue",d),p=h(()=>I(f.value)),z=fe(),J=_(),C=G(t,"aggregationId",d),D=h(()=>I(C.value)),E=_([]),Z=async()=>{if(E.value=[],!D.value.length)return;const e=await Promise.all(D.value.map(a=>z.getAggregateInfo(a)));if(e.some(a=>a===null))return Promise.reject({msg:"聚合表不可使用，重新选择!",loadState:N.danger});E.value=e.filter(a=>!!a)},ee=()=>{Le({appId:t.appId,target:"_blank"})},V=_([]),B=_(),ae=async()=>{if(V.value=[],!p.value.length)return;const e=await Promise.all(p.value.map(a=>z.getSoureceData(a)));if(e.some(a=>a===null||t.isTree&&!Be(a)))return Promise.reject({msg:"数据集不可使用，重新选择!",loadState:N.danger});V.value=e.filter(a=>!!a)},te=async()=>{await Promise.all([ae(),Z()])};ye([p,D],()=>{var e,a;(a=(e=B.value)==null?void 0:e.reload)==null||a.call(e)});const k=_(!1),m=_(""),y=_(""),M=h(()=>p.value.length?"更改数据集":"选择数据集"),R=()=>{m.value=H(f.value),y.value=H(C.value),k.value=!0,Ce(()=>{var e;(e=J.value)==null||e.locationSource()})},le=async()=>{t.customSubmit&&(await t.customSubmit(m.value??""),k.value=!1),(!K(I(m.value),p.value)||!K(I(y.value),D.value))&&d("change",m.value??"",y.value??""),f.value=m.value,C.value=y.value,k.value=!1},ne=e=>{e.source===$.currentAppForm&&e.entryIds.length===1&&W(e.entryIds[0].appId,e.entryIds[0].entryId)},W=(e,a)=>{Ne({appId:e,entryId:a,manager:"1",target:"_blank"})},re=()=>{xe({appId:t.appId,target:"_blank"})},se=h(()=>{var e;return((e=B.value)==null?void 0:e.state)===N.danger}),oe=h(()=>"数据集不可使用");return ve(se,oe),o({exClick(){R()}}),(e,a)=>{const b=De,Q=Ee,ue=Ve,ie=$e,F=Te,ce=je,de=Ae;return s(),u(S,null,[x("div",{class:Se(["sourece_wrapper",e.$attrs.class]),style:be(e.$attrs.style)},[r(_e,{ref_key:"loadingDataRef",ref:B,load:te,class:"az-flex-width sourece_wrapper-loading"},{default:n(()=>[V.value.length||E.value.length?(s(),u(S,{key:0},[(s(!0),u(S,null,L(V.value,(l,P)=>(s(),u("div",{key:P},[l.source===g($).currentAppForm?(s(),T(b,{key:0,class:"sourece_wrapper-link",type:"primary",underline:!1,onClick:v=>ne(l)},{default:n(()=>[r(j,{class:"sourece-name"},{default:n(()=>{var v;return[x("span",null,A(l.name),1),t.currentEntryId&&((v=l.entryIds)==null?void 0:v.length)===1&&l.entryIds[0].entryId===t.currentEntryId?(s(),u("span",{key:0}," (当前表单) ")):O("",!0)]}),_:2},1024)]),_:2},1032,["onClick"])):[g($).form,g($).linkForm].includes(l.source)?(s(),T(ie,{key:1,placement:"bottom",width:200,trigger:"click"},{reference:n(()=>[r(b,{class:"sourece_wrapper-link",type:"primary",underline:!1},{default:n(()=>[r(j,{content:l.name,class:"sourece-name"},null,8,["content"])]),_:2},1024)]),default:n(()=>[r(ue,{"label-suffix":":","label-width":"60px"},{default:n(()=>[r(Q,{style:{"margin-bottom":"0"},label:"数据集"},{default:n(()=>[r(b,{type:"primary",underline:!1,onClick:re},{default:n(()=>[w(A(l.name),1)]),_:2},1024)]),_:2},1024),r(Q,{style:{"margin-bottom":"0"},label:"表单"},{default:n(()=>[(s(!0),u(S,null,L(l.forms,(v,Y)=>(s(),u(S,{key:Y},[r(b,{type:"primary",underline:!1,onClick:qe=>W(v.appId,v.entryId)},{default:n(()=>[w(A(v.name),1)]),_:2},1032,["onClick"]),Y!==l.forms.length-1?(s(),u("span",{key:0},"、")):O("",!0)],64))),128))]),_:2},1024)]),_:2},1024)]),_:2},1024)):(s(),T(j,{key:2,content:l.name,class:"sourece-name"},null,8,["content"]))]))),128)),(s(!0),u(S,null,L(E.value,(l,P)=>(s(),u("div",{key:P},[r(b,{class:"sourece_wrapper-link",type:"primary",underline:!1,onClick:ee},{default:n(()=>[r(j,{content:l.name,class:"sourece-name"},null,8,["content"])]),_:2},1024)]))),128))],64)):(s(),u("span",{key:1,class:"color2"},"没有选择数据集"))]),_:1},512),e.readonly?O("",!0):(s(),T(F,{key:0,type:"primary",text:"",onClick:R},{default:n(()=>[w(A(M.value),1)]),_:1})),ke(r(ce,{"model-value":`${JSON.stringify(g(f)??"")}.${JSON.stringify(g(C)??"")}`},null,8,["model-value"]),[[Ie,!1]])],6),r(de,{modelValue:k.value,"onUpdate:modelValue":a[3]||(a[3]=l=>k.value=l),title:M.value,width:"500",appendToBody:""},{footer:n(()=>[x("span",{class:"dialog-footer"},[r(F,{onClick:a[2]||(a[2]=l=>k.value=!1)},{default:n(()=>[w("取消")]),_:1}),r(F,{type:"primary",onClick:le,disabled:!g(I)(m.value).length&&!g(I)(y.value).length},{default:n(()=>[w(" 确定 ")]),_:1},8,["disabled"])])]),default:n(()=>[r(Pe,he({modelValue:m.value,"onUpdate:modelValue":a[0]||(a[0]=l=>m.value=l),"aggregation-id":y.value,"onUpdate:aggregationId":a[1]||(a[1]=l=>y.value=l),ref_key:"selectDataSoureceRef",ref:J,appId:e.appId,isTree:e.isTree,multiple:e.multiple,currentEntryId:e.currentEntryId},g(we)(e.$attrs,["class","style"])),null,16,["modelValue","aggregation-id","appId","isTree","multiple","currentEntryId"])]),_:1},8,["modelValue","title"])],64)}}});const Je=Fe(Oe,[["__scopeId","data-v-44c4e8fd"]]);export{Je as D};
