import{d as ce,hd as pe,x as ge,er as ye,r as b,c as g,y as Ie,a9 as R,a1 as H,Y as ve,n as W,h6 as he,bX as U,iL as _e,o as v,f as B,i as u,w as f,h as K,H as Y,aq as be,p as j,ad as q,b as w,B as S,c1 as Se,l as P,bc as me,iK as ke,k as $,dA as A,F as J,g as Q,aD as we,e as Fe,S as Ce,a as Be,a8 as Ee,h1 as Ve,by as Pe,P as $e,bm as Ae,ba as Le,Q as Me,_ as Ne}from"./index-b80d5ef5.js";import{S as y,c as ze}from"./SelectEntryAndOther-76a65b2d.js";const Te=ce({__name:"SelectFieldByMultEntry",props:{modelValue:{},entryInfo:{},placeholder:{default:"选择控件"},filter:{},filterOptions:{},width:{},disabled:{type:Boolean},prop:{default(){return{fieldId:"fieldId",entryId:"entryId",aggregateId:"aggregateId"}}},multiple:{type:Boolean},checkStrictly:{type:Boolean,default:!1},isSelectSubform:{type:Boolean},isCondition:{type:Boolean,default:!1},isSelect:{type:Boolean,default:!0},clearable:{type:Boolean,default:!1},isAll:{type:Boolean}},emits:["update:modelValue","change","clickField"],setup(X,{emit:G}){pe(e=>({b5520cbc:se.value}));const a=X,E=G,L=ge(),{checkField:Z}=ye(L),t=(e,l)=>e[a.prop[l]??""],r=b(),M=g(()=>a.entryInfo.entryIds?a.entryInfo.entryIds.map(e=>({id:e,type:y.entry})):a.entryInfo.sources);Ie(()=>ve(a.entryInfo),async(e,l)=>{var s;if(!R(e,l))if(e.entryIds&&!e.entryIds.includes(((s=r.value)==null?void 0:s.id)??""))r.value={id:e.entryIds[0]??"",type:y.entry};else if(e.appId&&e.appId!==(l==null?void 0:l.appId)){const I=(await L.getForm(e.appId)).filter(o=>o.type===H.form);r.value={id:I[0].id??"",type:y.entry}}else e.sources&&!e.sources.some(I=>{var o,p;return I.id===((o=r.value)==null?void 0:o.id)&&I.type===((p=r.value)==null?void 0:p.type)})&&(r.value=e.sources[0])},{immediate:!0});const c=g({get(){return W(a.modelValue).filter(e=>(t(e,"entryId")||t(e,"aggregateId"))&&t(e,"fieldId"))},set(e){const l=a.multiple?e:e==null?void 0:e[0];R(e,c.value)||(oe(),E("change",l)),E("update:modelValue",l)}}),N=g({get(){const e=c.value.filter(l=>{var s;if(((s=r.value)==null?void 0:s.type)===y.aggregation)return t(l,"aggregateId")===r.value.id;if(r.value)return t(l,"entryId")===r.value.id});return a.multiple?e:e[0]},set(e){const l=W(e);if(!a.multiple){c.value=[...l];return}const s=new Set(l.map(o=>t(o,"fieldId"))),I=new Set(c.value.filter(o=>{var p,h;return t(o,((p=r.value)==null?void 0:p.type)===y.aggregation?"aggregateId":"entryId")===((h=r.value)==null?void 0:h.id)}).map(o=>t(o,"fieldId")));c.value=[...c.value.filter(o=>{var p,h;return t(o,((p=r.value)==null?void 0:p.type)===y.aggregation?"aggregateId":"entryId")!==((h=r.value)==null?void 0:h.id)||s.has(t(o,"fieldId"))}),...l.filter(o=>!I.has(t(o,"fieldId")))]}}),i=g(()=>c.value.reduce((e,l)=>l?typeof l=="string"?[...e,{fieldId:l}]:[...e,...[{fieldId:t(l,"fieldId")??"",entryId:t(l,"entryId"),aggregateId:t(l,"aggregateId")},...(t(l,"child")??[]).map(s=>({fieldId:t(s,"fieldId")??"",entryId:t(s,"entryId"),aggregateId:t(s,"aggregateId")}))].filter(s=>!!s.fieldId)]:e,[])),_=g(()=>!!i.value.length),ee=e=>{c.value=[...c.value.filter(l=>(t(l,"entryId")??"")!==(t(e,"entryId")??"")||(t(l,"aggregateId")??"")!==(t(e,"aggregateId")??"")||(t(l,"fieldId")??"")!==(t(e,"fieldId")??""))]},le=()=>{c.value=[]},z=g(()=>{let e;return a.isCondition&&(e={blockFilter(l){return l.type===Be.subform},excludeFilter(l,s){return!(s!=null&&s.isCondition)}}),a.filterOptions&&(e=a.filterOptions),e}),te=e=>{let l=z.value?Ee(e,z.value):e;return Ve(a.filter)&&(l=a.filter(l)),l},F=b(!1),ae=g(()=>_.value?"":a.placeholder),re=he(),{width:T}=U(re),ne=g(()=>a.width?a.width:T.value>200?T.value:200),x=b(),{height:de}=U(x),se=g(()=>_.value?de.value+"px":null),V=b(),oe=()=>{var e;a.multiple||(e=V.value)==null||e.hide()},ie=e=>{var l;a.isSelect||((l=V.value)==null||l.hide(),E("clickField",e))},ue=e=>{if(a.disabled){e.stopPropagation(),e.stopImmediatePropagation();return}},C=b(!1),O=g(()=>a.clearable&&!a.disabled&&_.value&&C.value),D=b(!1);_e(C,()=>{D.value=!0});const fe=()=>{F.value=!0,i.value.length&&(i.value[0].entryId||i.value[0].aggregateId)&&(r.value={id:(i.value[0].aggregateId||i.value[0].entryId)??"",type:i.value[0].aggregateId?y.aggregation:y.entry})};return(e,l)=>{const s=Pe,I=$e,o=Ae,p=Le,h=Me;return v(),B("div",{class:"select_field",ref:"selectFieldRef",onMouseenter:l[3]||(l[3]=n=>C.value=!0),onMouseleave:l[4]||(l[4]=n=>C.value=!1)},[u(p,{ref_key:"elPopoverRef",ref:V,width:ne.value,trigger:"click",placement:"bottom","popper-class":"select_field-popover",transition:"el-zoom-in-top","hide-after":0,onBeforeEnter:fe,onBeforeLeave:l[2]||(l[2]=n=>F.value=!1)},{reference:f(()=>[K(e.$slots,"reference",{},()=>[u(o,{class:"reference-wrapper",onClick:ue},{default:f(()=>[u(Y,{"hide-label":"",class:"select-body w100 mb-0"},{default:f(()=>[u(be,{class:j(["reference-input az-input-prefix",{"reference-input-focus":F.value,"az-input-prefix":_.value}]),placeholder:ae.value,readonly:"",disabled:e.disabled},q({suffix:f(()=>[O.value?P("",!0):(v(),w(I,{key:0,class:j({"reference-icon":!0,"reference-icon-rotate":F.value})},{default:f(()=>[u(S(Se))]),_:1},8,["class"])),O.value?(v(),w(I,{key:1,onClick:me(le,["stop"])},{default:f(()=>[u(S(ke))]),_:1},8,["onClick"])):P("",!0)]),_:2},[_.value?{name:"prefix",fn:f(()=>{var n,m,k;return[$("div",{class:"select_field-prefix",ref_key:"fieldLabelWrapperRef",ref:x},[$("div",{class:"field-label-wrapper"},[e.multiple?(v(!0),B(J,{key:1},Q(i.value,d=>(v(),w(s,{key:`${d.entryId}.${d.fieldId}`,closable:"",type:S(Z)(d.fieldId,{entryId:d.entryId})?void 0:"danger",onClose:xe=>ee(d),class:"field-tag"},{default:f(()=>[u(A,{"field-id":(d==null?void 0:d.fieldId)??"",entryId:d==null?void 0:d.entryId,aggregateId:d==null?void 0:d.aggregateId,"include-sub-form-label":"","is-throw":"",isEntryName:""},null,8,["field-id","entryId","aggregateId"])]),_:2},1032,["type","onClose"]))),128)):(v(),w(A,{key:0,class:"field-label-radio color-text","field-id":((n=i.value[0])==null?void 0:n.fieldId)??"",entryId:(m=i.value[0])==null?void 0:m.entryId,aggregateId:(k=i.value[0])==null?void 0:k.aggregateId,"include-sub-form-label":"","is-throw":"",isEntryName:""},null,8,["field-id","entryId","aggregateId"]))])],512)]}),key:"0"}:void 0]),1032,["class","placeholder","disabled"])]),_:1})]),_:1})],!0)]),default:f(()=>[u(o,null,{default:f(()=>[u(Y,{"hide-label":"",class:"select-body"},{default:f(()=>{var n,m,k;return[e.entryInfo.appId||(((n=M.value)==null?void 0:n.length)??0)>1?(v(),B("div",{key:0,class:"select-form"},[u(ze,{modelValue:r.value,"onUpdate:modelValue":l[0]||(l[0]=d=>r.value=d),appId:e.entryInfo.appId,sources:M.value,teleported:!1,type:[S(H).form],placeholder:"切换表单"},null,8,["modelValue","appId","sources","type"])])):P("",!0),u(we,{modelValue:N.value,"onUpdate:modelValue":l[1]||(l[1]=d=>N.value=d),init:D.value,entryId:((m=r.value)==null?void 0:m.type)===S(y).entry?r.value.id:void 0,aggregateId:((k=r.value)==null?void 0:k.type)===S(y).aggregation?r.value.id:void 0,isSelect:e.isSelect,prop:a.prop,"max-height":250,filter:te,multiple:e.multiple,isSelectSubform:e.isSelectSubform,checkStrictly:e.checkStrictly,onClickField:ie,isAll:e.isAll},q({_:2},[e.$slots.fieldTip?{name:"fieldTip",fn:f(({field:d})=>[K(e.$slots,"fieldTip",{field:d},void 0,!0)]),key:"0"}:void 0]),1032,["modelValue","init","entryId","aggregateId","isSelect","prop","multiple","isSelectSubform","checkStrictly","isAll"])]}),_:3})]),_:3})]),_:3},8,["width"]),Fe($("div",null,[u(h,{"model-value":_.value?JSON.stringify(c.value):""},null,8,["model-value"]),(v(!0),B(J,null,Q(i.value,n=>(v(),w(A,{key:`${n.entryId}.${n.fieldId}`,"field-id":(n==null?void 0:n.fieldId)??"",entryId:n==null?void 0:n.entryId,aggregateId:n==null?void 0:n.aggregateId,"is-throw":""},null,8,["field-id","entryId","aggregateId"]))),128))],512),[[Ce,!1]])],544)}}});const Re=Ne(Te,[["__scopeId","data-v-45703dc1"]]);export{Re as S};
