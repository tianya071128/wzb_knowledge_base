import{cC as X,pz as T,x4 as z,x5 as Y,x6 as Z,x7 as W,aN as P,x8 as ee,x9 as le,xa as ae,xb as oe,d8 as ne,jG as ie,r as b,c as H,dW as x,n as te,xc as E,xd as se,xe as re,xf as de,e1 as $,xg as ue,xh as ce,xi as fe,d as ve,B as s,o as R,b as h,w as u,i as f,h7 as ge,k as pe,m as M,L as me,K as be,H as G,C as N,f as q,g as J,F as K,T as we,l as _e,ap as ye,ab as Fe,U as Ie,t as Re,ao as xe,E as Ce}from"./index-b80d5ef5.js";import{F as Ve}from"./FormItemFieldWrapper-ec4d2a36.js";import"./useValidateError-9f6399dc.js";function ke(l){let v,m="",o=null;const n=e=>{if((!e.handId||e.handId===m)&&(e._code_=="-1"||e._code_=="1")){if(i(),e._code_=="1")e._msg_&&(l.isMobile?W(e._msg_):P.success(e._msg_)),o==null||o.resolve(e);else if(e._code_=="-1")return e._msg_&&(l.isMobile?ee(e._msg_):P.error(e._msg_)),o==null?void 0:o.reject(e)}};function i(){T.off(z,n),clearTimeout(v),m&&le({handId:m})}let w=5;function g(e){v=setTimeout(()=>{var p;const c=ae.value.get(e);if(c&&c.close){o==null||o.reject("用户手动关闭弹窗"),i();return}w%5===0&&T.emit(oe,{toUserId:((p=ne.value.userInfo)==null?void 0:p.userId)??"",type:"3",handId:e}),g(e),w++},200)}async function y(e){return i(),m=e,o=Y(),Z({handId:e,isMobile:l.isMobile}),T.on(z,n),g(e),await o.promise}return X(()=>{i(),o==null||o.reject("组件销毁")}),{getPollingResult:y}}function Le(l,v){const{getPollingResult:m}=ke({isMobile:v.isMobile}),{errorCallback:o}=v,n=ie(),i=b([]),w=H(()=>n.matchField(l.options.fileFieleId)),g=H(()=>[x.edit,x.enter,x.preview,x.simple].includes(n==null?void 0:n.mode)),y=()=>{var d,t;if(!w.value){o("审查文件控件异常, 请联系管理员重新配置");return}if(i.value=te(n.getFieldVal(l.options.fileFieleId,void 0,{isFormat:!0})).filter(a=>[E.pdf,E.doc,E.docx].includes(se(a))),i.value.length>1){o("只支持审查单个文件");return}if(!i.value.length){o("待审查文件为空，审查文件只支持 pdf、doc、docx 文件");return}if(((d=l.options.legalReviewconfig)==null?void 0:d.numberEntryId)===n.entryId&&!n.getFieldVal(((t=l.options.legalReviewconfig)==null?void 0:t.numberFieldId)??"")){o("请先填写审查类型编号信息");return}e.value=!0},e=b(!1),c=b(""),p=b([]),C=b(3),k=[{label:"甲方立场",value:1},{label:"乙方立场",value:2},{label:"中立立场",value:3}],_=async()=>{var t,a,I,S,B,U,j;const d=(t=l.options.legalReviewconfig)==null?void 0:t.numberEntryId;if(d===n.entryId)c.value=n.getFieldVal(((a=l.options.legalReviewconfig)==null?void 0:a.numberFieldId)??"")??"",p.value=c.value?[{label:n.getFieldVal(((I=l.options.legalReviewconfig)==null?void 0:I.numberNameFieldId)??"")??"",value:c.value}]:[];else{const Q=await re({entryId:d,showField:[{fieldId:((S=l.options.legalReviewconfig)==null?void 0:S.numberFieldId)??""},{fieldId:((B=l.options.legalReviewconfig)==null?void 0:B.numberNameFieldId)??""}],conditions:de({condition:((U=l.options.legalReviewconfig)==null?void 0:U.numberFilter)??[],render:n}).conditionResult},1,100);p.value=Q.records.map(V=>{var O,A;return{label:$({fieldId:((O=l.options.legalReviewconfig)==null?void 0:O.numberNameFieldId)??"",rowData:V})??"",value:$({fieldId:((A=l.options.legalReviewconfig)==null?void 0:A.numberFieldId)??"",rowData:V})??""}}).filter(V=>!!V.value),c.value=((j=p.value[0])==null?void 0:j.value)??""}},r=b(!1),L=async d=>{r.value=!0;try{const t=await m(d.handlerId);let a=[];try{typeof t.data=="string"&&(a=JSON.parse(t.data))}catch{a=[]}if(!a.length){v.errorCallback("数据异常!");return}l.options.fileFillFieldId&&(await fe({entryId:n.entryId,file:a[0],prevFile:i.value[0],version:l.options.version,fieldId:l.options.fileFillFieldId}),n.setFieldVal(l.options.fileFillFieldId,a))}finally{r.value=!1}},F=b(!1);return{render:n,visible:e,handleStartReview:y,handleLoadReview:_,reviewType:c,reviewTypeOptions:p,reviewPosition:C,reviewPositionOptions:k,handleConfirm:async()=>{var d;F.value=!0;try{const t=await ue({contractTypeCode:c.value,files:i.value,standpoint:C.value,timeout:((d=l.options.legalReviewconfig)==null?void 0:d.expirationTime)??7,fieldParam:{entryIds:[n.entryId],fieldId:l.fieldId,tableData:n.packageNormlData()}});e.value=!1,t.url&&setTimeout(()=>{ce(t.url,{isMobile:v.isMobile,open:l.options.jumpType})},100),L(t)}finally{F.value=!1}},isShow:g,startLegalReviewLoading:F,pollingLoading:r}}const Me=ve({__name:"Render",props:{field:{}},setup(l){const v=l,{render:m,isShow:o,handleStartReview:n,visible:i,handleLoadReview:w,reviewType:g,reviewTypeOptions:y,reviewPosition:e,reviewPositionOptions:c,handleConfirm:p,startLegalReviewLoading:C,pollingLoading:k}=Le(v.field,{errorCallback(_){P.error(_)}});return(_,r)=>{const L=xe,F=ye,D=Ce,d=Fe,t=Ie;return s(o)?(R(),h(Ve,{key:0,field:_.field},{default:u(()=>[f(ge,{onClick:s(n),disabled:s(m).mode===s(x).preview,"model-value":_.field.options.btnConfig,loading:s(k),preview:""},null,8,["onClick","disabled","model-value","loading"]),f(we,{modelValue:s(i),"onUpdate:modelValue":r[3]||(r[3]=a=>N(i)?i.value=a:null),"append-to-body":"","destroy-on-close":"",title:"设置","close-on-click-modal":!1,width:"500px"},{footer:u(()=>[pe("span",{class:"dialog-footer"},[f(t,{onClick:r[2]||(r[2]=a=>i.value=!1)},{default:u(()=>[M("取消")]),_:1}),f(t,{type:"primary",disabled:!s(g),loading:s(C),onClick:s(p)},{default:u(()=>[M(" 确定 ")]),_:1},8,["disabled","loading","onClick"])])]),default:u(()=>[f(me,{load:s(w)},{default:u(()=>[f(be,{ref:"azFormRef"},{default:u(()=>[f(G,{label:"审查类型"},{default:u(()=>[f(F,{modelValue:s(g),"onUpdate:modelValue":r[0]||(r[0]=a=>N(g)?g.value=a:null),placeholder:"请选择"},{default:u(()=>[(R(!0),q(K,null,J(s(y),(a,I)=>(R(),h(L,{key:I,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),f(G,{label:"审查立场"},{default:u(()=>[f(d,{modelValue:s(e),"onUpdate:modelValue":r[1]||(r[1]=a=>N(e)?e.value=a:null)},{default:u(()=>[(R(!0),q(K,null,J(s(c),a=>(R(),h(D,{key:a.value,label:a.value},{default:u(()=>[M(Re(a.label),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},512)]),_:1},8,["load"])]),_:1},8,["modelValue"])]),_:1},8,["field"])):_e("",!0)}}});export{Me as default};
