import{d as O,c as w,k_ as H,r as z,bX as se,o as _,f as E,i as r,w as p,k as v,B as F,a5 as Y,m as T,F as P,g as q,b as C,j as Z,bz as ne,t as N,nf as re,l as D,P as de,U as J,q as K,br as ie,ba as ue,aU as ce,by as Q,_ as x,y as U,x as me,L as pe,a$ as fe,a9 as _e,a3 as Ie,rd as ve,er as W,aq as ee,e0 as G,ac as ge,bm as he,v as ye,bF as be,eu as ke,C as Ve,nz as Fe,Y as Se,av as we,c3 as Ee,Z as Ce,aN as Te,hP as $e,h as De,a2 as Oe,d_ as Me,dS as X}from"./index-b80d5ef5.js";import{E as Ue}from"./EditorDraggable-a06dbc71.js";/* empty css                          */import{u as te}from"./createDesigner-82222fc7.js";import{a as ze,b as xe}from"./Base.vue_vue_type_script_setup_true_lang-03820366.js";const Le=O({__name:"SelectDashboard",props:{modelValue:{},prop:{default(){return{moduleId:"moduleId",sourceId:"sourceId"}}}},emits:["update:modelValue"],setup(I,{emit:o}){const d=I,g=o,a=w(()=>{var u;return((u=d.modelValue)==null?void 0:u.map(n=>typeof n=="string"?{[d.prop.moduleId]:n}:{...n,__moduleId__:n[d.prop.moduleId],__sourceId__:n[d.prop.sourceId]}))??[]}),l=w({get(){return a.value.map(u=>u.__moduleId__)},set(u){g("update:modelValue",u.map(n=>{var S;const k=a.value.find(h=>h.__moduleId__===n)??{[d.prop.moduleId]:n,[d.prop.sourceId]:((S=t.value.find(h=>h.moduleId===n))==null?void 0:S.options.sourceId)??""};return delete k.__moduleId__,delete k.__sourceId__,k}))}}),e=te(),t=w(()=>e.getModulesByType([H.dashboard,H.detailedChart])),s=u=>{const n=t.value.find(S=>S.moduleId===u);if(!n)return{type:"danger",label:"该筛选图表已删除"};if(!n.options.sourceId)return{type:"danger",label:n.options.label,tip:"该筛选图表没有选择数据源, 请先修改图表"};const k=a.value.find(S=>S.__moduleId__===u);return n.options.sourceId!==(k==null?void 0:k.__sourceId__)?{type:"danger",label:n.options.label,tip:"该筛选图表的数据源已更改，无法进行筛选。请删除后重新添加"}:{label:n.options.label}},c=w(()=>new Map(l.value.map(u=>[u,s(u)]))),i=w({get(){return!!(t.value.length&&t.value.every(u=>l.value.includes(u.moduleId)))},set(u){l.value=u?t.value.map(n=>n.moduleId):[]}}),m=w(()=>!!(l.value.length&&!i.value)),b=u=>{const n=[...l.value];n.splice(u,1),l.value=[...n]},f=z(),{width:y}=se(f);return(u,n)=>{const k=de,S=J,h=K,L=ie,M=ue,le=ce,oe=Q;return _(),E("div",{class:"select_dashboard"},[r(M,{placement:"bottom",width:F(y),trigger:"click","popper-class":"select_dashboard-popover",transition:"el-zoom-in-top"},{reference:p(()=>[v("div",{ref_key:"addRef",ref:f},[r(S,{class:"w100 mb-10",effect:"light",round:""},{default:p(()=>[r(k,{class:"mr-5"},{default:p(()=>[r(F(Y))]),_:1}),T(" 组件 ")]),_:1})],512)]),default:p(()=>[r(h,{modelValue:i.value,"onUpdate:modelValue":n[0]||(n[0]=V=>i.value=V),class:"select_dashboard-checkbox",indeterminate:m.value},{default:p(()=>[T(" 全选 ")]),_:1},8,["modelValue","indeterminate"]),r(L,{modelValue:l.value,"onUpdate:modelValue":n[1]||(n[1]=V=>l.value=V)},{default:p(()=>[(_(!0),E(P,null,q(t.value,V=>(_(),C(h,{class:"select_dashboard-checkbox",key:V.moduleId,label:V.moduleId},{default:p(()=>[r(Z,{class:"w100",content:V.options.label},null,8,["content"])]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["width"]),(_(!0),E(P,null,q(l.value,(V,ae)=>{var R;return _(),C(oe,{key:V,type:(R=c.value.get(V))==null?void 0:R.type,class:"select_dashboard-tag",effect:"light",round:"",size:"large",closable:"",onClose:B=>b(ae)},{default:p(()=>{var B,j,A;return[r(ne,{style:{cursor:"initial","margin-right":"5px"},"icon-class":"Histogram"}),T(" "+N((B=c.value.get(V))==null?void 0:B.label)+" ",1),(j=c.value.get(V))!=null&&j.tip?(_(),C(le,{key:0,class:"box-item",effect:"dark",content:(A=c.value.get(V))==null?void 0:A.tip,placement:"bottom"},{default:p(()=>[r(k,{style:{cursor:"pointer","margin-left":"5px"}},{default:p(()=>[r(F(re))]),_:1})]),_:2},1032,["content"])):D("",!0)]}),_:2},1032,["type","onClose"])}),128))])}}});const Be=x(Le,[["__scopeId","data-v-6a87a073"]]),Pe=O({__name:"SoureceLabel",props:{sourceId:{}},setup(I){const o=I,d=z();U(()=>o.sourceId,()=>{var e;(e=d.value)==null||e.reload()});const g=me(),a=z(""),l=async()=>{if(a.value="",!o.sourceId)return;const e=await g.getSoureceData(o.sourceId);if(e===null)return Promise.reject({loadState:fe.danger,msg:"数据集不可使用/已被删除"});a.value=e.name};return(e,t)=>(_(),C(pe,{ref_key:"loadingDataRef",ref:d,load:l,inline:"",delay:1e3},{default:p(()=>[r(Z,{style:{width:"100%"},content:a.value},null,8,["content"])]),_:1},512))}}),qe=O({__name:"SelectFilterField",props:{filterItem:{}},setup(I){const o=I,d=te();U(()=>{const e=o.filterItem.modules.map(t=>t.sourceId).filter(t=>!!t);return[...new Set(e)]},(e,t)=>{_e(e,t)||(o.filterItem.sources=e.map(s=>{var c;return((c=o.filterItem.sources)==null?void 0:c.find(i=>i.sourceId===s))??{sourceId:s}}))},{immediate:!0});const g=e=>{const t=o.filterItem.modules.filter(s=>s.sourceId===e);return t.length?`（${t.map(s=>{const c=d.matchModule(s.moduleId);return c?c.module.options.label:'<span style="color: red">该筛选图表已删除</span>'}).join("、")}）`:""},a=w(()=>{var e,t;return(t=(e=o.filterItem.sources)==null?void 0:e[0])==null?void 0:t.fieldType});U(a,()=>{o.filterItem.sources.forEach((e,t)=>{t!==0&&(o.filterItem.sources[t]={sourceId:e.sourceId})})});const l=(e,t)=>ve(t,{includeTypes:e!==0&&a.value?[a.value]:void 0});return(e,t)=>(_(),E("div",{class:"select_field"},[(_(!0),E(P,null,q(e.filterItem.sources,(s,c)=>(_(),E("div",{class:"select_field-item",key:s.sourceId},[v("div",{class:"select_field-title mb-10"},[r(Pe,{"source-id":s.sourceId},null,8,["source-id"]),v("span",{class:"title-module-names",innerHTML:g(s.sourceId)},null,8,["innerHTML"])]),r(Ie,{"model-value":s,"onUpdate:modelValue":i=>e.filterItem.sources[c]=i,"source-id":s.sourceId,filter:l.bind(null,c),prop:{fieldId:"fieldId",fieldType:"fieldType"},disabled:c!==0&&!a.value},null,8,["model-value","onUpdate:modelValue","source-id","filter","disabled"])]))),128))]))}});const Ne=x(qe,[["__scopeId","data-v-df663d95"]]),Re=O({__name:"SetFilterInfo",props:{filterItem:{}},setup(I){const o=I,d=w(()=>[...o.filterItem.sources??[]].shift()),{getFieldInfo:g}=W(),a=w(()=>{var t,s;const e=(t=d.value)==null?void 0:t.fieldId;return e?g(e,{sourceId:(s=d.value)==null?void 0:s.sourceId}):null});U(()=>{var e;return(e=d.value)==null?void 0:e.fieldType},()=>{o.filterItem.filterOption={}});const l=e=>{o.filterItem.filterOption.operate&&(o.filterItem.filterOption.valueMap||(o.filterItem.filterOption.valueMap={}),o.filterItem.filterOption.valueMap[o.filterItem.filterOption.operate]=e)};return(e,t)=>{const s=ge,c=K,i=he;return e.filterItem.sources.length&&e.filterItem.sources.every(m=>m.fieldId)?(_(),C(i,{key:0,labelPosition:"top"},{default:p(()=>[r(s,{label:"名称"},{default:p(()=>[r(ee,{modelValue:e.filterItem.name,"onUpdate:modelValue":t[0]||(t[0]=m=>e.filterItem.name=m),maxlength:"10",isBlurCache:"",placeholder:"请输入筛选器名称"},null,8,["modelValue"])]),_:1}),r(s,{label:"筛选方式"},{default:p(()=>[r(ze,{class:"w100",modelValue:e.filterItem.filterOption.operate,"onUpdate:modelValue":t[1]||(t[1]=m=>e.filterItem.filterOption.operate=m),placeholder:"请选择筛选方式",fieldInfo:a.value,otherOptions:{noCheckSystem:!0},isDefaultFirst:""},null,8,["modelValue","fieldInfo"]),v("div",{class:"filter_info-user"},[r(c,{"model-value":e.filterItem.filterOption.isUserSelectable!==!1,"onUpdate:modelValue":t[2]||(t[2]=m=>e.filterItem.filterOption.isUserSelectable=!!m)},{default:p(()=>[T(" 用户可选 ")]),_:1},8,["model-value"])])]),_:1}),e.filterItem.filterOption.operate&&[F(G).noEmpty,F(G).empty].includes(e.filterItem.filterOption.operate)?D("",!0):(_(),C(s,{key:0,label:"默认值"},{default:p(()=>{var m,b;return[r(xe,{"model-value":e.filterItem.filterOption.operate&&((m=e.filterItem.filterOption.valueMap)==null?void 0:m[e.filterItem.filterOption.operate]),"onUpdate:modelValue":l,fieldInfo:a.value,operate:e.filterItem.filterOption.operate,fieldType:(b=d.value)==null?void 0:b.fieldType},null,8,["model-value","fieldInfo","operate","fieldType"])]}),_:1}))]),_:1})):D("",!0)}}});const je=x(Re,[["__scopeId","data-v-c4b793c7"]]);var $=(I=>(I.default="default",I.quick="quick",I))($||{});const Ae=O({__name:"FilterSetting",props:{modelValue:{},mode:{default:$.default}},emits:["update:modelValue"],setup(I,{emit:o}){const d=I,a=ye(d,"modelValue",o),l=z(),e=()=>Ce(a.value.map(f=>f.id)),t=()=>a.value.length>=50?(Te.error(`${b.value}最多添加 50 个`),!1):!0,s=()=>{if(!t())return;const f={id:e(),name:`${d.mode===$.quick?"未命名筛选条件":"筛选器"}${Fe.cn.encodeS(a.value.length+1)}`,modules:[],sources:[],filterOption:{}};a.value.push(f),i(f)},c=(f,y)=>{t()&&a.value.splice(y+1,0,{...Se(f),name:`${f.name}_副本`.slice(0,10),id:e()})},i=f=>{l.value=f},m=f=>{var y;if(f.id===((y=l.value)==null?void 0:y.id))return"is-edit"},b=w(()=>d.mode===$.quick?"筛选条件":"筛选器");return U(()=>[...a.value],()=>{a.value.some(f=>{var y;return f.id===((y=l.value)==null?void 0:y.id)})||(l.value=void 0)}),(f,y)=>{const u=Q,n=J,k=we,S=Ee;return _(),E("div",{class:"filter_setting"},[v("div",{class:"setting-container-left"},[f.mode===F($).quick?(_(),E("div",{key:0,class:"left-title"},[r(u,{"disable-transitions":"",effect:"dark",round:"",size:"small"},{default:p(()=>[T("2")]),_:1}),v("span",{class:"ml-5"},"设置快捷条件")])):D("",!0),r(n,{type:"primary",text:"",icon:F(Y),size:"large",onClick:s},{default:p(()=>[T(" 添加"+N(b.value),1)]),_:1},8,["icon"]),v("div",{class:"left-list"},[r(Ue,{class:"left-drag",modelValue:F(a),"onUpdate:modelValue":y[0]||(y[0]=h=>Ve(a)?a.value=h:null),itemClass:m,rankCallback:()=>!0},{default:p(({element:h,index:L})=>[r(ee,{modelValue:h.name,"onUpdate:modelValue":M=>h.name=M,style:{width:"200px","margin-right":"10px"},maxlength:"10",isBlurCache:"",placeholder:`请输入${b.value}名称`},null,8,["modelValue","onUpdate:modelValue","placeholder"]),r(k,{underline:!1,title:"复制",icon:F(be),onClick:M=>c(h,L)},null,8,["icon","onClick"]),r(k,{underline:!1,title:"编辑",icon:F(ke),onClick:M=>i(h)},null,8,["icon","onClick"])]),_:1},8,["modelValue"]),F(a).length?D("",!0):(_(),C(S,{key:0,description:`请添加${b.value}`},null,8,["description"]))])]),v("div",{class:"setting-container-right"},[l.value?(_(),E("div",{style:{height:"100%"},key:l.value.id},[v("div",{class:"right-header az-ellipsis"},[f.mode===F($).quick?(_(),C(u,{key:0,"disable-transitions":"",class:"mr-5",effect:"dark",round:"",size:"small"},{default:p(()=>[T(" 3 ")]),_:1})):D("",!0),T(" 设置："+N(l.value.name),1)]),v("div",{class:"right-body"},[v("div",{class:"right-item"},[v("div",{class:"right-item-header"},"1. 选择筛选的图表"),r(Be,{modelValue:l.value.modules,"onUpdate:modelValue":y[1]||(y[1]=h=>l.value.modules=h)},null,8,["modelValue"])]),v("div",{class:"right-item"},[v("div",{class:"right-item-header"},"2. 选择筛选字段"),r(Ne,{filterItem:l.value},null,8,["filterItem"])]),v("div",{class:"right-item"},[v("div",{class:"right-item-header"},"3. 设置筛选选项"),r(je,{filterItem:l.value},null,8,["filterItem"])])])])):(_(),C(S,{key:0,style:{height:"100%"},description:`请从左边选择要配置的${b.value}`},null,8,["description"]))])])}}});const Je=x(Ae,[["__scopeId","data-v-5eb6fbe3"]]);function Ke({pageDesigner:I,data:o,dataSystem:d}){const{checkField:g}=W(d),{checkSource:a}=$e({dataSystemParams:d});try{if(!o.modules.length)throw"筛选图表至少选择一个";for(const l of o.modules){const e=I.matchModule(l.moduleId);if(!(e!=null&&e.module))throw"存在已删除图表";if(!e.module.options.sourceId)throw"存在图表没有选择数据源";const t=o.modules.find(s=>s.moduleId===l.moduleId);if(e.module.options.sourceId!==(t==null?void 0:t.sourceId))throw"存在图表数据源已更改"}for(const l of o.sources){if(a(l.sourceId)===!1)throw"存在异常数据源";if(!l.fieldId)throw"存在筛选字段未选择";if(g(l.fieldId,{sourceId:l.sourceId})===!1)throw"存在筛选字段异常"}}catch(l){if(typeof l=="string")return l;throw l}}const Qe=O({__name:"ModulePadding",props:{moduleItem:{}},setup(I){return(o,d)=>(_(),E("div",{style:Oe({padding:`${o.moduleItem.options.showLabel?"0px":"var(--page-module-spacing)"} var(--page-module-spacing) var(--page-module-spacing)`})},[De(o.$slots,"default")],4))}});function We({screenValue:I,list:o,pageDesigner:d}){const g=new Map(o.reduce((a,l)=>[...a,...l.modules.map(e=>[e.moduleId,[]])],[]));return I.forEach((a,l)=>{const e=o.find(t=>t.id===l);e&&e.sources.forEach(t=>{if(!t.fieldId)return;const s=e.modules.filter(i=>{var m,b;return!(i.sourceId!==t.sourceId||i.sourceId!==((b=(m=d.matchModule(i.moduleId))==null?void 0:m.module)==null?void 0:b.options.sourceId))}).map(i=>i.moduleId);if(!s.length)return;const c={cn:Me.and,leftTableName:X(t.fieldId).entryId,leftFieldName:X(t.fieldId).fieldId,leftFieldType:t.fieldType,type:a.operate,value:a.value??void 0};s.forEach(i=>{const m=g.get(i)??[];g.has(i)||g.set(i,m),m.push(c)})})}),g}export{Je as F,Qe as _,Ke as c,$ as f,We as g};
