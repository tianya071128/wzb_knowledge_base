import{d as de,v as re,gY as oe,g$ as fe,r as w,Y as C,z as pe,c as Y,g2 as J,a8 as me,a as z,f$ as ce,o as f,b as F,w as l,k as b,i as e,m as S,B as m,f as I,H as M,a3 as K,aq as Q,dA as x,F as A,g as j,a2 as ye,l as g,c1 as ve,a4 as _e,C as be,mx as X,aN as G,eh as Ie,P as Fe,av as Ve,bm as ke,U as ge,bn as De,_ as he,zn as Ee,y as Ce,zo as we,i2 as Z,i0 as ee,hR as le,h as Se,t as ae,ao as Be,ap as Le}from"./index-b80d5ef5.js";import{F as $e}from"./FormulaWrapper-92a83208.js";import{A as O,E as Ue}from"./routePage-70460a50.js";import{B as te}from"./fieldDefaultComponent-58752d9c.js";import{E as ze,a as Ae,b as Re}from"./el-dropdown-item-455a6589.js";import{F as Ne}from"./FieldCondition-1c72aa9d.js";import{D as Te}from"./DataSoureceWrapper-047a1c9d.js";const Pe=de({__name:"LinkageData",props:{modelValue:{type:Boolean},field:{},linkData:{}},emits:["update:modelValue","confirm"],setup(R,{emit:N}){const i=R,D=N,y=re(i,"modelValue",D),v=oe(),_={sourceId:"",condition:[],detonateFieldId:""},{key:h,reload:B}=fe(),a=w(C(_));pe(()=>{y.value&&(a.value=C(i.linkData??_))});const T=()=>{a.value=C({..._,entryId:a.value.sourceId}),B()},P=Y(()=>{const t=v.form.fields,o=J(i.field.fieldId,t);return me(t,{blockFilter(s){var p;return s.type===z.subform&&!(((p=o==null?void 0:o.parentField)==null?void 0:p.type)===z.subform&&s.fieldId===o.parentField.fieldId)},excludeFilter(s){return s.fieldId===i.field.fieldId||s.type===z.subform}}).map(s=>{const p=C(s);return p.options.label=ce(s.fieldId,t,{includeSubFormLabel:!0})??"",p})}),d=t=>X(t,i.field.type),u=w(),L=w(),W=async()=>{var t,o,s;if(await Promise.all([(t=u.value)==null?void 0:t.validate(),(o=L.value)==null?void 0:o.validate()]).catch(p=>(G.error("请设置完整的联动条件"),Promise.reject(p))),!a.value.condition.length)return G.error("请至少设置一个条件");if(i.field.type==="subform"&&!((s=a.value.subDetonateField)!=null&&s.length))return G.error("请设置子控件的写入规则");D("confirm",C(a.value)),y.value=!1},V=t=>(a.value.subDetonateField??[]).some(o=>o.subFieldId===t.fieldId),$=t=>{(a.value.subDetonateField??(a.value.subDetonateField=[])).push({detonateFieldId:"",subFieldId:t.fieldId})},r=(t,o)=>{var E,U;const s=(E=J(a.value.detonateFieldId,t))==null?void 0:E.field,p=(U=v.matchField(o))==null?void 0:U.field.type;return(s==null?void 0:s.type)===z.subform&&p?X(s.fields,p):[]};return(t,o)=>{const s=Ie,p=Fe,E=Ve,U=ze,se=Ae,ne=Re,ie=ke,H=ge,ue=De;return f(),F(ue,{modelValue:m(y),"onUpdate:modelValue":o[4]||(o[4]=n=>be(y)?y.value=n:null),title:"数据联动设置",width:"70%","destroy-on-close":"","close-on-click-modal":!1,"append-to-body":""},{footer:l(()=>[b("span",{class:"dialog-footer"},[e(H,{onClick:o[3]||(o[3]=n=>y.value=!1)},{default:l(()=>[S("取消")]),_:1}),e(H,{type:"primary",onClick:W},{default:l(()=>[S("确定")]),_:1})])]),default:l(()=>[e(ie,{ref_key:"ruleFormRef",ref:L,model:a.value,class:"linkage-data","show-message":!1},{default:l(()=>[e(O,{name:"联动数据集",class:"mb-20"},{default:l(()=>[e(Te,{modelValue:a.value.sourceId,"onUpdate:modelValue":o[0]||(o[0]=n=>a.value.sourceId=n),appId:m(v).appId,onChange:T,currentEntryId:m(v).entryId,hideCurrentEntry:""},null,8,["modelValue","appId","currentEntryId"])]),_:1}),(f(),I("div",{key:m(h)},[e(O,{name:"查询满足以下条件的记录",class:"mb-20"},{default:l(()=>[e(Ne,{condition:a.value.condition,"onUpdate:condition":o[1]||(o[1]=n=>a.value.condition=n),ref_key:"fieldConditionRef",ref:u,sourceId:a.value.sourceId,conditionPlaceholder:"选择关联数据集控件",compareFields:P.value,isConditionSubField:""},null,8,["condition","sourceId","compareFields"])]),_:1}),e(O,{name:"查询到记录后",class:"mb-20"},{default:l(()=>[e(s,{title:"如果查询到多条，取最新创建的一条",type:"success",closable:!1}),b("div",{class:"detonate-item"},[b("span",{class:"detonate-tip pl-0"},"将"),e(M,{required:"",prop:"detonateFieldId","hide-label":"",class:"detonate-link-field"},{default:l(()=>[e(K,{modelValue:a.value.detonateFieldId,"onUpdate:modelValue":o[2]||(o[2]=n=>a.value.detonateFieldId=n),placeholder:"选择联动表单控件",sourceId:a.value.sourceId,filter:d,"is-select-subform":""},null,8,["modelValue","sourceId"])]),_:1}),b("span",{class:"detonate-tip"},"的值写入到当前表单控件"),e(Q,{class:"detonate-link-field az-input-prefix",readonly:""},{prefix:l(()=>[e(x,{class:"color-text","include-sub-form-label":"",fields:m(v).form.fields,"field-id":t.field.fieldId},null,8,["fields","field-id"])]),_:1})]),t.field.type==="subform"&&a.value.detonateFieldId?(f(),I(A,{key:0},[e(ne,{trigger:"click","hide-on-click":!1,"max-height":"200px"},{dropdown:l(()=>[e(se,null,{default:l(()=>{var n;return[(f(!0),I(A,null,j(t.field.fields,(c,k)=>(f(),F(U,{key:k,disabled:V(c),onClick:q=>$(c)},{default:l(()=>[e(x,{style:ye([{width:"100px"},{color:V(c)?"var(--el-text-color-disabled)":null}]),fields:t.field.fields,"field-id":c.fieldId,disabled:V(c)},null,8,["fields","field-id","disabled","style"])]),_:2},1032,["disabled","onClick"]))),128)),(n=t.field.fields)!=null&&n.length?g("",!0):(f(),I("span",{key:0,style:{padding:"0 10px"},class:"color2"}," 没有可选择控件 "))]}),_:1})]),default:l(()=>[e(E,{underline:!1,type:"primary",class:"mt-10 mb-10"},{default:l(()=>[S(" 添加子控件 "),e(p,{class:"el-icon--right"},{default:l(()=>[e(m(ve))]),_:1})]),_:1})]),_:1}),(f(!0),I(A,null,j(a.value.subDetonateField??[],(n,c)=>(f(),I("div",{key:n.subFieldId,class:"detonate-item pl-10"},[b("span",{class:"detonate-tip pl-0"},"将联动子表单的"),b("div",{class:"detonate-link-field"},[e(M,{required:"",prop:`subDetonateField.${c}.detonateFieldId`,"hide-label":""},{default:l(()=>[e(K,{modelValue:n.detonateFieldId,"onUpdate:modelValue":k=>n.detonateFieldId=k,placeholder:"选择联动子表单的子控件",sourceId:a.value.sourceId,filter:k=>r(k,n.subFieldId)},null,8,["modelValue","onUpdate:modelValue","sourceId","filter"])]),_:2},1032,["prop"])]),b("span",{class:"detonate-tip"},"的值写入当前子表单的"),e(M,{class:"detonate-link-field",prop:`subDetonateField.${c}.subFieldId`,"hide-label":""},{default:l(()=>[e(Q,{class:"az-input-prefix",readonly:""},{prefix:l(()=>[e(x,{class:"color-text",fields:t.field.fields,"field-id":n.subFieldId,"is-throw":""},null,8,["fields","field-id"])]),_:2},1024)]),_:2},1032,["prop"]),e(E,{class:"condition-delete ml-10",type:"danger",onClick:k=>{var q;return(q=a.value.subDetonateField)==null?void 0:q.splice(c,1)},underline:!1},{default:l(()=>[e(p,{title:"删除"},{default:l(()=>[e(m(_e))]),_:1})]),_:2},1032,["onClick"])]))),128))],64)):g("",!0)]),_:1})]))]),_:1},8,["model"])]),_:1},8,["modelValue"])}}});const We=he(Pe,[["__scopeId","data-v-1d20a414"]]),qe={name:"DetaultValueEditor"},Je=de({...qe,props:{modelValue:{},field:{},type:{}},emits:["update:modelValue"],setup(R,{emit:N}){const i=R,D=N,y=oe(),v=Y(()=>Ee.filter(d=>{var u;return(u=i.type)==null?void 0:u.includes(d.value)})),_=(d,u)=>{D("update:modelValue",{...i.modelValue,[u]:d})};Ce(()=>i.modelValue.type,()=>{D("update:modelValue",{...i.modelValue,...we})});const h=w(!1),B=w(),a=()=>{h.value=!0,B.value=i.modelValue.dataLinkage??void 0},T=d=>{_(d,"dataLinkage")},P=Y(()=>{const d=`${i.field.fieldId}.defaultValue.`,u=i.modelValue.type===Z?"linkage":i.modelValue.type===ee?"formula":i.modelValue.type===le?"custom":"other";return`${d}${u}`});return(d,u)=>{const L=Be,W=Le;return f(),F(Ue,{label:"默认值",id:P.value},{default:l(({error:V})=>{var $;return[(($=v.value)==null?void 0:$.length)>1?(f(),F(W,{key:0,"model-value":d.modelValue.type,"onUpdate:modelValue":u[0]||(u[0]=r=>_(r,"type")),placeholder:"请选择",style:{width:"100%"},class:"mb-10"},{default:l(()=>[(f(!0),I(A,null,j(v.value,r=>(f(),F(L,{key:r.value,label:r.label,value:r.value},null,8,["label","value"]))),128))]),_:1},8,["model-value"])):g("",!0),d.modelValue.type===m(le)?Se(d.$slots,"default",{key:1}):g("",!0),d.modelValue.type===m(Z)?(f(),F(te,{key:2,"is-error":!!V,"is-set":!!d.modelValue.dataLinkage,onClick:a},{default:l(()=>[S(ae(d.modelValue.dataLinkage?"已设置联动":"设置联动"),1)]),_:2},1032,["is-error","is-set"])):g("",!0),d.modelValue.type===m(ee)?(f(),F($e,{key:3,"model-value":d.modelValue.formula,"onUpdate:modelValue":u[1]||(u[1]=r=>_(r,"formula")),group:m(y).getFormulaGroup(d.field.fieldId),isSubform:""},{default:l(()=>{var r;return[e(te,{"is-error":!!V,"is-set":!!((r=d.modelValue.formula)!=null&&r.trim())},{default:l(()=>{var t;return[S(ae((t=d.modelValue.formula)!=null&&t.trim()?"已添加函数":"添加函数"),1)]}),_:2},1032,["is-error","is-set"])]}),_:2},1032,["model-value","group"])):g("",!0),e(We,{modelValue:h.value,"onUpdate:modelValue":u[2]||(u[2]=r=>h.value=r),field:d.field,onConfirm:T,linkData:B.value},null,8,["modelValue","field","linkData"])]}),_:3},8,["id"])}}});export{Je as _};
