import{d as be,qB as S,hd as Te,d4 as G,yW as De,yV as ke,r as w,y as _e,c as $,bX as ve,h6 as Ie,nY as Le,bx as Se,cC as $e,o as g,f as T,k as y,a2 as Y,F as N,g as q,t as P,i as R,w as W,m as fe,B as p,qw as xe,b as ye,p as de,l as ae,U as Ce,ao as Re,ap as Ee,by as Me,di as Ge,aU as Fe,_ as we,AH as We,dU as Ye,oy as Ne,Z as He,e1 as te,n as Be,ka as pe,z as Ve,e as ze,b1 as Oe,C as Ue,qD as me,j as ge,L as qe,n3 as Pe,dV as Ae,ca as je,a as Xe}from"./index-b80d5ef5.js";import{R as Ze}from"./Resize-eb80395d.js";const he="YYYY/MM/DD HH:mm:ss",Qe=be({__name:"Gantt",props:{calibration:{default:S.day},ganttData:{default(){return[]}}},emits:["scroll"],setup(ue,{expose:le,emit:ne}){Te(l=>({"29b5480c":se.value,"8048c6c8":oe.value})),G.extend(De),G.extend(ke);const d=ue,A=ne,x=w(d.calibration);_e(()=>d.calibration,()=>{x.value=d.calibration});const j=$(()=>{const l=L.value+50;for(let n=0;n<_.value.length;n++)if(m.value.width*n<=l&&m.value.width*(n+1)>=l)return _.value[n].levitateLeftLabel;return""}),X={dayunit:"day",num:60,width:60,totalW:7200},Z=new Map([[S.day,X],[S.week,{dayunit:"week",num:30,width:120,totalW:7200}],[S.month,{dayunit:"month",num:30,width:120,totalW:7200}],[S.season,{dayunit:"quarter",num:30,width:120,totalW:7200}],[S.year,{dayunit:"year",num:30,width:120,totalW:7200}]]),m=$(()=>Z.get(x.value)??X),se=$(()=>`${m.value.width}px`),oe=$(()=>`${m.value.totalW}px`),{width:H}=ve(Ie()),_=w([]),F=l=>{const{operating:n=1}=l;let o=G(l.standardDate);const u=m.value,i=[],r=t=>t<=9?`0${t}`:`${t}`;return o.isValid()?(o=o.startOf(u.dayunit),Array(u.num).fill(1).forEach(()=>{const t=n>0?o:o.add(-1,u.dayunit),b=t.endOf(u.dayunit);let e="",c="",I="",C=!1;switch(x.value){case S.day:e=r(t.date()),C=t.date()===1,c=`${r(t.month()+1)}月`,I=`${t.year()}-${r(t.month()+1)}月`;break;case S.week:e=`${r(t.week())}周${r(t.date())}日-${r(b.date())}日`,C=t.month()!==t.add(-7,"day").month(),c=`${r(t.month()+1)}月`,I=`${t.year()}-${r(t.month()+1)}月`;break;case S.month:e=`${r(t.month()+1)}月`,C=t.month()===0,c=`${t.year()}年`,I=`${t.year()}年`;break;case S.season:e=`Q${t.quarter()}`,C=t.month()===0,c=`${t.year()}年`,I=`${t.year()}年`;break;case S.year:e=`${t.year()}年`;break}i[n>0?"push":"unshift"]({start:t.valueOf(),end:b.valueOf(),label:e,startLabel:t.format(he),endLabel:b.format(he),headerLabel:c,levitateLeftLabel:I,isHeaderLabel:C}),o=o.add(1*n,u.dayunit)}),i):(console.warn("数据异常, 无法计算"),[])},E=()=>{var l;_.value=[...F({operating:-1}),...F({operating:1})],(l=B.value)==null||l.setScrollLeft((m.value.totalW-H.value)/2)};_e(x,()=>{setTimeout(()=>{E()},100)},{immediate:!0});const Q=w(),{height:J}=ve(Q),B=w(),L=w(0),O=w(0),re=({scrollLeft:l,scrollTop:n})=>{L.value=l,O.value=n,A("scroll",{scrollTop:n,scrollLeft:l})},V=w(!1),U=()=>{V.value=!1,document.removeEventListener("mouseup",U)},K=l=>{[l.target,l.target.parentElement].some(o=>(o==null?void 0:o.classList.contains("el-scrollbar__bar"))&&(o==null?void 0:o.classList.contains("el-scrollbar__bar")))&&(V.value=!0,document.addEventListener("mouseup",U))};Le([L,H,V],()=>{var l;if(!(V.value||!_.value.length)&&(L.value<200||m.value.totalW-L.value-H.value<200)){const n=L.value<200?-1:1,o=m.value.num;let u=_.value.slice(n>0?o-1:0,n>0?void 0:o),i;n>0?(i=_.value[_.value.length-1].end+10,u=[...u,...F({standardDate:i,operating:n})]):(i=_.value[0].start-10,u=[...F({standardDate:i,operating:n}),...u]),_.value=u,(l=B.value)==null||l.setScrollLeft(L.value+m.value.totalW/2*n*-1)}},{throttle:100});const z=$(()=>{const l=Date.now();for(let n=0;n<_.value.length;n++){const o=_.value[n];if(o.start<=l&&o.end>=l){const u=(l-o.start)/(o.end-o.start)*m.value.width;return n*m.value.width+u}}return null}),ie=()=>{E()},ce=$(()=>{var i,r;const l=(i=_.value[0])==null?void 0:i.start,n=(r=_.value[_.value.length-1])==null?void 0:r.end,o=n-l,u=m.value.totalW;return l==null||n==null?[]:d.ganttData.map(t=>{if(t.__ganttStartTimestamp__==null||t.__ganttEndTimestamp__==null||t.__ganttStartTimestamp__>t.__ganttEndTimestamp__||t.__ganttStartTimestamp__>=n||t.__ganttEndTimestamp__<=l)return t;const b=Math.max(0,(t.__ganttStartTimestamp__-l)/o*u),e=Math.min(u,(t.__ganttEndTimestamp__-l)/o*u);return{...t,__ganttLeft__:b,__ganttRight__:e}})}),s=w(!1),a=w({top:0,left:0,bottom:0,right:0}),h=w({getBoundingClientRect(){return a.value}}),v=l=>{a.value=DOMRect.fromRect({width:0,height:0,x:l.clientX,y:l.clientY})};Se(()=>{document.addEventListener("mousemove",v)}),$e(()=>{document.removeEventListener("mousemove",v)});const f=w(),D=()=>{s.value=!1},k=l=>{f.value=l,l.__ganttGroup__||(s.value=!0)};return le({setScrollTop(l){var n;Math.abs(l-O.value)>=1&&((n=B.value)==null||n.setScrollTop(l))}}),(l,n)=>{const o=Ce,u=Re,i=Ee,r=Me,t=Ge,b=Fe;return g(),T("div",{class:de(["Gantt-right",[`is-${l.calibration}`]]),onMousedownCapture:K},[y("div",{class:"Gantt-right-header"},[y("div",{class:"header-label",style:Y({left:`-${L.value}px`})},[(g(!0),T(N,null,q(_.value,(e,c)=>(g(),T("div",{class:"header-label-item",key:c},P(e.isHeaderLabel?e.headerLabel:""),1))),128))],4),y("div",{class:"header-levitate"},P(j.value),1),y("div",{class:"header-right"},[R(o,{class:"header-now",link:"",type:"primary",onClick:ie},{default:W(()=>[fe(" 今天 ")]),_:1}),R(i,{class:"header-calibartion",modelValue:x.value,"onUpdate:modelValue":n[0]||(n[0]=e=>x.value=e),placeholder:"请选择"},{default:W(()=>[(g(!0),T(N,null,q(p(xe),(e,c)=>(g(),ye(u,{key:c,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),y("div",{class:"Gantt-right-date"},[y("div",{class:"scale-container",style:Y({left:`-${L.value}px`})},[(g(!0),T(N,null,q(_.value,(e,c)=>(g(),T("div",{class:"scale-item",key:c},P(e.label),1))),128))],4)]),y("div",{class:"Gantt-right-body",ref_key:"GanttRightBodyRef",ref:Q},[R(t,{ref_key:"scrollbarRef",ref:B,class:"Gantt-scrollbar",always:"",onScroll:re},{default:W(()=>[y("div",{class:"Gantt-container",style:Y({minHeight:`${p(J)}px`})},[(g(!0),T(N,null,q(ce.value,e=>(g(),T("div",{key:e.__ganttId__,class:de(["cantt-item",{"is-group":e.__ganttGroup__}])},[e.__ganttLeft__!=null&&e.__ganttRight__!=null?(g(),T("div",{key:0,class:"cantt-item-line",style:Y({left:`${e.__ganttLeft__}px`,width:`${e.__ganttRight__-e.__ganttLeft__}px`,backgroundColor:e.__ganttColor__}),onMouseleave:D,onMouseenter:c=>k(e)},null,44,["onMouseenter"])):ae("",!0)],2))),128)),(g(!0),T(N,null,q(_.value,(e,c)=>(g(),T(N,{key:c},[c!==0?(g(),T("div",{key:0,class:"row-line",style:Y({left:`${c*m.value.width}px`})},null,4)):ae("",!0)],64))),128)),z.value?(g(),T(N,{key:0},[y("div",{class:"now-line",style:Y({left:`${z.value}px`})},null,4),R(r,{class:"now-tag",type:"primary",style:Y({left:`${z.value+2}px`,top:`${O.value}px`})},{default:W(()=>[fe(" 今天 ")]),_:1},8,["style"])],64)):ae("",!0)],4)]),_:1},512)],512),R(b,{visible:s.value,"onUpdate:visible":n[1]||(n[1]=e=>s.value=e),placement:"bottom",trigger:"click","virtual-triggering":"","virtual-ref":h.value},{content:W(()=>{var e,c;return[y("div",{class:"cantt-tooltip"},[y("div",{class:""}," 开始时间："+P(p(G)((e=f.value)==null?void 0:e.__ganttStartTimestamp__).format("YYYY-MM-DD")),1),y("div",{class:""}," 结束时间："+P(p(G)((c=f.value)==null?void 0:c.__ganttEndTimestamp__).format("YYYY-MM-DD")),1)])]}),_:1},8,["visible","virtual-ref"])],34)}}});const Je=we(Qe,[["__scopeId","data-v-ffb9b9af"]]),Ke=be({__name:"GanttTable",emits:["row-click"],setup(ue,{emit:le}){const ne=le,{render:d,listFields:A,selectItems:x,tableMode:j}=We(),X=$(()=>({sourceId:d.sourceId,limit:1e4,params:{...d.getSearchParams()},disableRequest:d.disabledLoad||d.disabledLoadPlus,mode:"list"})),{getData:Z,tableData:m,loading:se}=Ye(X),oe=s=>{ne("row-click",s)};Z(),d.on(Ne,({isReset:s})=>{Z(s)});const H=`${He()}`,_=w([]),F=w(new Set),E=$(()=>{var a;const s=(a=d.view.basis.ganteOptions)==null?void 0:a.groupFieldId;return s?d.matchField(s):void 0}),Q=async()=>{E.value&&(_.value=await Pe(E.value.field.options.dataOptions))},J=$(()=>{if(E.value){const s=E.value.field.fieldId;return[..._.value,{label:"为空",value:H,color:""}].map(a=>({__children__:m.value.filter(v=>{var D,k,l;let f=te({fieldId:s,rowData:v});return f=((l=(k=(D=E.value)==null?void 0:D.helper)==null?void 0:k.getFormat)==null?void 0:l.call(k,f))??f,a.value===H?f==null:Be(f).some(n=>n===a.value)}),__slot__:!0,id:a.value,label:a.label,__group__:!0}))}return m.value}),B=(s,a)=>{const h=s.id;a?F.value.add(h):F.value.delete(h)},L=$(()=>{var l,n,o,u;const s=[],a=d.view.basis.ganteOptions,h=(u=(o=(n=(l=d.matchField(a==null?void 0:a.colorFieldId))==null?void 0:l.field)==null?void 0:n.options)==null?void 0:o.dataOptions)==null?void 0:u.custom.options,v="var(--el-color-primary-light-5)",f="var(--el-color-info-light-5)";function D(i){var t,b,e,c,I;const r=d.matchField((t=a==null?void 0:a.startDateField)==null?void 0:t.fieldId);if(r!=null&&r.field){let C,ee,M=te({fieldId:r.field.fieldId,rowData:i});return(b=r.helper)!=null&&b.getFormat&&(M=(e=r.helper)==null?void 0:e.getFormat(M,r.field)),r.field.type===Xe.daterange?(C=G(M==null?void 0:M[0]).valueOf(),ee=G(M==null?void 0:M[1]).valueOf()):(C=G(M).valueOf(),ee=(c=a==null?void 0:a.endDateField)!=null&&c.fieldId?G(te({fieldId:(I=a==null?void 0:a.endDateField)==null?void 0:I.fieldId,rowData:i})).valueOf():NaN),[isNaN(C)?void 0:C,isNaN(ee)?void 0:ee]}}function k(i){var e;const[r,t]=D(i)??[];let b=(a==null?void 0:a.commonColor)??v;if(a!=null&&a.colorFieldId){const c=te({fieldId:a.colorFieldId,rowData:i});b=((e=h==null?void 0:h.find(I=>(I==null?void 0:I.value)===c))==null?void 0:e.color)??v}return{...i,__ganttStartTimestamp__:r,__ganttEndTimestamp__:t,__ganttColor__:b,__ganttGroup__:!1,__ganttId__:Ae(i)}}for(const i of J.value)if(i.__group__){const r=i.__children__.map(e=>k(e)),t=Math.min(...r.map(e=>e.__ganttStartTimestamp__).filter(e=>pe(e))),b=Math.max(...r.map(e=>e.__ganttEndTimestamp__).filter(e=>pe(e)));s.push({...i,__ganttStartTimestamp__:isFinite(t)?t:void 0,__ganttEndTimestamp__:isFinite(b)?b:void 0,__ganttColor__:f,__ganttGroup__:!0,__children__:r,__ganttId__:i.id})}else s.push(k(i));return s}),O=$(()=>{const s=[];for(const a of L.value)s.push(a),a.__ganttGroup__&&F.value.has(a.__ganttId__)&&s.push(...a.__children__);return s});Ve(()=>{d.tableData=m.value});const re=(s,a,h)=>{var v,f;(f=(v=d.options.tableProps)==null?void 0:v.onHeaderDragend)==null||f.call(v,s,a,h)},V=({row:s})=>s!=null&&s.__group__?"cantt_talbe-group-row":"",U=w(),K=w(),z=w(0),ie=s=>{var a;(a=U.value)==null||a.setScrollTop(s.scrollTop),z.value=s.scrollTop},ce=s=>{var a,h,v,f;Math.abs(z.value-s.scrollTop)>=1&&((f=(v=(h=(a=K.value)==null?void 0:a.azTableRef)==null?void 0:h.tableRef)==null?void 0:v.setScrollTop)==null||f.call(v,s.scrollTop))};return(s,a)=>{const h=je;return g(),ye(qe,{load:Q,class:de(["cantt_talbe",[`is-${p(j)}`]])},{default:W(()=>{var v;return[ze((g(),T("div",{class:"cantt_talbe-wrapper"},[y("div",{class:"cantt-left"},[R(Ze,{options:{id:`list-cantt-${p(d).view.id}`,init:400,max:700,min:250},style:{height:"100%"}},{default:W(()=>{var f;return[y("div",{class:"cantt-left-header"}),y("div",{class:"cantt-left-body"},[R(Oe,{selected:p(x),"onUpdate:selected":a[0]||(a[0]=D=>Ue(x)?x.value=D:null),isClick:"",multiple:"",tableMode:p(j),data:J.value,hidePagination:"",fields:p(d).fields,showFields:p(A),isSelect:p(d).view.basis.settings.some(D=>D===p(me).check),stripe:p(d).view.basis.settings.some(D=>D===p(me).discoloration),border:"",oneLine:"",onHeaderDragend:re,resizable:(f=p(d).options.tableProps)==null?void 0:f.resizable,autoHeight:"height","scrollbar-always-on":"","row-class-name":V,ref_key:"tableShowFieldRef",ref:K,onExpandChange:B,onScroll:ie,onRowClick:oe},{"colunm-content":W(({row:D,showField:k})=>{var l,n;return[(k==null?void 0:k.fieldId)===((l=p(A)[0])==null?void 0:l.fieldId)?(g(),T("div",{key:0,class:"cantt_talbe-group"},[y("div",null,[R(ge,{class:"group-header",content:(n=E.value)==null?void 0:n.field.options.label},null,8,["content"]),R(ge,{class:"group-content",content:D.label},null,8,["content"])])])):ae("",!0)]}),_:1},8,["selected","tableMode","data","fields","showFields","isSelect","stripe","resizable"])])]}),_:1},8,["options"])]),R(Je,{ganttData:O.value,calibration:(v=p(d).view.basis.ganteOptions)==null?void 0:v.calibration,ref_key:"ganttRef",ref:U,onScroll:ce},null,8,["ganttData","calibration"])])),[[h,p(se)]])]}),_:1},8,["class"])}}});const at=we(Ke,[["__scopeId","data-v-8f06048e"]]);export{at as default};
