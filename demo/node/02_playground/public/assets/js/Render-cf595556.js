import{F as ae}from"./FormItemFieldWrapper-ec4d2a36.js";import{u as le}from"./use-a506f279.js";import{d8 as T,r as k,bx as oe,cC as re,vW as se,wN as J,wO as H,aN as U,a as h,d as B,o as I,b as S,w as x,k as V,B as b,L as ne,_ as L,v as ie,i as E,m as D,C as ce,bv as de,U as Q,wP as W,f as R,I as ue,h7 as fe,l as $,F as N,g as K,n as A,t as pe,wQ as me,Y,eh as ye,bn as ve,dC as _e,ap as ge,dD as Ee,wR as xe,j as ke,lE as we,P as be,ao as Ie,c as he}from"./index-b80d5ef5.js";import"./useValidateError-9f6399dc.js";const G=r=>T.value.request.post(`${T.value.SYSTEMURL}/appForm/keywordExtraction`,r),Fe=r=>T.value.request.post(`${T.value.SYSTEMURL}/appForm/keywordExtractionResult`,r),Ce=r=>T.value.request.post(`${T.value.SYSTEMURL}/appForm/keywordValueBackFill`,r);async function X(r){var u,y;const m=((u=r.res)==null?void 0:u.reduce((c,a)=>{var n;const v=(n=r.keyInfoMap.get(a.entity))==null?void 0:n.fieldType;return v&&[h.department,h.departmentSingle,h.member,h.memberSingle].includes(v)?[...c,...a.values.map(e=>({analyzeValue:e.text,keyword:a.entity,type:v})).filter(e=>e.analyzeValue)]:[...c]},[]))??[];if(m.length){const c=await Ce({columnBackParamInfoList:m});(y=r.res)==null||y.forEach(a=>{var v;c.some(n=>n.keyword===a.entity)&&((v=a.values)==null||v.forEach(n=>{const e=c.find(i=>i.keyword===a.entity&&i.analyzeValue===n.text);e&&(n.transformText=e.value)}))})}}function Me({successCallback:r}){const m=k(!1),u=k();let y;const c=async()=>{try{const e=await Fe(u.value);e&&(U.success("关键字提取成功！"),await X({res:e,keyInfoMap:y}),r(e),a(),m.value=!1)}catch(e){return m.value=!1,Promise.reject(e)}},{pause:a,resume:v}=se(c,2e3);return{startExtract:async({file:e,keyInfoMap:i,promptCode:l})=>{m.value=!0;try{y=i;const{fileId:t}=await J({businessId:e.response,fileName:e.name,fileSource:"5",fileFormat:H(e.type),fileUrl:e.url}),o=await G({autoExtraction:!0,fileIds:[t],configuredKeys:[...(i==null?void 0:i.keys())??[]],synoymsMap:[...(i==null?void 0:i.entries())??[]].reduce((g,f)=>({...g,[f[0]]:f[1].synoyms??[]}),{}),promptCode:l});u.value={...o,url:o.url+"&headerType=2"},v()}catch{m.value=!1}},loading:m}}function Ve(r,m){const u=k(),y=k([]),c=k(!1),a=k(!1),v=async()=>{var t,o;const{fileId:i}=await J({businessId:r.file.response,fileName:r.file.name,fileSource:"5",fileFormat:H(r.file.type),fileUrl:r.file.url}),l=await G({autoExtraction:!1,fileIds:[i],configuredKeys:[...((t=r.keyInfoMap)==null?void 0:t.keys())??[]],synoymsMap:[...((o=r.keyInfoMap)==null?void 0:o.entries())??[]].reduce((g,f)=>({...g,[f[0]]:f[1].synoyms??[]}),{}),promptCode:r.promptCode});u.value={...l,url:l.url+"&headerType=2"}},n=async i=>{try{const{type:l,data:t}=i.data;l==="getExtraction"&&(c.value=!0,y.value=t.extractionRes),l==="saveExtractionRes"&&(a.value=!1,y.value=t.extractionRes,U({message:"文件关键字提取成功",type:"success"}),await X({res:y.value,keyInfoMap:r.keyInfoMap}),m("sendExtractData",y.value))}catch{a.value=!1}},e=()=>{var l;const i=document.getElementById("fileIframe");a.value=!0,(l=i.contentWindow)==null||l.postMessage(JSON.stringify({type:"saveExtractionRes"}),"*")};return oe(()=>{window.addEventListener("message",n)}),re(()=>{window.removeEventListener("message",n)}),{isExtractSuccess:c,loading:a,extractInfo:u,extractData:y,saveExtraction:e,extract:v,callback:n}}const Se=B({__name:"FileOcr",props:{keyInfoMap:{},file:{},promptCode:{}},emits:["sendExtractData"],setup(r,{expose:m,emit:u}){const y=r,c=u,{isExtractSuccess:a,loading:v,saveExtraction:n,extractInfo:e,extract:i}=Ve(y,c);return m({loading:v,isExtractSuccess:a,saveExtraction:n}),(l,t)=>(I(),S(ne,{load:b(i)},{default:x(()=>{var o;return[V("iframe",{id:"fileIframe",src:`${(o=b(e))==null?void 0:o.url}`,frameborder:"0",height:"100%",name:"fileIframe",allow:"camera *;autoplay *;microphone *",allowfullscreen:"",width:"100%"},null,8,["src"])]}),_:1},8,["load"]))}});const Te=L(Se,[["__scopeId","data-v-3e35784f"]]),De=B({__name:"FileOcrdDrawer",props:{modelValue:{type:Boolean},file:{},keyInfoMap:{},promptCode:{}},emits:["update:modelValue","sendExtractData"],setup(r,{emit:m}){const u=r,y=m,c=k(),a=ie(u,"modelValue",y),v=e=>{a.value=!1,y("sendExtractData",e)},n=()=>{var e;(e=c.value)==null||e.saveExtraction()};return(e,i)=>{const l=Q;return I(),S(de,{modelValue:b(a),"onUpdate:modelValue":i[0]||(i[0]=t=>ce(a)?a.value=t:null),class:"fileOcr-drawer",direction:"btt","append-to-body":"",size:"100vh","destroy-on-close":""},{header:x(()=>{var t,o;return[V("div",{class:"drawerHeader"},[V("div",{class:"drawerTitle"},"提取"),E(l,{type:"primary",onClick:n,loading:(t=c.value)==null?void 0:t.loading,disabled:!((o=c.value)!=null&&o.isExtractSuccess)},{default:x(()=>[D(" 确认提取 ")]),_:1},8,["loading","disabled"])])]}),default:x(()=>[E(Te,{file:e.file,keyInfoMap:e.keyInfoMap,promptCode:e.promptCode,onSendExtractData:v,ref_key:"fileOcr",ref:c},null,8,["file","keyInfoMap","promptCode"])]),_:1},8,["modelValue"])}}});const Oe=L(De,[["__scopeId","data-v-0806cf34"]]),q=["pdf","jpg","png","jpeg","bmp"],Re=B({inheritAttrs:!1,__name:"FileOcrWrapper",props:{file:{},mode:{default:W.drawer},errorMsg:{},keyInfoMap:{},promptCode:{}},emits:["sendExtractData"],setup(r,{emit:m}){const u=r,y=m,c=k(!1),a=k(),v=()=>{var s,F,O;const d=A(u.file);if(!d.length){U.error(((s=u.errorMsg)==null?void 0:s.emptyErrorMsg)??"文件为空");return}if(!d.every(C=>C.name&&me({name:C.name,accept:q}))){U.error(((F=u.errorMsg)==null?void 0:F.formatErrorMsg)??`${((O=u.errorMsg)==null?void 0:O.formatPrefixErrorMsg)??""}文件格式不正确，仅支持 ${q.map(C=>C.toLocaleUpperCase()).join("、")} 类型`);return}d.length>1?(e.value=!0,n.value=void 0):(a.value=Y(d[0]),o())},n=k(),e=k(!1),i=()=>{a.value=Y(n.value),e.value=!1,o()},{startExtract:l,loading:t}=Me({successCallback(d){p(d)}}),o=()=>{a.value&&(u.mode===W.drawer?c.value=!0:l({file:a.value,keyInfoMap:u.keyInfoMap,promptCode:u.promptCode}))},g=k(!1),f=k([]),p=d=>{f.value=d.map(s=>({value:s.values[0],item:s})),f.value.some(s=>s.item.values.length>1)?g.value=!0:y("sendExtractData",d)},w=()=>{const d=f.value.map(s=>({...s.item,values:[s.value]}));y("sendExtractData",d)};return(d,s)=>{const F=ye,O=be,C=Q,P=ve,j=_e,Z=Ie,ee=ge,te=Ee;return I(),R(N,null,[E(fe,ue({preview:"",onClick:v,loading:b(t)},d.$attrs),null,16,["loading"]),a.value?(I(),S(Oe,{key:0,modelValue:c.value,"onUpdate:modelValue":s[0]||(s[0]=_=>c.value=_),onSendExtractData:p,file:a.value,keyInfoMap:d.keyInfoMap,promptCode:d.promptCode},null,8,["modelValue","file","keyInfoMap","promptCode"])):$("",!0),E(P,{modelValue:e.value,"onUpdate:modelValue":s[2]||(s[2]=_=>e.value=_),title:"选择文件",width:"500"},{footer:x(()=>[V("div",{class:"dialog-footer"},[E(C,{onClick:s[1]||(s[1]=_=>e.value=!1)},{default:x(()=>[D("取消")]),_:1}),E(C,{type:"primary",disabled:!n.value,onClick:i},{default:x(()=>[D(" 确定 ")]),_:1},8,["disabled"])])]),default:x(()=>[E(F,{title:"获取到多个文件，请选择要处理的文件：",type:"info",closable:!1}),V("ul",{class:"file_ocr-list"},[(I(!0),R(N,null,K(b(A)(d.file),(_,M)=>{var z;return I(),R("li",{key:M,onClick:Be=>n.value=_},[V("img",{src:b(xe)(_)},null,8,["src"]),E(ke,{effect:"dark",content:_.name,placement:"top",class:"file-name"},null,8,["content"]),((z=n.value)==null?void 0:z.url)===_.url?(I(),S(O,{key:0,class:"file-selected"},{default:x(()=>[E(b(we))]),_:1})):$("",!0)],8,["onClick"])}),128))])]),_:1},8,["modelValue"]),E(P,{modelValue:g.value,"onUpdate:modelValue":s[3]||(s[3]=_=>g.value=_),title:"选择文件",width:"500","close-on-click-modal":!1},{footer:x(()=>[V("div",{class:"dialog-footer"},[E(C,{type:"primary",onClick:w},{default:x(()=>[D("确定")]),_:1})])]),default:x(()=>[E(F,{title:"以下关键字提取到多个内容，请选择需要的内容：",type:"info",closable:!1}),E(te,{data:f.value.filter(_=>_.item.values.length>1),stripe:"",border:"","empty-text":"没有可设置的关键字字段",style:{width:"100%","margin-top":"10px"}},{default:x(()=>[E(j,{prop:"date",label:"关键字",width:"180"},{default:x(({row:_})=>[D(pe(_.item.entity),1)]),_:1}),E(j,{prop:"name",label:"回填到表单字段"},{default:x(({row:_})=>[E(ee,{modelValue:_.value,"onUpdate:modelValue":M=>_.value=M,"value-key":"text",placeholder:"请选择"},{default:x(()=>[(I(!0),R(N,null,K(_.item.values,M=>(I(),S(Z,{key:M.text,label:M.text,value:M},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"])],64)}}});const Ue=L(Re,[["__scopeId","data-v-a444a4be"]]),Pe=B({__name:"Render",props:{field:{},index:{}},setup(r){const m=r,{isShow:u,fileFieldVal:y,fileFieldInfo:c,emptyErrorMsg:a,render:v}=le({field:m.field}),n=he(()=>{const l=new Map;return m.field.options.keyFields.forEach(t=>{var w,d;const o=(w=v.matchField(t.fieldId))==null?void 0:w.field;if(!o)return;const g=o.options.label,f=l.get(g)??{fieldIds:[],synoyms:[],fieldType:t.fieldType},p=((d=m.field.options.fills.find(s=>s.fieldId===t.fieldId))==null?void 0:d.fillFieldId)??o.fieldId;f.fieldIds.push(p),f.synoyms=[...new Set([...f.synoyms??[],...A(t.alias)])],l.set(g,f)}),l}),e=l=>{var o,g,f;const t=n.value.get(l.entity);if(!t)return null;if(t.fieldType===h.member||t.fieldType===h.memberSingle){let p=[];try{p=JSON.parse((o=l.values[0])==null?void 0:o.transformText)}catch{p=[]}return Array.isArray(p)||(p=[]),p.length?p.map(w=>String(w.userId)):null}if(t.fieldType===h.department||t.fieldType===h.departmentSingle){let p=[];try{p=JSON.parse((g=l.values[0])==null?void 0:g.transformText)}catch{p=[]}return Array.isArray(p)||(p=[]),p.length?p.map(w=>String(w.id)):null}return((f=l.values[0])==null?void 0:f.text)??""},i=l=>{const t={};(l??[]).forEach(o=>{var w;const g=o.entity,f=e(o);if(!f)return;const p=(w=n.value.get(g))==null?void 0:w.fieldIds;p==null||p.forEach(d=>{var F;const s=(F=v.matchField(d))==null?void 0:F.parentField;(s==null?void 0:s.type)===h.subform&&(t[s.fieldId]={...t[s.fieldId]??{},[d]:f}),v.setFieldVal(d,f,m.index,{strictFormat:!0})})});for(const[o,g]of Object.entries(t))v.setFieldVal(o,[g],void 0,{sonUseDefault:!0,strictFormat:!0})};return(l,t)=>b(u)?(I(),S(ae,{key:0,field:l.field},{default:x(()=>{var o;return[E(Ue,{"model-value":l.field.options.btnConfig,file:b(y),errorMsg:{emptyErrorMsg:b(a),formatPrefixErrorMsg:`${(o=b(c))==null?void 0:o.field.options.label}：`},keyInfoMap:n.value,promptCode:l.field.options.promptCode,onSendExtractData:i},null,8,["model-value","file","errorMsg","keyInfoMap","promptCode"])]}),_:1},8,["field"])):$("",!0)}});export{Pe as default};
