# git 分支

## 提交的基本原理

在进行提交操作时，Git 会保存一个提交对象（commit object）。

**提交对象会包含一个指向暂存内容快照的指针，该提交对象还包含了作者的姓名和邮箱、提交时输入的信息以及指向它的父对象的指针**。

首次提交产生的提交对象没有父对象，普通提交操作产生的提交对象有一个父对象， 而由多个分支合并产生的提交对象有多个父对象。

当使用 git commit 进行提交操作时，Git 会先计算每一个子目录的校验和， 然后在 Git 仓库中这些校验和保存为树对象。随后，Git 便会创建一个提交对象， 它除了包含上面提到的那些信息外，还包含指向这个树对象（项目根目录）的指针。 如此一来，Git 就可以在需要的时候重现此次保存的快照。

![image-20250805102734301](/img/343.png)

做些修改后再次提交，那么这次产生的提交对象会包含一个指向上次提交对象（父对象）的指针。

![image-20250805103032835](/img/344.png)

## 分支的基本原理

Git 分支的核心原理可以用一句话概括：**分支本质是一个指向特定提交（Commit）的轻量指针，所有分支操作本质上都是在移动这些指针**。

### 分支的底层存储：指针文件

在 Git 仓库的 `.git/refs/heads/` 目录下，每个分支对应一个**文本文件**，文件内容只有一行 —— 指向该分支最新提交的哈希值（SHA-1 字符串）。

* 分支的创建**不复制工作区文件**，仅创建一个 tiny 指针文件，因此速度极快。
* 分支的 “内容” 由它指向的提交及历史提交链决定。

### HEAD 指针：当前分支的 “游标”

Git 中有一个特殊指针 `HEAD`（存储在 `.git/HEAD` 文件中），用于标记**当前所在的分支**。

文件内容:

```text
ref: refs/heads/testing # 当前分支文件的路径
```

### 分支的操作：指针的分离

* **创建分支时，Git 会生成一个新指针，指向当前提交**；后续提交只会移动当前分支的指针，其他分支指针不变。
* **切换分支时, Git 将 HEAD 指针指向切换的分支，并且将工作目录回复到该分支最后一次提交时的样子。 如果 Git 不能干净利落地完成这个任务，它将禁止切换分支**。
* **删除分支本质是删除 `.git/refs/heads/dev` 这个指针文件，不会删除任何提交（提交会被 Git 垃圾回收机制清理，若无人引用）**

![image-20250805104734817](/img/345.png)

## 查看分支

1. **查看本地分支**: 列出所有本地分支，当前所在分支前会有 `*` 标记

   ```bash
   git branch
   
   # 输出
     dev
   * main
     feature/login
   ```

2. **查看本地和远程分支**: 加上 `-a` 参数（all），同时显示本地分支和远程分支（远程分支以 `origin/` 开头）

   ```bash
   git branch -a
   ```

3. **查看分支关联关系**: 加上 `-vv` 参数，显示本地分支与远程分支的关联关系（跟踪信息）和最新提交信息

   ```bash
   git branch -vv
   
   # 输出
     dev        a1b2c3d [origin/dev] 修复首页bug
   * main       e4f5g6h [origin/main: ahead 1] 添加用户协议
     feature/login 7h8i9j0 开发登录功能
   ```

   输出：

   * `[origin/dev]` 表示 `dev` 分支关联远程 `origin/dev` 分支
   * `ahead 1` 表示本地分支比远程分支多 1 个提交

4. **查看远程分支**: 加上 `-r` 参数（remote），仅显示远程分支

## 创建分支

1. 基于当前分支创建新分支

   ```bash
   # 创建新分支（不会自动切换过去）
   git branch <新分支名>
   
   
   # 创建并切换到新分支（等价于上面两步）
   git checkout -b <新分支名>
   # 或 Git 2.23+ 更直观的命令
   git switch -c <新分支名>
   
   
   # 切换到新创建的分支
   git checkout <新分支名>
   # 或 Git 2.23+ 推荐的命令
   git switch <新分支名>
   ```

2. 基于指定分支创建新分支

   ```bash
   # 基于 <源分支名> 创建并切换到 <新分支名>
   git checkout -b <新分支名> <源分支名>
   # 或 Git 2.23+
   git switch -c <新分支名> <源分支名>
   ```

3. 基于指定提交创建新分支：从历史提交（而非最新提交）创建分支，常用于 “抢救” 误删的代码或测试历史版本。

   ```bash
   # 基于某个提交哈希创建分支（<commit-hash> 是提交的 SHA-1 值）
   git checkout -b <新分支名> <commit-hash>
   # 或 Git 2.23+
   git switch -c <新分支名> <commit-hash>
   ```

## 切换分支

1. 基本切换命令

   ```bash
   # 切换到已存在的分支
   git checkout <分支名>
   
   # 或 Git 2.23+ 更直观的命令
   git switch <分支名>
   ```

2. 切换到远程分支（并自动创建本地跟踪分支）

   ```bash
   # 传统方式
   git checkout <分支名>
   
   # Git 2.23+ 推荐
   git switch <分支名>
   ```

3. 切换到特定提交（分离 HEAD 状态）: 还可以直接切换到某个历史提交（用于查看旧版本），此时处于 **“分离 HEAD 状态”**（HEAD 直接指向提交而非分支）

   ```bash
   # 切换到某个提交（哈希值通过 git log 查看）
   git checkout <提交哈希>
   
   # Git 2.23+ 推荐
   git switch --detach <提交哈希>
   
   
   # 修改后若要保存，需创建新分支：
   git switch -c <新分支名>  # 基于当前提交创建新分支
   ```

### 切换分支的前提条件

切换分支前，需确保工作区和暂存区的修改已妥善处理，否则可能导致修改丢失或冲突：

* **未提交的修改与目标分支兼容**: Git 会自动携带未提交的修改切换到新分支（如果文件在两个分支中没有冲突）
* **存在未提交的修改且可能冲突**: Git 会阻止切换

此时的解决方法:

- 提交修改：`git add . && git commit -m "暂存修改"`
- 暂存修改（临时保存）：`git stash`（切换回来后用 `git stash pop` 恢复）
- 放弃修改（危险！）：`git reset --hard && git clean -fd`

## 删除分支

删除分支是**不可逆操作**，确保分支不再需要后再执行

1. **删除本地分支**: 删除本地分支前，需确保当前不在该分支上

   * **安全删除（仅删除已合并的分支）**: 若分支未合并到主分支，会提示错误（防止误删未合并的代码）

     ```bash
     git branch -d <本地分支名>
     ```

   * **强制删除（无论是否合并，谨慎使用）**: 用于删除未合并的分支（可能丢失修改，确认后再执行）

     ```bash
     git branch -D <本地分支名>  # 大写的 D
     ```

2. **删除远程分支**: 删除远程仓库中的分支

   ```bash
   git push <远程仓库名> --delete <远程分支名>
   
   # 等价写法（冒号前为空表示删除）
   git push origin :<远程分支名>
   ```

   删除远程分支后，本地可能仍缓存着已删除的远程分支信息，需清理：

   ```bash
   # 清理本地缓存的已删除远程分支引用
   git fetch --prune
   # 或简写
   git fetch -p
   ```

## 重命名分支

1. **重命名本地分支**

   ```bash
   git branch -m <旧分支名> <新分支名>
   
   # 如果当前就在需要重命名的分支上，可简化为：
   git branch -m <新分支名>
   ```

2. **重命名远程分支**: 如果该分支已推送到远程仓库，需要删除旧的远程分支，并将新命名的本地分支推送到远程

   ```bash
   # 1. 删除远程旧分支
   git push origin --delete <旧分支名>
   
   # 2. 将新命名的本地分支推送到远程，并建立关联
   git push -u origin <新分支名>
   ```

3. **更新其他用户的本地引用（团队协作时）**: 若分支已被团队其他成员使用，重命名后需通知他们执行以下命令更新本地引用

   ```bash
   # 获取所有远程更新
   git fetch origin --prune
   
   # 删除本地旧分支
   git branch -d <旧分支名>
   
   # 切换到新分支
   git checkout --track <新分支名>
   ```

   

## 合并分支

