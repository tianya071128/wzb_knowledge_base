# 引用规范(Refspec)

**引用规范（refspec）** 是定义**本地仓库与远程仓库之间引用（分支、标签、提交等）映射关系**的规则，主要用于 `git fetch`（拉取）和 `git push`（推送）操作，实现对 “哪些引用需要同步”“如何在本地 / 远程命名这些引用” 的精细化控制。

## 引用规范的本质与作用

Git 中的 “引用（ref）” 是指向提交的指针（如分支 `main`、标签 `v1.0`、远程跟踪分支 `origin/dev` 等），**本质是 `.git/refs/` 目录下的小文件，内容为提交哈希值**。

引用规范的核心作用是：

- 明确**哪些远程引用**（如远程分支、标签）需要拉取到本地，或哪些本地引用需要推送到远程；
- 定义这些引用在本地 / 远程的**命名映射关系**（如远程 `dev` 分支映射到本地 `origin/dev` 跟踪分支）；
- 控制是否允许**非快进式更新**（如强制推送 / 拉取）。

## 基本语法

```text
+<src>:<dst>
```

- **`+`**：可选前缀，表示 “允许非快进式更新”（即使源引用的历史与目标引用冲突，也强制覆盖）；

- **`<src>`**：“源引用”，即需要被同步的引用（`git fetch` 中是远程引用，`git push` 中是本地引用）

- **`<dst>`**：“目标引用”，即同步后在本地 / 远程生成的引用（`git fetch` 中是本地引用，`git push` 中是远程引用）

- **若省略目标引用`<dst>`（如 `<src>:`）**:

  - `git fetch` 仅拉取数据到本地缓存，不创建本地引用；

  - `git push` 推送到同名的远程引用

    ```bash
    # 推送到同名的远程分支
    git push origin main:
    # 等价于
    git push origin main:main
    
    # 推送到同名的远程标签
    git push origin v1.0:
    # 等价于
    git push origin v1.0:v1.0
    ```

- **若省略源引用`<src>`（如 `:<dst>`）**:

  - `git fetch` **无效操作（通常会产生错误）**

  - `git push` **删除远程引用**

    ```base
    # 删除远程分支
    git push origin :main
    git push origin :refs/heads/feature-branch
    
    # 删除远程标签
    git push origin :v1.0
    git push origin :refs/tags/old-tag
    ```

## 引用的路径规则

Git 中所有引用都有固定的存储路径（位于 `.git/refs/` 目录下），不同类型的引用路径不同，这是引用规范的基础。

| <div style="width: 120px">引用类型</div>               | 本地路径（本地仓库）                                         | 远程路径（远程仓库）                         | 简化写法（日常使用）                     |
| ---------------------- | ------------------------------------------------------------ | -------------------------------------------- | ---------------------------------------- |
| 本地分支               | `refs/heads/<分支名>`（如 `refs/heads/main`）                | -                                            | `<分支名>`（如 `main`）                  |
| 远程跟踪分支           | `refs/remotes/<远程标识>/<分支名>`（如 `refs/remotes/origin/dev`） | -                                            | `<远程标识>/<分支名>`（如 `origin/dev`） |
| 标签（tag）            | `refs/tags/<标签名>`（如 `refs/tags/v1.0`）                  | `refs/tags/<标签名>`（如 `refs/tags/v1.0`）  | `<标签名>`（如 `v1.0`）                  |
| 远程分支（远程仓库中） | -                                                            | `refs/heads/<分支名>`（如 `refs/heads/dev`） | `<分支名>`（如 `dev`）                   |

## `git fetch` 中的引用规范（拉取远程 → 本地）

`git fetch` 中，`<src>` 是远程引用（远程分支 / 标签），`<dst>` 是本地引用（本地跟踪分支 / 标签），用于定义 “**拉取远程哪些引用，映射到本地什么名称**”。

```bash
# 拉取远程分支到本地跟踪分支 - 完整路径写法（严格遵循路径规则）
git fetch origin refs/heads/main:refs/remotes/origin/main

# 拉取远程分支到本地跟踪分支 - 简化写法（Git 自动补全路径）
git fetch origin main:origin/main

# 自定义本地跟踪分支名称
git fetch origin refs/heads/dev:refs/remotes/origin/develop

# 默认行为 - 拉取所有远程分支
git fetch origin refs/heads/*:refs/remotes/origin/*
```

## `git push` 中的引用规范（推送本地 → 远程）

`git push` 中，`<src>` 是本地引用（本地分支 / 标签），`<dst>` 是远程引用（远程分支 / 标签），用于定义 “**推送本地哪些引用，在远程创建什么名称**”。

```bash
# 推送本地分支到远程分支
git push origin refs/heads/main:refs/heads/main # 完成路径
git push origin main:main # 简化写法（最常用）
git push origin main # 本地与远程分支名相同时

# 推送本地分支到远程的另一个分支
git push origin local-dev:dev  # 本地 local-dev → 远程 dev

# 删除远程引用（分支 / 标签）
git push origin :refs/heads/old-feature  # 完整路径
git push origin :old-feature # 简化
```

## 关键符号：`+`（允许非快进式更新）

在引用规范前加 `+` 表示 “强制更新”，即使源引用的历史与目标引用冲突（非快进式更新），也允许覆盖。

* **`git fetch` 中使用 +**: 强制拉取远程被改写的分支（如远程执行过 `git push --force`），覆盖本地跟踪分支

  ```bash
  # 强制将本地 origin/main 更新为远程 main（即使远程历史被改写）
  git fetch origin +refs/heads/main:refs/remotes/origin/main
  # 简化：
  git fetch origin +main:origin/main
  ```

* **`git push` 中使用 `+`（即 `--force` 的底层实现）**: 强制推送本地分支，覆盖远程分支（谨慎使用，可能丢失远程提交）

  ```bash
  # 强制推送本地 main 到远程 main（等价于 git push origin main --force）
  git push origin +main:main
  ```

## 配置文件中的引用规范

### `git fetch` 的相关配置

Git 会在 `.git/config` 中存储远程仓库的默认引用规范，决定 `git fetch` 的默认行为。例如，克隆仓库后，`origin` 远程的配置通常为：

```ini
[remote "origin"]
    url = git@github.com:yourname/repo.git
    fetch = +refs/heads/*:refs/remotes/origin/*
```

`fetch = +refs/heads/*:refs/remotes/origin/*`：定义了 `git fetch origin` 的默认引用规范：

- `refs/heads/*`：匹配远程所有分支；
- `refs/remotes/origin/*`：映射到本地 `origin/*` 跟踪分支；
- `+`：允许远程分支被改写时，强制更新本地跟踪分支（但 `git fetch` 默认不会自动合并，仅更新跟踪分支

### `git push`  的相关配置

在 `git push` 中，当省略引用规范（即不明确指定 `<src>:<dst>`）时，Git 的行为由**当前分支的跟踪配置**和 **`push.default` 配置项**共同决定。核心逻辑是 “自动推断需要推送的本地分支和对应的远程分支”。

* **当前分支的跟踪配置**: Git 会优先通过当前分支的跟踪配置（`branch.<分支名>.remote` 和 `branch.<分支名>.merge`）推断默认推送目标。这些配置通常在分支创建时自动生成（如 `git checkout -b dev origin/dev` 会自动关联 `origin/dev`），也可手动通过 `git branch --set-upstream-to=origin/dev` 设置。

  - `branch.<分支名>.remote`：当前分支对应的远程仓库（如 `origin`）；
  - `branch.<分支名>.merge`：当前分支对应的远程分支（如 `refs/heads/dev`，即远程 `dev` 分支）。

* **关键配置：`push.default`（决定默认推送策略）**: 当分支跟踪关系不明确时，`push.default` 配置项决定了省略引用规范时的推送行为。

  | `push.default` 取值      | 行为描述（省略引用规范时）                                   |
  | ------------------------ | ------------------------------------------------------------ |
  | `simple`（默认）         | 仅推送当前分支到其**跟踪的远程分支**（要求本地分支名与远程分支名相同），最安全的策略。 |
  | `upstream`               | 推送当前分支到其**跟踪的远程分支**（允许本地与远程分支名不同，如本地 `dev` 跟踪远程 `develop`）。 |
  | `current`                | 推送当前分支到远程中**同名分支**（无论是否跟踪，直接按名称匹配）。 |
  | `matching`（旧版本默认） | 推送所有**本地与远程同名的分支**（可能推送无关分支，不推荐）。 |

* 若当前分支既无跟踪关系，且 `push.default` 配置也无法推断推送目标（如 `simple` 模式下无同名跟踪分支），Git 会拒绝推送并提示配置跟踪关系，例如：

  ```text
  fatal: The current branch test has no upstream branch.
  To push the current branch and set the remote as upstream, use
  
      git push --set-upstream origin test
  
  To have this happen automatically for branches without a tracking
  upstream, see 'push.autoSetupRemote' in 'git help config'.
  ```

## 通配符 `*` 

`*` 是引用规范中唯一的通配符，用于匹配多个引用，规则是 “一一对应”（左半部分的 `*` 与右半部分的 `*` 按位置匹配）。

```text
# 带前缀的分支
+refs/heads/feature-*:refs/remotes/origin/feature-*
```





