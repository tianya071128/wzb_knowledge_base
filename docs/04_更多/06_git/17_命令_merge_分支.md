# git merge

## 作用

用于**合并分支**的核心命令，将一个或多个分支的修改整合到当前分支中

## 概述

```bash
# 合并分支
git merge [-n] [--stat] [--compact-summary] [--no-commit] [--squash] [--[no-]edit]
	[--no-verify] [-s <strategy>] [-X <strategy-option>] [-S[<keyid>]]
	[--[no-]allow-unrelated-histories]
	[--[no-]rerere-autoupdate] [-m <msg>] [-F <file>]
	[--into-name <branch>] [<commit>…​]
# 处理合并过程中的中断场景
git merge (--continue | --abort | --quit)
```

## 合并分支

```bash
git merge [-n] [--stat] [--compact-summary] [--no-commit] [--squash] [--[no-]edit]
	[--no-verify] [-s <strategy>] [-X <strategy-option>] [-S[<keyid>]]
	[--[no-]allow-unrelated-histories]
	[--[no-]rerere-autoupdate] [-m <msg>] [-F <file>]
	[--into-name <branch>] [<commit>…​]
```

- 合并指定分支的所有提交到当前分支，使当前分支包含目标分支的所有修改。
- **在合并外部的修改之前，应该把自己的工作做好，并在本地提交，这样在有冲突的时候就不会被打乱了**。
- 如果出现无法自动解决的冲突，或者在启动合并时提供了 `--no-commit` 选项，合并就会停止。这时可以运行 `git` `merge` `--abort` 或 `git` `merge` `--continue` 。
  - `git` `merge` `--abort` 会中止合并过程，并尝试重建合并前的状态。**然而，如果合并开始时有未提交的修改（尤其是合并开始后这些修改被进一步修改），`git` `merge` `--abort` 在某些情况下将无法重建原始的（合并前的）修改**。
  - `git` `merge` `--continue` 当合并过程中出现冲突（或需要补充信息）导致合并中断时，用于**继续完成合并流程**。
- `git merge <commit>`: **将从该提交与当前分支的最近共同祖先（common ancestor）到该提交之间的所有更改合并到当前分支**。换句话说，它合并的是一系列提交（即从共同祖先到指定提交之间的所有提交），而不仅仅是单个提交
  - **与合并分支的区别**：`git merge <分支名>` 会合并该分支的**所有提交**（从共同祖先到最新提交），而 `git merge <commit>` 合并从共同祖先到指定提交之间的所有提交。
  - **与 `git cherry-pick` 的区别**:
    -  `git merge <commit>` 合并范围是从共同祖先到指定提交之间的所有提交，并且会创建合并提交（保留与目标提交的关联）
    - 而 `git cherry-pick <commit>` 会创建一个新的 “复制提交”（与原提交无关联，历史更线性），只合并指定提交
- Git 的合并是基于**提交历史关系**的，不是基于单个提交的孤立操作。

```bash
# 合并 feature 分支到当前分支
git merge feature
```

### 合并的两种类型

[快进合并和三方合并](./branch.html#合并的两种类型)

* 快进合并默认情况下不产生新的合并提交，此种情况可通过 `--no-ff` 来指定创建一个合并提交

### 合并冲突

[合并冲突](./branch.html#合并冲突)

### 解决合并冲突

有两件方式解决冲突：

- **决定不进行合并**。 可以用`git merge --abort`来做这份工作。恢复到之前的状态
- **解决冲突**。 Git会在工作树上标记冲突。 将文件编辑成功，然后 `git` `add` 它们到索引中。 使用 `git` `commit` 或 `git` `merge` `--continue` 解决。后一个命令在调用 `git` `commit` 之前会检查是否有一个（中断的）合并正在进行。

## 处理合并过程中的中断场景

```bash
git merge (--continue | --abort | --quit)
```

`git merge` 的 `--continue`、`--abort`、`--quit` 三个参数均用于**处理合并过程中的中断场景**（尤其是合并冲突时），但作用和适用场景不同：

- 解决冲突(或需要补充信息)后继续合并 → `--continue`
- 彻底放弃合并，回到初始状态 → `--abort`
- 暂时停止合并，保留修改 → `--quit`

| 参数         | 核心行为                       | 工作区 / 暂存区处理            | 适用场景                   |
| ------------ | ------------------------------ | ------------------------------ | -------------------------- |
| `--continue` | 继续完成合并，创建合并提交     | 保留已解决的修改，完成合并     | 解决冲突后继续合并         |
| `--abort`    | 完全放弃合并，恢复到合并前状态 | 丢弃所有合并相关修改，彻底回滚 | 冲突无法解决或合并错误     |
| `--quit`     | 退出合并流程，但保留当前修改   | 保留所有修改，仅清除合并状态   | 暂时中断合并，之后可能重启 |

## 选项

### `<commit>...`: 合并从共同祖先到指定提交之间的所有更改

* **作用**：**合并的是这个提交及其之前的所有提交**，直到该提交与当前分支的共同祖先。
* **合并范围**： 
  * Git 会找到**当前分支**和**指定提交**的**最近共同祖先**
  * 然后合并从**共同祖先**到**指定提交**之间的**所有更改**

### 合并模式

#### `--ff,--no-ff,-ff-only`: 控制“快速合并（Fast-forward）” 行为

- **作用**：

  - `--ff`（默认行为，可省略）: 允许快速合并（若条件满足则执行 FF，否则执行三方合并并创建合并提交）
  - `--no-ff`（禁用快速合并，强制创建合并提交）: 即使满足快速合并条件，**也强制创建一个新的合并提交**，明确记录 “分支合并” 的操作。
  - `--ff-only`（仅允许快速合并，否则报错）: 只接受快速合并，**若不满足 FF 条件（分支有分叉）则直接报错，不执行任何合并操作**

#### `--commit,--no-commit`: 是否自动创建合并提交

- **作用**：
  - `--commit`：自动创建合并提交（默认行为），合并操作完成后（包括自动合并成功或手动解决冲突后），**自动创建合并提交**，无需手动执行 `git commit`。
  - `--no-commit`：执行合并但不自动创建提交。在创建合并提交前停止，以便让用户有机会在提交前检查和进一步调整合并结果。
  - **注意，**快进更新并不产生合并提交，因此没有办法用 `--no-commit` 停止这些合并。 因此，如果你想确保你的分支不被合并命令改变或更新，请一起使用 `--no-ff` 和 `--no-commit` 选项。

### 冲突与中断处理选项

#### `--abort`: 取消合并

* **作用**：中止当前的冲突解决过程，并尝试重建合并前的状态。如果合并开始时有未提交的工作区变化，`git` `merge` `--abort` 在某些情况下将无法重现这些变化。**因此，建议在运行 `git` `merge` 之前，一定要提交或储存修改**。

#### `--continue`: 继续合并

* **作用**：解决合并冲突后，继续完成合并流程（需先 `git add` 标记冲突文件为已解决）

#### `--quit`: 退出合并

* **作用**：退出合并流程，但保留工作区和暂存区的修改（仅清除 “合并中” 状态标记）