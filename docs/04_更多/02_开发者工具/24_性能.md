# 性能(Performance)

## 启动录制

可以录制**运行时**或**加载性能**。

### 录制运行时性能

分析网页运行时（而非加载）的性能时，

![img](/img/281.jpg)

### 录制加载性能

分析网页加载（而非运行时）的性能，点击 开始分析并加载页面 图标按钮。首先，开发者工具会前往 about:blank，以清除所有剩余的屏幕截图和跟踪记录。然后，开发者工具会在页面重新加载时记录性能指标，然后在加载完成后几秒钟自动停止记录。

![img](/img/282.jpg)

## 设置

可通过以下配置项启用相应功能：

- 录制时截取屏幕截图：可在录制过程中截取每一帧的屏幕截图

- 录制时强制进行垃圾回收：强制进行垃圾回收。

- 停用 JavaScript 示例：停用主要轨道的 `JavaScript` 函数的详细调用堆栈

- 录制时限制网络带宽：录制时限制网络流量

- 录制时限制 CPU 占用率：限制 CPU 占用率。限制是相对于计算机功能而言的。例如，2 倍减速选项会使 CPU 的运行速度比平时慢 2 倍。开发者工具无法真正模拟移动设备的 CPU，因为移动设备的架构与桌面设备和笔记本电脑的架构截然不同。

- 启用高级绘制插桩：查看详细的绘制插桩

- 模拟硬件并发：使用不同数量的处理器核心来测试应用性能

![img](/img/293.jpg)

## 分析性能记录

当启用了录制后, 性能面板会提供大量数据，用于分析刚刚发生的情况的性能。

### 搜索活动

在性能面板底部打开搜索框：`Ctrl+F`

### 时间轴概览

在性能面板的操作栏下方以及记录的顶部，可以看到包含 CPU 和 NET 图表的时间轴概览部分。

![img](/img/283.jpg)

#### 选择录制的一部分

可通过以下方式选中部分：

- 点击并按住，然后在时间轴概览中向左或向右拖动：
  <ShowVideo src='/video/05.mp4' />

- 使用键盘快捷操作：
  1. 聚焦于主轨道或其任何相邻轨道。
  2. 使用 W、A、S、D 键分别可以放大、向左、缩小和向右移动。

#### 创建面包屑导航以及在缩放级别之间进行切换

通过时间轴概览，您可以连续创建多个嵌套面包屑导航，增加缩放级别，然后跳转到所选级别。

<ShowVideo src='/video/06.mp4' />

### 主要 - 主线程活动

通过 `Main` 查看发生在页面主线程上的活动。

- 系统会使用红色三角形突出显示耗时较长的任务，并将时长超过 50 毫秒的部分用红色三角形表示：最初的 50 毫秒不是，后面超出 50 毫秒的会标注

- 主轨道可以显示箭头，将以下发起者及其导致的事件联系起来：

  - 样式或布局失效 -> 重新计算样式或布局
  - 请求动画帧 -> 已触发动画帧
  - 请求空闲回调 -> 触发空闲回调
  - 安装计时器 -> 计时器已触发
  - 创建 WebSocket -> 发送... 和接收 WebSocket 握手或销毁 WebSocket

![img](/img/284.jpg)

#### 查看绘制性能分析器

查看有关绘制事件的高级信息：

1. 启用 高级绘制插桩 功能。
2. 在主要轨道中选择一个 Paint 事件。

#### 根 activity

在自下而上标签页、调用树标签页和事件日志标签页中提到的 **根 activity** 概念。

根 activity 是指会导致浏览器执行某些工作的 activity。例如，当您点击某个网页时，浏览器会触发一个 Event activity 作为根 activity。然后，该 Event 可能会导致处理程序执行。

在主要轨道的火焰图中，根活动位于图表顶部。在调用树标签页和事件日志标签页中，根 activity 是顶层项。

#### 自下而上标签页

自下而上标签页查看哪些根活动导致的工作量最大：

- 自用时间：表示直接在该活动的所有发生实例中花费的汇总时间。
- 总时间：显示的是该活动或其任一子活动花费的总时长。
- 活动：**注意：这里嵌套不是表示调用堆栈，更是调用堆栈反着来的，表示在哪里调用的这个函数**。

![img](/img/296.jpg)

#### 调用树标签页

调用树标签页查看直接占用最多时间的活动：

- 自用时间：表示直接在相应活动中花费的时间。
- 总时间：表示该 activity 或其任何子级上花费的时间。
- 活动：列的顶层是根 activity。嵌套表示调用堆栈。

点击图标 ![image](/img/294.png){style="display: inline-block"}, 在表格右侧显示另一个表格(执行用时最长的堆栈)。

![img](/img/295.jpg)

#### 事件日志标签页

调用树标签页按活动在记录期间发生的顺序查看活动：

- 开始时间：表示该活动开始的点（相对于记录开始时间）。
- 自身耗时：表示直接在该活动中花费的时间。
- 总时间：表示直接在该活动或其任何子活动中花费的时间。
- 活动：活动名称

![img](/img/297.jpg)

### 内存 - 查看内存指标

![img](/img/291.jpg)

### 时间 - 显示时间

::: tip
如果没有录制到如下标记的话，就不会存在 时间轨道。此时可[录制加载性能](/devtools/performance.html#录制加载性能)。
:::

在时间轨道中，查看如下重要标记：

- [首次绘制 (FP)](https://developer.mozilla.org/docs/Glossary/First_paint)
- [First Contentful Paint (FCP)](https://web.dev/articles/fcp?hl=zh-cn)
- [Largest Contentful Paint (LCP)](https://web.dev/articles/lcp?hl=zh-cn)
- [DOMContentLoaded 事件 (DCL)](https://developer.mozilla.org/docs/Web/API/Window/DOMContentLoaded_event)
- [加载事件 (L)](https://developer.mozilla.org/docs/Web/API/Window/load_event)
- 您的自定义 [`performance.mark()`](https://developer.mozilla.org/docs/Web/API/Performance/mark) 调用。下面显示了 813.44 毫秒处的单个带有提示的标记，标记为**开始运行 JavaScript**。
- 您的自定义 [`performance.measure()`](https://developer.mozilla.org/docs/Web/API/Performance/measure) 调用。下面展示了一个黄色 span，标记为**慢速互动**。

![img](/img/285.jpg)

### 帧 -- 查看 FPS

::: tip
如需查看屏幕截图，请启用 屏幕截图 后录制
:::

帧轨道可以显示四种类型的帧：

1. **空闲帧（白色）**。无任何更改。
2. **框架（绿色）**：按预期及时呈现。
3. **部分呈现的帧（黄色，较宽的虚线模式）**。Chrome 已尽最大努力及时至少呈现一些外观更新。例如，如果渲染器进程的主线程（画布动画）的工作延迟，但合成器线程（滚动）及时。
4. **丢失的帧（红色，且有密集的实线图案）**：Chrome 无法在合理的时间内呈现帧。

![img](/img/289.jpg)

#### 查看图层信息

查看每一帧的图层信息：

![img](/img/292.jpg)

### 网络 - 查看网络请求瀑布流

![img](/img/290.jpg)

### 互动 - 查看用户互动

查看用户互动，跟踪潜在的响应速度问题，如需查看互动，需要录制到用户互动的操作才会显示

![img](/img/286.jpg)

对于时长超过 200 毫秒的互动，互动 轨道还会在 概要 标签页和悬停提示中显示 Interaction to Next Paint (INP) 警告

![img](/img/287.jpg)

### GPU - 查看 GPU 活动

![img](/img/288.jpg)

## 参考

- [性能指标](https://web.dev/articles/vitals?hl=zh-cn)
