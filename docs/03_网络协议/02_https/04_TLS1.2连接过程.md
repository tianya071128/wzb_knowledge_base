# TLS1.2连接过程

**握手是TLS协议中最精密复杂的部分**。在这个过程中，通信双方协商连接参数，并且完成身份验证。根据使用的功能的不同，整个过程通常需要交换6~10条消息。

在使用中经常可以观察到以下三种流程：

1. 完整的握手，对服务器进行身份验证；
2. 恢复之前的会话采用的简短握手；
3.  对客户端和服务器都进行身份验证的握手。

**如下讨论的最常见的TLS握手流程，就是一种在不需要身份验证的客户端与需要身份验证的服务器之间的握手**

## 简要流程 

下面的这张图简要地描述了 TLS 的握手过程，其中每一个“框”都是一个记录，多个记录组合成一个 TCP 包发送。所以，最多经过两次消息往返（4 个消息）就可以完成握手，然后就可以在安全的通信环境里发送 HTTP 报文，实现 HTTPS 协议。

![img](/img/17.png)

## 第一个消息: ClientHello

**在一次新的握手流程中，ClientHello消息总是第一条消息**。这条消息将客户端的功能和首选项传送给服务器。客户端会在新建连接后，希望重新协商或者响应服务器发起的重新协商请求（由HelloRequest消息指示）时，发送这条消息。

![image-20250619110746888](/img/324.png)

### Version: 版本

```tex
Version: TLS 1.2(0x0303)
```

* **含义**：TLS 1.3+ 引入后，为兼容旧解析逻辑保留 `legacy_version` 字段（这里填 `TLS 1.2` 是常见做法），**实际协商的 TLS 版本由 `supported_versions` 扩展决定**（下面扩展部分会体现）。

### Random: 随机数

```tex
Random: 1cbf803321fd2623408dfe70d825c9dbdab33fd273f6a884a44e59347bcbd421
    GMT Unix Time: Apr 14, 1985 15:37:23.000000000 中国标准时间
    Random Bytes: 21fd2623408dfe70d825c9dbdab33fd273f6a884a44e59347bcbd421

```

* **组成**，固定32字节
  * **Unix 时间戳**：4 字节，也可能随机的时间
  * **随机数**: 28 字节
* **用途**：
  - 生成会话密钥的关键输入（与 ServerRandom、Pre-Master Secret 结合）。
  - 防止重放攻击（每条消息的随机数唯一）。

### Session ID: 会话 ID

```tex
Session ID Length: 32
Session ID: f655c8005ba1a4f66cd8790cac2c3847344ff3fad2629d64761f471fac84a35f
```

- **格式**：0-32 字节可变长度字段。
- **工作机制**：
  - 首次握手时，服务器生成 `session_id` 并在 `ServerHello` 中返回。
  - 客户端再次连接时携带该 ID，双方可跳过部分握手步骤，直接恢复会话。
- **TLS 1.3 变更**：
  TLS 1.3 更倾向使用 `session_ticket` 替代 `session_id`，提供更好的前向安全性。

### Cipher Suites: 密码套件

```tex
Cipher Suites Length: 34
Cipher Suites (17 suites)
    Cipher Suite: Reserved (GREASE) (0x1a1a)
    Cipher Suite: TLS_AES_128_GCM_SHA256 (0x1301)
    ...
```

- **格式**：一个套件为 2 字节 ID 列表（如 `0x1301` 表示 `TLS_AES_128_GCM_SHA256`）。

- **用途**: 由客户端支持的所有密码套件组成的列表，该列表是按优先

  级顺序排列。服务器从中选择一个加密套件。

### Compressio: 压缩

```tex
Compression Methods Length: 1
Compression Methods (1 method)
    Compression Method: null (0)
```

* **格式**: 按优先级排列的压缩算法标识符列表，每个算法占 **1 字节**
* **用途**: 客户端支持的压缩算法。**因 CRIME 等攻击漏洞，现代 TLS 实现已禁用压缩**，默认仅支持 `null`（不压缩，十六进制的`00`）

## 版本协商

待续