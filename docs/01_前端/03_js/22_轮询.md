---
title: 网络请求 - 轮询
date: 2021-10-21 15:00:00
permalink: /js/polling
categories:
  - 前端
  - JS
tags:
  - null
---

# 轮询

轮询也是使用 HTTP 协议进行的，是客户端持续的向服务端发起请求。

## 短轮询(常规轮询)

从服务器获取最新消息最简单的方式就是定期轮询。浏览器定期向服务器发送请求(例如，每 10 秒一次)，时间线如图：

![image-20211222163920010](/img/69.png)

这样虽然可行，但是存在如下缺点：

* 两个请求之间的时间不好把握，太长的话消息更新不及时，太短的话耗费性能
* 即使没有消息，服务器也会每隔一段时间被请求轰炸一次

## 长轮询

长轮询针对短轮询的缺点改进了一番，把短轮询颠倒了一下，流程如下：

1. 请求发送到服务器。
2. 服务器在有消息之前不会关闭连接。
3. 当消息出现时 —— 服务器将对其请求作出响应。
4. 浏览器立即发出一个新的请求。

![image-20211222164523032](/img/70.png)

##  HTTP 流

在 `js 高程第三版-P588` 中描述的一种实现持久连接的方法

流不同于上述轮询方式，因为在页面的生命周期内只使用一个 HTTP 连接。也就是在浏览器发起一个 HTTP 请求，服务器一直挂起，周期性的向客户端发送消息。

而客户端通过在 `readystatechange` 事件中响应数据，就可以对 responseText 进行分割以取得最新数据。

虽然这种方式一定程度上可行，但管理起来很是麻烦并且容易出错，并且在**IE 浏览器存在兼容性**。SSE（Server-Sent Events，IE 也不支持）是对这一方式的封装。

## SSE

Server Sent Events 它能保持与服务器的持久连接，并从中接收事件(数据)。其原理就是保持一个 HTTP 的连接服务器按照特定格式发送消息。

### 与 WebSocket 的区别

| `WebSocket`                      | `EventSource`            |
| -------------------------------- | ------------------------ |
| 双向：客户端和服务端都能交换消息 | 单向：仅服务端能发送消息 |
| 二进制和文本数据                 | 仅文本数据               |
| WebSocket 协议                   | 常规 HTTP 协议           |

SSE 的优点在于简单，基于 HTTP 协议，并且支持自动重新连接。缺点在于只能传递文本数据，并且**IE 不兼容**。

### 具体实现

SSE 在项目中很少需要，具体实现参考：[JS教程-Server Sent Events](https://zh.javascript.info/server-sent-events)

## 参考

* [JS 教程 - 轮询](https://zh.javascript.info/long-polling)
* JS 高程第三版 P588

